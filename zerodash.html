<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MongoQuery ‚Äî AI Data Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;overflow:hidden;font-family:'Outfit',sans-serif}

/* ============================================================ AUTH ============================================================ */
#auth-layer{position:fixed;inset:0;z-index:200;background:linear-gradient(135deg,#0a0e1a 0%,#0d1526 50%,#0a1020 100%);display:flex;align-items:center;justify-content:center;overflow:hidden}
#stars-canvas{position:absolute;inset:0;pointer-events:none}
.orb{position:absolute;border-radius:50%;pointer-events:none;animation:orb-float linear infinite}
.orb1{width:400px;height:400px;background:radial-gradient(circle,rgba(0,212,255,.12) 0%,transparent 70%);top:-120px;left:-100px;animation-duration:22s}
.orb2{width:280px;height:280px;background:radial-gradient(circle,rgba(99,102,241,.15) 0%,transparent 70%);bottom:5%;right:8%;animation-duration:17s;animation-delay:-9s}
.orb3{width:180px;height:180px;background:radial-gradient(circle,rgba(16,185,129,.12) 0%,transparent 70%);top:45%;left:8%;animation-duration:20s;animation-delay:-5s}
@keyframes orb-float{0%{transform:translateY(0) rotate(0deg)}50%{transform:translateY(-45px) rotate(180deg)}100%{transform:translateY(0) rotate(360deg)}}
.particle{position:absolute;border-radius:50%;pointer-events:none;animation:particle-rise linear infinite}
@keyframes particle-rise{0%{transform:translateY(0) translateX(0) scale(1);opacity:.9}40%{transform:translateY(-40vh) translateX(18px) scale(1.2);opacity:.5}100%{transform:translateY(-105vh) translateX(-8px) scale(.2);opacity:0}}
.ring{position:absolute;border-radius:50%;border:1px solid rgba(0,212,255,.08);pointer-events:none;animation:ring-pulse ease-in-out infinite}
@keyframes ring-pulse{0%,100%{transform:scale(1);opacity:.6}50%{transform:scale(1.12);opacity:.15}}

.auth-card{position:relative;z-index:10;width:420px;background:rgba(255,255,255,.05);backdrop-filter:blur(28px);border:1px solid rgba(255,255,255,.1);border-radius:24px;padding:42px 38px;box-shadow:0 30px 80px rgba(0,0,0,.5),inset 0 1px 0 rgba(255,255,255,.12);animation:card-in .65s cubic-bezier(.34,1.56,.64,1) both}
@keyframes card-in{from{opacity:0;transform:translateY(32px) scale(.94)}to{opacity:1;transform:none}}
.auth-logo{display:flex;align-items:center;gap:11px;margin-bottom:30px;justify-content:center}
.auth-logo-icon{width:38px;height:38px;border-radius:10px;background:linear-gradient(135deg,#00d4ff,#0096b7);display:flex;align-items:center;justify-content:center;font-size:20px;box-shadow:0 4px 16px rgba(0,212,255,.35)}
.auth-logo-txt{font-family:'Outfit',sans-serif;font-size:24px;font-weight:800;color:#fff;letter-spacing:-.5px}
.auth-logo-txt span{color:#00d4ff}
.auth-title{font-size:27px;font-weight:800;color:#fff;text-align:center;margin-bottom:6px;letter-spacing:-.5px}
.auth-sub{font-size:13px;color:rgba(255,255,255,.45);text-align:center;margin-bottom:28px}
.auth-field{position:relative;margin-bottom:13px}
.auth-field .icon{position:absolute;left:15px;top:50%;transform:translateY(-50%);color:rgba(255,255,255,.3);font-size:15px;pointer-events:none}
.auth-input{width:100%;background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.1);border-radius:12px;padding:13px 14px 13px 44px;font-family:'Outfit',sans-serif;font-size:14px;color:#fff;outline:none;transition:.25s}
.auth-input::placeholder{color:rgba(255,255,255,.28)}
.auth-input:focus{border-color:rgba(0,212,255,.6);background:rgba(255,255,255,.1);box-shadow:0 0 0 3px rgba(0,212,255,.12)}
.auth-btn{width:100%;padding:14px;border-radius:12px;border:none;cursor:pointer;font-family:'Outfit',sans-serif;font-size:16px;font-weight:700;background:linear-gradient(135deg,#00d4ff,#0096b7);color:#fff;box-shadow:0 6px 22px rgba(0,212,255,.35);transition:.25s;margin-top:4px;letter-spacing:.2px}
.auth-btn:hover{transform:translateY(-2px);box-shadow:0 10px 30px rgba(0,212,255,.5)}
.auth-btn:active{transform:none}
.auth-divider{text-align:center;font-size:12px;color:rgba(255,255,255,.28);margin:16px 0}
.auth-switch{text-align:center;font-size:13px;color:rgba(255,255,255,.4)}
.auth-switch a{color:#00d4ff;text-decoration:none;font-weight:600;cursor:pointer}
.auth-switch a:hover{color:#66e3ff}
.auth-error{background:rgba(239,68,68,.12);border:1px solid rgba(239,68,68,.3);border-radius:9px;padding:9px 13px;font-size:12px;color:#f87171;margin-bottom:13px;display:none}
.auth-error.show{display:block}
#login-page,#signup-page{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;transition:opacity .4s,transform .4s}
.page-hidden{opacity:0;transform:translateX(-40px);pointer-events:none}
.page-enter{animation:page-in .4s ease both}
@keyframes page-in{from{opacity:0;transform:translateX(40px)}to{opacity:1;transform:none}}

/* ============================================================ DASHBOARD ============================================================ */
#dashboard-layer{position:fixed;inset:0;z-index:100;background:#080d14;color:#e2e8f0;display:flex;flex-direction:column;opacity:0;pointer-events:none;transition:opacity .65s ease}
#dashboard-layer.active{opacity:1;pointer-events:all}

:root{
  --bg:#080d14;--bg2:#0e1420;--bg3:#141b28;--bg4:#1a2235;--bg5:#1e2840;
  --border:#1f2d42;--border2:#263549;
  --cyan:#00d4ff;--cdim:rgba(0,212,255,.15);--cglow:rgba(0,212,255,.08);
  --green:#10b981;--gdim:rgba(16,185,129,.15);
  --blue:#6366f1;--yellow:#f59e0b;--orange:#f97316;--red:#ef4444;--purple:#a78bfa;
  --text:#e2e8f0;--muted:#64748b;--dim:#334155;
}

/* TOPBAR */
.topbar{height:54px;background:var(--bg2);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;padding:0 20px;flex-shrink:0;gap:12px}
.logo{display:flex;align-items:center;gap:10px;text-decoration:none}
.logo-icon{width:32px;height:32px;background:linear-gradient(135deg,#00d4ff,#0096b7);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:16px;box-shadow:0 2px 10px rgba(0,212,255,.3);flex-shrink:0}
.logo-txt{font-size:18px;font-weight:800;color:#fff;letter-spacing:-.5px}
.logo-txt span{color:#00d4ff}
.tb-breadcrumb{font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--muted);background:var(--bg3);padding:5px 13px;border-radius:6px;border:1px solid var(--border);white-space:nowrap}
.tb-breadcrumb .hl{color:var(--cyan)}
.tb-right{display:flex;align-items:center;gap:9px;flex-shrink:0}
.vbadge{background:var(--bg4);border:1px solid var(--border);color:var(--muted);padding:3px 9px;border-radius:5px;font-size:11px;font-family:'JetBrains Mono',monospace}
.conn{display:flex;align-items:center;gap:5px;font-size:12px;color:var(--green);font-weight:500}
.dot{width:7px;height:7px;border-radius:50%;background:var(--green);box-shadow:0 0 6px var(--green);animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
.user-badge{display:flex;align-items:center;gap:8px;background:var(--bg3);border:1px solid var(--border);border-radius:9px;padding:5px 12px;cursor:pointer;transition:.2s;font-size:12px;font-weight:500}
.user-badge:hover{border-color:var(--cyan);color:var(--cyan)}
.user-avatar{width:24px;height:24px;border-radius:50%;background:linear-gradient(135deg,#00d4ff,#6366f1);display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:800;color:#fff;flex-shrink:0}

/* LAYOUT */
.layout{display:flex;flex:1;overflow:hidden}

/* SIDEBAR */
.sidebar{width:220px;background:var(--bg2);border-right:1px solid var(--border);overflow-y:auto;flex-shrink:0;display:flex;flex-direction:column}
.sb-sec{padding:14px 10px 6px}
.sb-lbl{font-size:10px;font-weight:700;letter-spacing:.1em;color:var(--dim);text-transform:uppercase;margin-bottom:8px;padding:0 8px}
.ni{display:flex;align-items:center;gap:9px;padding:8px 10px;border-radius:8px;cursor:pointer;font-size:13px;color:var(--muted);transition:.15s;margin-bottom:2px;font-weight:500}
.ni:hover{background:var(--bg3);color:var(--text)}
.ni.act{background:var(--cglow);color:var(--cyan);border:1px solid rgba(0,212,255,.15)}
.ni-badge{margin-left:auto;background:var(--cyan);color:#000;font-size:10px;font-weight:800;padding:1px 7px;border-radius:10px}
.ci{display:flex;align-items:center;gap:8px;padding:7px 10px;border-radius:7px;cursor:pointer;font-size:12px;color:var(--muted);transition:.15s;font-weight:500}
.ci:hover,.ci.act{background:var(--bg3);color:var(--text)}
.cc{margin-left:auto;font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--dim)}
.op-grid{display:grid;grid-template-columns:1fr 1fr;gap:5px;padding:0 10px 10px}
.ob{padding:7px 4px;background:var(--bg3);border:1px solid var(--border);border-radius:6px;font-size:11px;font-family:'JetBrains Mono',monospace;color:var(--muted);cursor:pointer;transition:.15s;text-align:center;font-weight:500}
.ob:hover{border-color:var(--cyan);color:var(--cyan)}
.ob.act{background:var(--cglow);border-color:var(--cyan);color:var(--cyan)}

/* DATA SOURCE INDICATOR in sidebar */
.ds-indicator{margin:10px;background:var(--bg3);border:1px solid var(--border);border-radius:10px;padding:12px 14px;flex-shrink:0}
.ds-ttl{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:var(--dim);margin-bottom:8px}
.ds-item{display:flex;align-items:center;gap:8px;padding:5px 0;font-size:12px;color:var(--muted)}
.ds-item.active-src{color:var(--cyan)}
.ds-icon{width:22px;height:22px;border-radius:5px;display:flex;align-items:center;justify-content:center;font-size:12px;background:var(--bg4);flex-shrink:0}
.ds-icon.csv{background:rgba(16,185,129,.15);color:var(--green)}
.ds-icon.pdf{background:rgba(239,68,68,.15);color:#f87171}
.ds-icon.json{background:rgba(245,158,11,.15);color:var(--yellow)}
.ds-icon.xls{background:rgba(16,185,129,.15);color:var(--green)}
.ds-icon.txt{background:rgba(100,116,139,.15);color:var(--muted)}
.ds-icon.db{background:rgba(0,212,255,.15);color:var(--cyan)}
.ds-name{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-size:11px}
.ds-remove{color:var(--dim);cursor:pointer;font-size:14px;transition:.15s;flex-shrink:0}
.ds-remove:hover{color:#ef4444}

/* MAIN */
.main{flex:1;overflow-y:auto;display:flex;flex-direction:column}

/* ---- UPLOAD ZONE ---- */
.upload-section{padding:16px 20px;border-bottom:1px solid var(--border);background:var(--bg2);flex-shrink:0}
.upload-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
.upload-title{font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:var(--muted);display:flex;align-items:center;gap:7px}
.upload-title .dot2{width:6px;height:6px;border-radius:50%;background:var(--cyan);box-shadow:0 0 5px var(--cyan)}
.drop-zone{border:1.5px dashed var(--border2);border-radius:12px;padding:20px 24px;text-align:center;cursor:pointer;transition:.25s;background:var(--bg3);position:relative;overflow:hidden}
.drop-zone:hover,.drop-zone.drag-over{border-color:var(--cyan);background:var(--cglow);box-shadow:0 0 20px rgba(0,212,255,.06)}
.dz-icon{font-size:28px;margin-bottom:8px;display:block}
.dz-title{font-size:14px;font-weight:600;color:var(--text);margin-bottom:4px}
.dz-sub{font-size:12px;color:var(--muted)}
.dz-sub span{color:var(--cyan);font-weight:600;cursor:pointer}
.dz-types{display:flex;gap:6px;justify-content:center;margin-top:10px;flex-wrap:wrap}
.dz-type{background:var(--bg4);border:1px solid var(--border);color:var(--muted);padding:2px 9px;border-radius:4px;font-size:10px;font-family:'JetBrains Mono',monospace;font-weight:600}
.dz-type.csv{border-color:rgba(16,185,129,.3);color:var(--green)}
.dz-type.pdf{border-color:rgba(239,68,68,.3);color:#f87171}
.dz-type.json{border-color:rgba(245,158,11,.3);color:var(--yellow)}
.dz-type.xlsx{border-color:rgba(16,185,129,.3);color:var(--green)}
.dz-type.txt{border-color:rgba(100,116,139,.3);color:var(--muted)}
#file-input{display:none}

/* uploaded files strip */
.uploaded-strip{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
.ufile{display:flex;align-items:center;gap:7px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:6px 12px;font-size:12px;animation:pop-in .3s cubic-bezier(.34,1.56,.64,1) both;transition:.2s;cursor:default}
.ufile.active-file{border-color:var(--cyan);background:var(--cglow)}
@keyframes pop-in{from{opacity:0;transform:scale(.8)}to{opacity:1;transform:scale(1)}}
.ufile-icon{font-size:14px}
.ufile-name{color:var(--text);font-weight:500;max-width:140px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.ufile-size{color:var(--muted);font-size:10px}
.ufile-del{color:var(--dim);cursor:pointer;font-size:15px;transition:.15s;margin-left:2px}
.ufile-del:hover{color:#ef4444}
.ufile-active-badge{background:var(--cyan);color:#000;font-size:9px;font-weight:800;padding:1px 6px;border-radius:4px}

/* parse progress */
.parse-bar{height:2px;background:var(--border);border-radius:2px;overflow:hidden;margin-top:8px;display:none}
.parse-bar.show{display:block}
.parse-fill{height:100%;background:linear-gradient(90deg,#00d4ff,#6366f1);border-radius:2px;width:0%;transition:width .3s ease}

/* QUERY */
.qs{padding:16px 20px;border-bottom:1px solid var(--border);background:var(--bg2);flex-shrink:0}
.qmeta{font-size:10px;color:var(--dim);letter-spacing:.07em;text-transform:uppercase;margin-bottom:10px;display:flex;align-items:center;gap:8px;font-weight:700}
.ctag{background:var(--cglow);border:1px solid rgba(0,212,255,.2);color:var(--cyan);padding:2px 10px;border-radius:5px;font-size:11px;display:flex;align-items:center;gap:5px;font-weight:600;text-transform:none;letter-spacing:0}
.qrow{display:flex;gap:9px;align-items:center}
.qi{flex:1;background:var(--bg3);border:1px solid var(--border);border-radius:10px;padding:12px 16px;font-family:'Outfit',sans-serif;font-size:15px;color:var(--text);outline:none;transition:.25s;font-weight:400}
.qi:focus{border-color:rgba(0,212,255,.5);box-shadow:0 0 0 3px rgba(0,212,255,.07)}
.qi::placeholder{color:var(--dim)}
.bcl{background:transparent;border:1px solid var(--border);color:var(--muted);padding:11px 15px;border-radius:9px;font-size:13px;cursor:pointer;transition:.15s;font-family:'Outfit',sans-serif}
.bcl:hover{color:var(--text);border-color:var(--muted)}
.brun{background:linear-gradient(135deg,#00d4ff,#0096b7);color:#000;border:none;padding:12px 22px;border-radius:9px;font-size:13px;font-weight:700;cursor:pointer;display:flex;align-items:center;gap:7px;transition:.2s;white-space:nowrap;font-family:'Outfit',sans-serif}
.brun:hover{box-shadow:0 6px 20px rgba(0,212,255,.35);transform:translateY(-1px)}
.brun.ld{background:var(--bg4);color:var(--muted);cursor:not-allowed;transform:none;box-shadow:none}
.chips{display:flex;gap:7px;margin-top:10px;flex-wrap:wrap}
.chip{background:var(--bg3);border:1px solid var(--border);color:var(--muted);padding:5px 12px;border-radius:20px;font-size:12px;cursor:pointer;transition:.15s;font-weight:500}
.chip:hover{border-color:var(--cyan);color:var(--cyan)}

/* PIPELINE */
.pipe{display:none;align-items:center;background:var(--bg2);border-bottom:1px solid var(--border);padding:0 20px;overflow-x:auto;flex-shrink:0}
.pipe.on{display:flex}
.ps{display:flex;flex-direction:column;align-items:center;padding:11px 16px;gap:4px;flex-shrink:0}
.pi{font-size:16px}.pi.done{color:var(--cyan)}.pi.pend{color:var(--dim)}.pi.run{color:var(--yellow);animation:spin .6s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.pl{font-size:10px;font-weight:700;color:var(--dim);text-transform:uppercase;letter-spacing:.05em}
.pl.done{color:var(--cyan)}
.psep{color:var(--dim);font-size:16px;flex-shrink:0}

/* CODE */
.cb{background:var(--bg2);border-bottom:1px solid var(--border);padding:0 20px 16px;display:none;flex-shrink:0}
.cb.on{display:block}
.ch{display:flex;align-items:center;gap:10px;margin-bottom:10px;padding-top:14px}
.cop{background:var(--cglow);border:1px solid rgba(0,212,255,.25);color:var(--cyan);font-family:'JetBrains Mono',monospace;font-size:11px;font-weight:700;padding:3px 11px;border-radius:5px}
.csum{font-family:'JetBrains Mono',monospace;font-size:12px;color:var(--muted)}
.cbody{background:#050a10;border:1px solid var(--border);border-left:3px solid var(--cyan);border-radius:10px;padding:16px 18px;font-family:'JetBrains Mono',monospace;font-size:13px;line-height:1.75;position:relative}
.ccopy{position:absolute;top:10px;right:10px;background:var(--bg3);border:1px solid var(--border);color:var(--muted);padding:4px 10px;border-radius:6px;font-size:11px;cursor:pointer;transition:.15s;font-family:'Outfit',sans-serif}
.ccopy:hover{color:var(--text)}
.kw{color:var(--blue)}.fn{color:var(--cyan)}.str{color:var(--orange)}.op{color:var(--yellow)}.cm{color:var(--dim)}

/* STATS */
.sc{display:none;grid-template-columns:repeat(4,1fr);gap:12px;padding:16px 20px;background:var(--bg2);border-bottom:1px solid var(--border);flex-shrink:0}
.sc.on{display:grid}
.scard{background:var(--bg3);border:1px solid var(--border);border-radius:12px;padding:16px 18px;transition:.2s}
.scard:hover{border-color:var(--border2)}
.slbl{font-size:10px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--muted);margin-bottom:8px}
.sval{font-size:28px;font-weight:800;font-family:'JetBrains Mono',monospace;line-height:1}
.sval.c{color:var(--cyan)}.sval.g{color:var(--green)}.sval.y{color:var(--yellow)}.sval.p{color:var(--purple)}
.ssub{font-size:11px;color:var(--dim);margin-top:5px}

/* EXPLANATION */
.expl{padding:20px;border-bottom:1px solid var(--border);display:none;flex-shrink:0}
.expl.on{display:block}
.expl-hdr{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:var(--dim);margin-bottom:14px;display:flex;align-items:center;gap:7px}
.eg{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.ehero{background:linear-gradient(135deg,rgba(0,212,255,.07),rgba(0,212,255,.02));border:1px solid rgba(0,212,255,.15);border-radius:12px;padding:18px 20px;grid-column:1/-1}
.ehero-lbl{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:var(--cyan);margin-bottom:6px}
.ehero-q{font-size:17px;font-weight:700;color:var(--text);margin-bottom:5px}
.ehero-sub{font-size:13px;color:var(--muted)}
.esteps{background:var(--bg2);border:1px solid var(--border);border-radius:11px;padding:16px 18px}
.esteps-ttl{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:var(--dim);margin-bottom:12px}
.estep{display:flex;gap:12px;margin-bottom:13px;position:relative}
.estep:not(:last-child)::before{content:'';position:absolute;left:11px;top:26px;bottom:-5px;width:1px;background:var(--border)}
.enum{width:24px;height:24px;border-radius:50%;background:var(--cglow);border:1px solid rgba(0,212,255,.3);display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:800;color:var(--cyan);flex-shrink:0}
.ebody{flex:1}.ehead{font-size:13px;font-weight:600;color:var(--text);margin-bottom:3px}.edesc{font-size:12px;color:var(--muted);line-height:1.6}
.efound{background:var(--bg2);border:1px solid var(--border);border-radius:11px;padding:16px 18px}
.efound-ttl{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:var(--dim);margin-bottom:10px}
.efound-txt{font-size:13px;color:var(--text);line-height:1.75}
.hl{color:var(--cyan);font-weight:700}
.ins{display:flex;align-items:flex-start;gap:8px;padding:9px 12px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;margin-bottom:7px;font-size:12px;color:var(--text);line-height:1.55}
.enext{grid-column:1/-1}
.enext-ttl{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:var(--dim);margin-bottom:10px}
.ngrid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
.nbtn{background:var(--bg2);border:1px solid var(--border);border-radius:9px;padding:10px 12px;font-size:12px;color:var(--muted);cursor:pointer;text-align:left;transition:.15s;font-family:'Outfit',sans-serif;display:flex;align-items:center;gap:7px;font-weight:500}
.nbtn:hover{border-color:var(--cyan);color:var(--cyan);background:var(--cglow)}

/* RESULTS */
.rs{padding:20px;display:none;flex-shrink:0}
.rs.on{display:block}
.rh{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
.rt{font-size:14px;font-weight:700;display:flex;align-items:center;gap:10px}
.rcnt{background:var(--bg3);border:1px solid var(--border);color:var(--muted);font-size:11px;padding:2px 10px;border-radius:10px;font-family:'JetBrains Mono',monospace}
.expbtn{font-size:12px;color:var(--muted);cursor:pointer;transition:.15s;background:var(--bg3);border:1px solid var(--border);padding:6px 13px;border-radius:7px;font-weight:500}
.expbtn:hover{color:var(--text);border-color:var(--cyan)}
.tabs{display:flex;border-bottom:1px solid var(--border);margin-bottom:16px}
.tab{padding:9px 16px;font-size:13px;cursor:pointer;color:var(--muted);border-bottom:2px solid transparent;transition:.15s;display:flex;align-items:center;gap:5px;margin-bottom:-1px;font-weight:500}
.tab:hover{color:var(--text)}
.tab.act{color:var(--cyan);border-bottom-color:var(--cyan)}
.dtable{width:100%;border-collapse:collapse;font-size:12px}
.dtable th{text-align:left;padding:9px 12px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.07em;color:var(--dim);border-bottom:1px solid var(--border);background:var(--bg3)}
.dtable td{padding:10px 12px;border-bottom:1px solid rgba(31,45,66,.5);font-family:'JetBrains Mono',monospace;font-size:12px}
.dtable tr:hover td{background:var(--bg3)}
.tdept{display:inline-block;background:rgba(163,139,250,.1);border:1px solid rgba(163,139,250,.2);color:var(--purple);padding:1px 9px;border-radius:5px;font-size:11px}
.tact{color:var(--green);font-size:11px}
.tina{color:#f87171;font-size:11px}
.tfile{display:inline-block;font-size:10px;padding:2px 7px;border-radius:4px;font-weight:700}
.tfile.csv{background:rgba(16,185,129,.12);color:var(--green);border:1px solid rgba(16,185,129,.25)}
.tfile.pdf{background:rgba(239,68,68,.12);color:#f87171;border:1px solid rgba(239,68,68,.25)}
.tfile.json{background:rgba(245,158,11,.12);color:var(--yellow);border:1px solid rgba(245,158,11,.25)}
.tfile.xlsx{background:rgba(16,185,129,.12);color:var(--green);border:1px solid rgba(16,185,129,.25)}

/* CHARTS */
.cg{display:none;grid-template-columns:1fr 1fr;gap:14px;padding:0 20px 20px;flex-shrink:0}
.cg.on{display:grid}
.ccard{background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:18px}
.cttl{font-size:13px;font-weight:700;margin-bottom:4px}
.csub{font-size:11px;color:var(--muted);margin-bottom:14px}
canvas{display:block;max-width:100%}

/* LOG */
.lp{margin:0 20px 20px;background:var(--bg2);border:1px solid var(--border);border-radius:12px;flex-shrink:0;display:none}
.lp.on{display:block}
.lh{display:flex;align-items:center;justify-content:space-between;padding:10px 16px;border-bottom:1px solid var(--border)}
.lt2{font-size:13px;font-weight:700}
.live{display:flex;align-items:center;gap:5px;font-size:11px;color:var(--green);font-weight:600}
.lb{padding:10px 16px;font-family:'JetBrains Mono',monospace;font-size:11px;display:flex;flex-direction:column;gap:3px;max-height:120px;overflow-y:auto}
.ll{display:flex;gap:10px}
.ltm{color:var(--dim)}.li{color:var(--blue)}.ls{color:var(--cyan)}.lw{color:var(--yellow)}.lm{color:var(--muted)}

/* EMPTY STATE */
.empty-state{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:60px 20px;text-align:center;color:var(--muted);gap:12px}
.empty-icon{font-size:48px;opacity:.4}
.empty-title{font-size:16px;font-weight:600;color:var(--text)}
.empty-sub{font-size:13px;max-width:340px;line-height:1.6}

/* Toast */
.toast{position:fixed;top:16px;right:16px;z-index:999;background:var(--bg3);border:1px solid var(--cyan);color:#fff;padding:12px 18px;border-radius:11px;font-size:13px;display:flex;align-items:center;gap:10px;box-shadow:0 10px 30px rgba(0,0,0,.5);animation:toast-in .4s ease,toast-out .4s ease 2.8s both;pointer-events:none;font-weight:500}
@keyframes toast-in{from{opacity:0;transform:translateX(30px)}to{opacity:1;transform:none}}
@keyframes toast-out{from{opacity:1;transform:none}to{opacity:0;transform:translateX(30px)}}

/* Scrollbar */
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:var(--bg2)}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:3px}
::-webkit-scrollbar-thumb:hover{background:var(--dim)}
</style>
</head>
<body>

<!-- ===== AUTH ===== -->
<div id="auth-layer">
  <canvas id="stars-canvas"></canvas>
  <div class="orb orb1"></div><div class="orb orb2"></div><div class="orb orb3"></div>

  <div id="login-page">
    <div class="auth-card">
      <div class="auth-logo"><div class="auth-logo-icon">üçÉ</div><div class="auth-logo-txt">Mongo<span>Query</span></div></div>
      <div class="auth-title">Welcome back</div>
      <div class="auth-sub">Sign in to your data dashboard</div>
      <div class="auth-error" id="login-err"></div>
      <div class="auth-field"><span class="icon">üë§</span><input class="auth-input" id="l-user" type="text" placeholder="Username or Email"></div>
      <div class="auth-field"><span class="icon">üîí</span><input class="auth-input" id="l-pass" type="password" placeholder="Password"></div>
      <button class="auth-btn" onclick="doLogin()">Sign In</button>
      <div class="auth-divider">‚Äî or ‚Äî</div>
      <div class="auth-switch">New here? <a onclick="showSignup()">Create an account</a></div>
    </div>
  </div>

  <div id="signup-page" class="page-hidden">
    <div class="auth-card">
      <div class="auth-logo"><div class="auth-logo-icon">üçÉ</div><div class="auth-logo-txt">Mongo<span>Query</span></div></div>
      <div class="auth-title">Create Account</div>
      <div class="auth-sub">Start querying your data with AI</div>
      <div class="auth-error" id="signup-err"></div>
      <div class="auth-field"><span class="icon">üë§</span><input class="auth-input" id="s-user" type="text" placeholder="Username"></div>
      <div class="auth-field"><span class="icon">‚úâÔ∏è</span><input class="auth-input" id="s-email" type="email" placeholder="Email"></div>
      <div class="auth-field"><span class="icon">üîí</span><input class="auth-input" id="s-pass" type="password" placeholder="Password"></div>
      <div class="auth-field"><span class="icon">üîí</span><input class="auth-input" id="s-pass2" type="password" placeholder="Confirm Password"></div>
      <button class="auth-btn" onclick="doSignup()">Create Account</button>
      <div class="auth-divider">‚Äî or ‚Äî</div>
      <div class="auth-switch">Already have an account? <a onclick="showLogin()">Sign in</a></div>
    </div>
  </div>
</div>

<!-- ===== DASHBOARD ===== -->
<div id="dashboard-layer">

  <div class="topbar">
    <div class="logo">
      <div class="logo-icon">üçÉ</div>
      <div class="logo-txt">Mongo<span>Query</span></div>
    </div>
    <div class="tb-breadcrumb">db.<span class="hl" id="tb-coll">employees</span> .find(...)</div>
    <div class="tb-right">
      <div class="vbadge">v8.0</div>
      <div class="conn"><div class="dot"></div>CONNECTED</div>
      <div class="user-badge" onclick="doLogout()">
        <div class="user-avatar" id="uav">?</div>
        <span id="uname">user</span>
        <span style="color:var(--dim);font-size:11px">‚Ü©</span>
      </div>
    </div>
  </div>

  <div class="layout">
    <aside class="sidebar">
      <div class="sb-sec">
        <div class="sb-lbl">Navigation</div>
        <div class="ni act">‚ö° Query Generator <span class="ni-badge">5</span></div>
        <div class="ni">üìä Aggregations</div>
        <div class="ni">üìÅ Collections</div>
        <div class="ni">üïê Query History</div>
        <div class="ni">üîç Indexes</div>
        <div class="ni">‚öôÔ∏è Settings</div>
      </div>
      <div class="sb-sec">
        <div class="sb-lbl">Collections</div>
        <div class="ci act">üìÇ employees <span class="cc">1,240</span></div>
        <div class="ci">üìÇ departments <span class="cc">12</span></div>
        <div class="ci">üìÇ projects <span class="cc">348</span></div>
        <div class="ci">üìÇ salaries <span class="cc">4,820</span></div>
      </div>
      <div class="sb-sec"><div class="sb-lbl">Operation</div></div>
      <div class="op-grid">
        <div class="ob act">find()</div><div class="ob">aggregate()</div>
        <div class="ob">insertOne()</div><div class="ob">updateMany()</div>
        <div class="ob">deleteOne()</div><div class="ob">countDocs()</div>
      </div>
      <!-- Data sources loaded -->
      <div class="ds-indicator" id="ds-panel" style="display:none">
        <div class="ds-ttl">Loaded Data Sources</div>
        <div id="ds-list"></div>
      </div>
    </aside>

    <main class="main" id="ms">

      <!-- UPLOAD ZONE -->
      <div class="upload-section">
        <div class="upload-hdr">
          <div class="upload-title"><div class="dot2"></div> Data Sources ‚Äî Upload Your Files</div>
        </div>
        <div class="drop-zone" id="drop-zone" onclick="document.getElementById('file-input').click()" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event)">
          <span class="dz-icon">üìÇ</span>
          <div class="dz-title">Drop files here or <span>browse</span></div>
          <div class="dz-sub">Upload any data file to query it with natural language</div>
          <div class="dz-types">
            <span class="dz-type csv">CSV</span>
            <span class="dz-type pdf">PDF</span>
            <span class="dz-type json">JSON</span>
            <span class="dz-type xlsx">XLSX</span>
            <span class="dz-type txt">TXT</span>
            <span class="dz-type" style="border-color:rgba(99,102,241,.3);color:var(--blue)">XML</span>
            <span class="dz-type" style="border-color:rgba(245,158,11,.3);color:var(--yellow)">YAML</span>
            <span class="dz-type" style="border-color:rgba(0,212,255,.3);color:var(--cyan)">SQL</span>
          </div>
        </div>
        <input type="file" id="file-input" multiple accept=".csv,.pdf,.json,.xlsx,.xls,.txt,.xml,.yaml,.yml,.sql" onchange="handleFileInput(event)">
        <div class="parse-bar" id="parse-bar"><div class="parse-fill" id="parse-fill"></div></div>
        <div class="uploaded-strip" id="uploaded-strip"></div>
      </div>

      <!-- QUERY INPUT -->
      <div class="qs">
        <div class="qmeta">Natural Language ‚Üí MongoDB <div class="ctag">üçÉ <span id="q-src">db.employees</span></div></div>
        <div class="qrow">
          <input class="qi" id="qi" placeholder="Ask in plain English‚Ä¶ e.g. Who earns the most?" value="Hired after 2020">
          <button class="bcl" onclick="clearQ()">Clear</button>
          <button class="brun" id="rb" onclick="runQuery()">‚ö° Generate + Run</button>
        </div>
        <div class="chips" id="chips">
          <div class="chip" onclick="sq('Find all employees in Sales')">Find all in Sales</div>
          <div class="chip" onclick="sq('Top 5 highest paid')">Top 5 highest paid</div>
          <div class="chip" onclick="sq('Count by department')">Count by dept</div>
          <div class="chip" onclick="sq('Hired after 2020')">Hired after 2020</div>
          <div class="chip" onclick="sq('Average salary per dept')">Avg salary per dept</div>
        </div>
      </div>

      <!-- PIPELINE -->
      <div class="pipe" id="pipe">
        <div class="ps"><div class="pi pend" id="p1">‚óã</div><div class="pl" id="l1">Tokenize</div></div>
        <div class="psep">‚Ä∫</div>
        <div class="ps"><div class="pi pend" id="p2">‚óã</div><div class="pl" id="l2">Intent</div></div>
        <div class="psep">‚Ä∫</div>
        <div class="ps"><div class="pi pend" id="p3">‚óã</div><div class="pl" id="l3">Schema Map</div></div>
        <div class="psep">‚Ä∫</div>
        <div class="ps"><div class="pi pend" id="p4">‚óã</div><div class="pl" id="l4">Query Gen</div></div>
        <div class="psep">‚Ä∫</div>
        <div class="ps"><div class="pi pend" id="p5">‚óã</div><div class="pl" id="l5">Optimize</div></div>
        <div class="psep">‚Ä∫</div>
        <div class="ps"><div class="pi pend" id="p6">‚óã</div><div class="pl" id="l6">Execute</div></div>
      </div>

      <!-- CODE -->
      <div class="cb" id="cb">
        <div class="ch">
          <div class="cop" id="cop">find()</div>
          <div class="csum" id="csum"></div>
        </div>
        <div class="cbody">
          <button class="ccopy" onclick="copyCode()">Copy</button>
          <div id="cd"></div>
        </div>
      </div>

      <!-- STATS -->
      <div class="sc" id="sc">
        <div class="scard"><div class="slbl">Documents</div><div class="sval c" id="sd">‚Äî</div><div class="ssub">matched</div></div>
        <div class="scard"><div class="slbl">Confidence</div><div class="sval g" id="sf">‚Äî</div><div class="ssub">model accuracy</div></div>
        <div class="scard"><div class="slbl">Exec Time</div><div class="sval y" id="st">‚Äî</div><div class="ssub">milliseconds</div></div>
        <div class="scard"><div class="slbl">Index Used</div><div class="sval p" id="si">‚Äî</div><div class="ssub">scan type</div></div>
      </div>

      <!-- EXPLANATION -->
      <div class="expl" id="expl">
        <div class="expl-hdr">üí° Plain English Explanation</div>
        <div class="eg" id="eg"></div>
      </div>

      <!-- RESULTS -->
      <div class="rs" id="rs">
        <div class="rh">
          <div class="rt">‚ö° Query Results <span class="rcnt" id="rc"></span></div>
          <div style="display:flex;gap:8px">
            <div class="expbtn" onclick="exportJ()">‚Üì JSON</div>
            <div class="expbtn" onclick="exportCSV()">‚Üì CSV</div>
          </div>
        </div>
        <div class="tabs">
          <div class="tab act" onclick="st2('t',this)">‚äû Table</div>
          <div class="tab" onclick="st2('j',this)">{ } JSON</div>
        </div>
        <div id="tt"><table class="dtable"><thead id="th"></thead><tbody id="tb"></tbody></table></div>
        <div id="tj" style="display:none"><pre id="jp" style="font-family:'JetBrains Mono',monospace;font-size:12px;color:var(--muted);white-space:pre-wrap;background:var(--bg3);padding:16px;border-radius:10px;border:1px solid var(--border)"></pre></div>
      </div>

      <!-- CHARTS -->
      <div class="cg" id="cg">
        <div class="ccard"><div class="cttl">Query Method Distribution</div><div class="csub">Usage across query types this session</div><canvas id="dc" width="360" height="230"></canvas></div>
        <div class="ccard"><div class="cttl">Execution Time History</div><div class="csub">Last 10 queries (ms)</div><canvas id="lc" width="520" height="230"></canvas></div>
      </div>

      <!-- LOG -->
      <div class="lp" id="lp">
        <div class="lh"><div class="lt2">Execution Log</div><div class="live"><div class="dot"></div>LIVE</div></div>
        <div class="lb" id="lb"></div>
      </div>

    </main>
  </div>
</div>

<script>
/* ============================================================ STARS & PARTICLES ============================================================ */
(function(){
  const canvas=document.getElementById('stars-canvas');const ctx=canvas.getContext('2d');
  let W,H,stars=[];
  function resize(){W=canvas.width=window.innerWidth;H=canvas.height=window.innerHeight;makeStars()}
  function makeStars(){stars=[];for(let i=0;i<200;i++)stars.push({x:Math.random()*W,y:Math.random()*H,r:Math.random()*1.6+.2,a:Math.random(),da:.002+Math.random()*.008,dx:(Math.random()-.5)*.12,dy:-(Math.random()*.18+.04)})}
  function draw(){ctx.clearRect(0,0,W,H);stars.forEach(s=>{s.x+=s.dx;s.y+=s.dy;s.a+=s.da;if(s.a>1||s.a<0)s.da*=-1;if(s.y<-5){s.y=H+5;s.x=Math.random()*W}ctx.beginPath();ctx.arc(s.x,s.y,s.r,0,Math.PI*2);ctx.fillStyle=`rgba(255,255,255,${s.a*.8})`;ctx.fill()});requestAnimationFrame(draw)}
  resize();window.addEventListener('resize',resize);draw();
})();
(function(){
  const auth=document.getElementById('auth-layer');
  const cols=['rgba(0,212,255,.7)','rgba(99,102,241,.8)','rgba(16,185,129,.6)','rgba(255,255,255,.5)','rgba(163,139,250,.7)'];
  for(let i=0;i<32;i++){const p=document.createElement('div');p.className='particle';const sz=Math.random()*5+2;p.style.cssText=`width:${sz}px;height:${sz}px;left:${Math.random()*100}%;bottom:${Math.random()*15}%;background:${cols[Math.floor(Math.random()*cols.length)]};animation-duration:${4+Math.random()*9}s;animation-delay:-${Math.random()*12}s;box-shadow:0 0 ${sz*2}px ${cols[Math.floor(Math.random()*cols.length)]}`;auth.appendChild(p)}
  for(let i=0;i<7;i++){const r=document.createElement('div');r.className='ring';const sz=50+Math.random()*180;r.style.cssText=`width:${sz}px;height:${sz}px;left:${Math.random()*100}%;top:${Math.random()*100}%;animation-duration:${3+Math.random()*5}s;animation-delay:-${Math.random()*6}s`;auth.appendChild(r)}
})();

/* ============================================================ AUTH ============================================================ */
const userStore={};
function showSignup(){const l=document.getElementById('login-page'),s=document.getElementById('signup-page');l.classList.add('page-hidden');s.classList.remove('page-hidden');s.classList.add('page-enter');setTimeout(()=>s.classList.remove('page-enter'),400)}
function showLogin(){const l=document.getElementById('login-page'),s=document.getElementById('signup-page');s.classList.add('page-hidden');l.classList.remove('page-hidden');l.classList.add('page-enter');setTimeout(()=>l.classList.remove('page-enter'),400)}
function doLogin(){
  const u=document.getElementById('l-user').value.trim(),p=document.getElementById('l-pass').value;
  const err=document.getElementById('login-err');
  if(!u||!p){err.textContent='Please fill in all fields';err.classList.add('show');return}
  if((userStore[u]&&userStore[u]===p)||(u==='demo'&&p==='demo123')){err.classList.remove('show');enterDashboard(u)}
  else{err.textContent='Invalid username or password';err.classList.add('show');shake('#login-page .auth-card')}
}
function doSignup(){
  const u=document.getElementById('s-user').value.trim(),e=document.getElementById('s-email').value.trim(),p=document.getElementById('s-pass').value,p2=document.getElementById('s-pass2').value;
  const err=document.getElementById('signup-err');
  if(!u||!e||!p||!p2){err.textContent='Please fill in all fields';err.classList.add('show');return}
  if(p!==p2){err.textContent='Passwords do not match';err.classList.add('show');return}
  if(p.length<6){err.textContent='Password must be at least 6 characters';err.classList.add('show');return}
  if(userStore[u]){err.textContent='Username already taken';err.classList.add('show');return}
  userStore[u]=p;err.classList.remove('show');enterDashboard(u);
}
function shake(sel){const el=document.querySelector(sel);el.style.animation='shake .4s ease';setTimeout(()=>el.style.animation='',400)}
function enterDashboard(username){
  document.getElementById('uav').textContent=username[0].toUpperCase();
  document.getElementById('uname').textContent=username;
  const authL=document.getElementById('auth-layer'),dashL=document.getElementById('dashboard-layer');
  authL.style.transition='opacity .7s,transform .7s';authL.style.opacity='0';authL.style.transform='scale(1.04)';
  setTimeout(()=>{authL.style.display='none';dashL.classList.add('active');showToast('üëã Welcome, '+username+'!')},650);
}
function doLogout(){
  const authL=document.getElementById('auth-layer'),dashL=document.getElementById('dashboard-layer');
  dashL.classList.remove('active');authL.style.display='';authL.style.opacity='0';authL.style.transform='scale(1.04)';
  requestAnimationFrame(()=>{authL.style.transition='opacity .6s,transform .6s';authL.style.opacity='1';authL.style.transform='none'});showLogin();
}
document.getElementById('l-pass').addEventListener('keydown',e=>{if(e.key==='Enter')doLogin()});
document.getElementById('s-pass2').addEventListener('keydown',e=>{if(e.key==='Enter')doSignup()});
const ss=document.createElement('style');ss.textContent='@keyframes shake{0%,100%{transform:translateX(0)}20%{transform:translateX(-8px)}40%{transform:translateX(8px)}60%{transform:translateX(-5px)}80%{transform:translateX(5px)}}';document.head.appendChild(ss);

/* ============================================================ FILE UPLOAD ============================================================ */
let uploadedFiles=[];let activeFileIndex=-1;let parsedData=null;

const FILE_ICONS={csv:'üìä',pdf:'üìÑ',json:'üìã',xlsx:'üìà',xls:'üìà',txt:'üìù',xml:'üîñ',yaml:'‚öôÔ∏è',yml:'‚öôÔ∏è',sql:'üóÑÔ∏è',default:'üìÅ'};
const FILE_COLORS={csv:'csv',pdf:'pdf',json:'json',xlsx:'xlsx',xls:'xlsx',txt:'txt'};

function getExt(name){return name.split('.').pop().toLowerCase()}
function fmtSize(bytes){if(bytes<1024)return bytes+'B';if(bytes<1048576)return(bytes/1024).toFixed(1)+'KB';return(bytes/1048576).toFixed(1)+'MB'}

function handleDragOver(e){e.preventDefault();document.getElementById('drop-zone').classList.add('drag-over')}
function handleDragLeave(e){document.getElementById('drop-zone').classList.remove('drag-over')}
function handleDrop(e){
  e.preventDefault();document.getElementById('drop-zone').classList.remove('drag-over');
  processFiles([...e.dataTransfer.files]);
}
function handleFileInput(e){processFiles([...e.target.files]);e.target.value=''}

function processFiles(files){
  files.forEach(file=>{
    const ext=getExt(file.name);
    const entry={id:Date.now()+Math.random(),name:file.name,ext,size:file.size,file,data:null,status:'loading'};
    uploadedFiles.push(entry);
    renderStrip();
    parseFile(entry);
  });
}

function parseFile(entry){
  const bar=document.getElementById('parse-bar'),fill=document.getElementById('parse-fill');
  bar.classList.add('show');let prog=0;
  const iv=setInterval(()=>{prog=Math.min(prog+Math.random()*15,90);fill.style.width=prog+'%'},80);
  const reader=new FileReader();
  reader.onload=function(e){
    clearInterval(iv);fill.style.width='100%';
    setTimeout(()=>{bar.classList.remove('show');fill.style.width='0%'},600);
    const raw=e.target.result;
    try{
      if(entry.ext==='csv'||entry.ext==='tsv'){entry.data=parseCSV(raw);entry.status='ready'}
      else if(entry.ext==='json'){entry.data=parseJSONData(raw);entry.status='ready'}
      else if(entry.ext==='txt'){entry.data=parseTXT(raw);entry.status='ready'}
      else if(entry.ext==='xml'){entry.data=parseXMLData(raw);entry.status='ready'}
      else{entry.data=[{info:'File loaded: '+entry.name,type:entry.ext,size:fmtSize(entry.size),status:'Binary file ‚Äî connect to backend to parse'}];entry.status='ready'}
    }catch(err){entry.data=[{error:'Parse error',message:err.message}];entry.status='error'}
    renderStrip();updateSidebar();
    if(activeFileIndex===-1){setActiveFile(uploadedFiles.indexOf(entry))}
    showToast('‚úÖ '+entry.name+' loaded ('+fmtSize(entry.size)+')');
    log('s','File parsed: '+entry.name+' ‚Üí '+( entry.data?entry.data.length:0)+' records');
  };
  if(['pdf','xlsx','xls'].includes(entry.ext)){
    // Simulate binary parse
    clearInterval(iv);fill.style.width='100%';
    setTimeout(()=>{bar.classList.remove('show');fill.style.width='0%'},600);
    entry.data=generateSimulatedData(entry);entry.status='ready';
    renderStrip();updateSidebar();
    if(activeFileIndex===-1)setActiveFile(uploadedFiles.indexOf(entry));
    showToast('‚úÖ '+entry.name+' loaded');
    log('s','File loaded: '+entry.name);
  }else{
    reader.readAsText(entry.file);
  }
}

function parseCSV(text){
  const lines=text.trim().split('\n').filter(l=>l.trim());
  if(lines.length<2)return[];
  const headers=lines[0].split(',').map(h=>h.trim().replace(/"/g,''));
  return lines.slice(1).map(line=>{
    const vals=line.split(',').map(v=>v.trim().replace(/"/g,''));
    const obj={};headers.forEach((h,i)=>{const n=parseFloat(vals[i]);obj[h]=isNaN(n)?vals[i]||'':n});
    return obj;
  });
}
function parseJSONData(text){
  const d=JSON.parse(text);return Array.isArray(d)?d:[d];
}
function parseTXT(text){
  return text.trim().split('\n').map((line,i)=>({line:i+1,content:line.trim()})).filter(r=>r.content);
}
function parseXMLData(text){
  const parser=new DOMParser();const doc=parser.parseFromString(text,'text/xml');
  const items=[...doc.querySelectorAll('*')].filter(el=>el.children.length===0&&el.textContent.trim());
  return items.slice(0,100).map(el=>({tag:el.tagName,value:el.textContent.trim(),path:getXMLPath(el)}));
}
function getXMLPath(el){const parts=[];let cur=el;while(cur.parentElement){parts.unshift(cur.tagName);cur=cur.parentElement}return parts.join(' > ')}
function generateSimulatedData(entry){
  if(entry.ext==='pdf'){return [{page:1,section:'Introduction',content:'Document content from '+entry.name,chars:450},{page:1,section:'Overview',content:'Summary section extracted from PDF',chars:320},{page:2,section:'Data',content:'Main data content section',chars:680},{page:2,section:'Analysis',content:'Analysis and conclusions',chars:290}]}
  if(entry.ext==='xlsx'||entry.ext==='xls'){
    const depts=['Engineering','Sales','Marketing','HR','Finance'];
    return Array.from({length:20},(_,i)=>({id:'R'+String(i+1).padStart(3,'0'),name:'Record '+(i+1),department:depts[i%depts.length],value:Math.round(Math.random()*100000),date:'2024-'+String(Math.ceil(Math.random()*12)).padStart(2,'0')+'-01',status:Math.random()>.3?'Active':'Inactive'}))
  }
  return [{name:entry.name,size:fmtSize(entry.size),type:entry.ext}];
}

function setActiveFile(idx){
  activeFileIndex=idx;
  if(idx>=0&&idx<uploadedFiles.length){
    const f=uploadedFiles[idx];
    parsedData=f.data;
    document.getElementById('q-src').textContent='db.'+f.name.replace(/\.[^.]+$/,'');
    document.getElementById('tb-coll').textContent=f.name.replace(/\.[^.]+$/,'');
    updateChips(f);
  }else{
    parsedData=null;
    document.getElementById('q-src').textContent='db.employees';
    document.getElementById('tb-coll').textContent='employees';
  }
  renderStrip();
}

function updateChips(f){
  if(!f.data||!f.data.length)return;
  const keys=Object.keys(f.data[0]).slice(0,5);
  const chipsEl=document.getElementById('chips');
  const genChips=keys.map(k=>`<div class="chip" onclick="sq('Show all ${k} values')">${k} values</div>`).join('');
  chipsEl.innerHTML=`<div class="chip" onclick="sq('Show all records')">Show all records</div><div class="chip" onclick="sq('Count total records')">Count records</div>${genChips}<div class="chip" onclick="sq('Find duplicates')">Find duplicates</div>`;
}

function renderStrip(){
  const strip=document.getElementById('uploaded-strip');
  if(!uploadedFiles.length){strip.innerHTML='';return}
  strip.innerHTML=uploadedFiles.map((f,i)=>`
    <div class="ufile${i===activeFileIndex?' active-file':''}" onclick="setActiveFile(${i})">
      <span class="ufile-icon">${FILE_ICONS[f.ext]||FILE_ICONS.default}</span>
      <span class="ufile-name">${f.name}</span>
      <span class="ufile-size">${fmtSize(f.size)}</span>
      ${i===activeFileIndex?'<span class="ufile-active-badge">ACTIVE</span>':''}
      <span class="ufile-del" onclick="removeFile(event,${i})">‚úï</span>
    </div>
  `).join('');
}

function removeFile(e,idx){
  e.stopPropagation();uploadedFiles.splice(idx,1);
  if(activeFileIndex===idx){activeFileIndex=uploadedFiles.length>0?0:-1;setActiveFile(activeFileIndex)}
  else if(activeFileIndex>idx){activeFileIndex--}
  renderStrip();updateSidebar();showToast('üóëÔ∏è File removed');
}

function updateSidebar(){
  const panel=document.getElementById('ds-panel'),list=document.getElementById('ds-list');
  if(!uploadedFiles.length){panel.style.display='none';return}
  panel.style.display='block';
  list.innerHTML=uploadedFiles.map((f,i)=>`
    <div class="ds-item${i===activeFileIndex?' active-src':''}">
      <div class="ds-icon ${FILE_COLORS[f.ext]||''}">${FILE_ICONS[f.ext]||'üìÅ'}</div>
      <div class="ds-name" title="${f.name}">${f.name}</div>
      <div class="ds-remove" onclick="removeFile(event,${i})">‚úï</div>
    </div>
  `).join('');
}

/* ============================================================ QUERY ENGINE ============================================================ */
const EMP=[
  {id:"E091",name:"Noah Adams",dept:"Engineering",salary:88000,hired:"2023-08-14",status:"Active"},
  {id:"E038",name:"Grace Patel",dept:"Sales",salary:62000,hired:"2023-02-14",status:"Active"},
  {id:"E015",name:"David Lee",dept:"Sales",salary:65000,hired:"2022-11-01",status:"Active"},
  {id:"E082",name:"Mia Turner",dept:"Marketing",salary:71000,hired:"2022-10-05",status:"Active"},
  {id:"E074",name:"Liam Chen",dept:"Finance",salary:76000,hired:"2022-04-19",status:"Active"},
  {id:"E067",name:"Olivia Brown",dept:"Operations",salary:69000,hired:"2021-09-28",status:"Active"},
  {id:"E004",name:"Bob Martinez",dept:"Sales",salary:64000,hired:"2021-07-08",status:"Inactive"},
  {id:"E012",name:"Alice Johnson",dept:"Engineering",salary:87000,hired:"2019-03-11",status:"Active"},
  {id:"E033",name:"Carol White",dept:"Engineering",salary:91200,hired:"2018-07-22",status:"Active"},
  {id:"E055",name:"Grace Kim",dept:"Engineering",salary:94500,hired:"2016-01-15",status:"Active"},
  {id:"E021",name:"Frank Brown",dept:"HR",salary:55000,hired:"2017-05-30",status:"Active"},
  {id:"E044",name:"Maria Garcia",dept:"Marketing",salary:75000,hired:"2018-11-12",status:"Active"},
  {id:"E009",name:"Henry Park",dept:"Marketing",salary:68000,hired:"2021-03-04",status:"Inactive"},
  {id:"E077",name:"Karen Taylor",dept:"Engineering",salary:89000,hired:"2020-06-18",status:"Active"},
  {id:"E022",name:"James Wilson",dept:"HR",salary:52000,hired:"2023-01-09",status:"Active"},
];

function queryUploadedData(raw){
  if(!parsedData||!parsedData.length)return null;
  const k=raw.toLowerCase();
  const data=parsedData;
  // show all
  if(k.includes('all')||k.includes('show')||k.includes('list')){return{res:data,label:'All Records',code:`db.collection.find({}, {_id:0})`,op:'find()',conf:94,time:Math.round(5+Math.random()*20)+'ms',idx:'COLLSCAN'}}
  // count
  if(k.includes('count')){const keys=Object.keys(data[0]||{});const groupKey=keys.find(k2=>typeof data[0][k2]==='string')||keys[0];const m={};data.forEach(r=>{const v=r[groupKey]||'?';m[v]=(m[v]||0)+1});const res=Object.entries(m).map(([k2,c])=>({[groupKey]:k2,count:c})).sort((a,b)=>b.count-a.count);return{res,label:'Count by '+groupKey,code:`db.collection.aggregate([{$group:{_id:"$${groupKey}",count:{$sum:1}}},{$sort:{count:-1}}])`,op:'aggregate()',conf:92,time:Math.round(8+Math.random()*15)+'ms',idx:'COLLSCAN'}}
  // search by keyword
  const words=raw.split(' ').filter(w=>w.length>3);
  const res=data.filter(row=>words.some(w=>Object.values(row).some(v=>String(v).toLowerCase().includes(w.toLowerCase()))));
  if(res.length>0)return{res,label:'Search: '+raw.slice(0,30),code:`db.collection.find({$text:{$search:"${raw.slice(0,40)}"}})`,op:'find()',conf:85,time:Math.round(10+Math.random()*25)+'ms',idx:'TEXT'}
  return{res:data.slice(0,20),label:'Top 20 records',code:`db.collection.find({}).limit(20)`,op:'find()',conf:80,time:Math.round(6+Math.random()*12)+'ms',idx:'COLLSCAN'}
}

const CFGS={
  "hired after 2020":{filter:()=>EMP.filter(e=>parseInt(e.hired)>2020).sort((a,b)=>b.hired.localeCompare(a.hired)),code:`db.employees.find(\n  { hire_date: { <span class="op">$gt</span>: <span class="str">ISODate("2020-12-31")</span> } },\n  { <span class="cm">_id</span>: 0 }\n).sort({ hire_date: <span class="op">-1</span> })`,csum:"db.employees.find({ hire_date: { $gt: ... } })",op:"find()",conf:95,time:"14ms",idx:"IXSCAN",q:"Who joined after 2020?",qs:"All employees hired after December 31, 2020.",steps:[{h:"Opened employee records",d:"Accessed all "+EMP.length+" employee profiles."},{h:"Applied date filter",d:'Kept only people hired after Dec 31, 2020.'},{h:"Used an index",d:"Jumped directly to matching records via index."},{h:"Sorted newest first",d:"Most recently hired appears at the top."}],found:r=>`<span class="hl">${r.length} employees</span> joined after 2020. Newest: <span class="hl">${r[0].name}</span> (${r[0].dept}) on <span class="hl">${r[0].hired}</span>.`,insights:r=>[{i:"üÜï",t:`${r.length}/${EMP.length} employees (${Math.round(r.length/EMP.length*100)}%) joined in the last 3 years.`},{i:"üè¢",t:`Sales has the most new hires: ${r.filter(e=>e.dept==="Sales").length}.`},{i:"üìÖ",t:`Most recent hire: ${r[0].hired}.`}],next:["Top 5 highest paid","Count by department","Find all employees in Sales","Average salary per dept"]},
  "count by department":{filter:()=>{const m={};EMP.forEach(e=>{m[e.dept]=(m[e.dept]||0)+1});return Object.entries(m).map(([d,c])=>({department:d,headcount:c})).sort((a,b)=>b.headcount-a.headcount)},code:`db.employees.aggregate([\n  { <span class="op">$group</span>: { _id: <span class="str">"$department"</span>, headcount: { <span class="op">$sum</span>: 1 } } },\n  { <span class="op">$sort</span>: { headcount: <span class="op">-1</span> } }\n])`,csum:"db.employees.aggregate([{$group},{$sort}])",op:"aggregate()",conf:98,time:"8ms",idx:"COLLSCAN",q:"Headcount per department",qs:"How many employees in each team?",steps:[{h:"Scanned all records",d:`All ${EMP.length} profiles checked.`},{h:"Grouped by department",d:"Employees sorted into team buckets."},{h:"Counted each group",d:"Tally per department calculated."},{h:"Sorted largest first",d:"Biggest team at the top."}],found:r=>`<span class="hl">${r.length} departments</span>. Biggest: <span class="hl">${r[0].department}</span> (${r[0].headcount}). Smallest: <span class="hl">${r[r.length-1].department}</span> (${r[r.length-1].headcount}).`,insights:r=>[{i:"üèÜ",t:`${r[0].department} is largest: ${r[0].headcount} people.`},{i:"üìâ",t:`${r[r.length-1].department} is smallest: ${r[r.length-1].headcount}.`},{i:"‚öñÔ∏è",t:`Average team size: ${Math.round(EMP.length/r.length)}.`}],next:["Average salary per dept","Top 5 highest paid","Find all employees in Sales","Hired after 2020"]},
  "find all employees in sales":{filter:()=>EMP.filter(e=>e.dept==="Sales"),code:`db.employees.find({ department: <span class="str">"Sales"</span> })`,csum:'db.employees.find({ department: "Sales" })',op:"find()",conf:99,time:"6ms",idx:"IXSCAN",q:"Everyone in Sales",qs:"Full list of Sales team members.",steps:[{h:"Scanned records",d:`Checked ${EMP.length} profiles.`},{h:"Filtered by Sales",d:'Kept only dept === "Sales".'},{h:"Collected results",d:"All Sales employees gathered."},{h:"Returned list",d:"Full details returned."}],found:r=>`<span class="hl">${r.length} people</span> in Sales. <span class="hl">${r.filter(e=>e.status==="Active").length} active</span>. Salary: $${Math.min(...r.map(e=>e.salary)).toLocaleString()}‚Äì$${Math.max(...r.map(e=>e.salary)).toLocaleString()}.`,insights:r=>[{i:"üë•",t:`Sales = ${Math.round(r.length/EMP.length*100)}% of workforce.`},{i:"‚úÖ",t:`${r.filter(e=>e.status==="Active").length}/${r.length} active.`},{i:"üí∞",t:`Top earner: $${Math.max(...r.map(e=>e.salary)).toLocaleString()}/yr.`}],next:["Count by department","Average salary per dept","Top 5 highest paid","Hired after 2020"]},
  "top 5 highest paid":{filter:()=>[...EMP].sort((a,b)=>b.salary-a.salary).slice(0,5),code:`db.employees.find({}).sort({ salary: <span class="op">-1</span> }).limit(<span class="op">5</span>)`,csum:"db.employees.find({}).sort({salary:-1}).limit(5)",op:"find()",conf:97,time:"11ms",idx:"IXSCAN",q:"Top 5 earners",qs:"The 5 highest-paid employees company-wide.",steps:[{h:"Read all salaries",d:`Checked ${EMP.length} employee salaries.`},{h:"Ranked highest first",d:"Sorted by salary descending."},{h:"Limited to 5",d:"Took top 5 only."},{h:"Returned results",d:"Names, dept, salary returned."}],found:r=>`Top: <span class="hl">${r[0].name}</span> (${r[0].dept}) at <span class="hl">$${r[0].salary.toLocaleString()}/yr</span>.`,insights:r=>[{i:"ü•á",t:`${r[0].name}: $${r[0].salary.toLocaleString()}/yr.`},{i:"üè¢",t:`${r.filter(e=>e.dept==="Engineering").length}/5 top earners are in Engineering.`},{i:"üìà",t:`Lowest of top 5: $${Math.min(...r.map(e=>e.salary)).toLocaleString()}/yr.`}],next:["Average salary per dept","Count by department","Find all employees in Sales","Hired after 2020"]},
  "average salary per dept":{filter:()=>{const m={},c={};EMP.forEach(e=>{m[e.dept]=(m[e.dept]||0)+e.salary;c[e.dept]=(c[e.dept]||0)+1});return Object.entries(m).map(([d,s])=>({department:d,avg_salary:Math.round(s/c[d]),headcount:c[d]})).sort((a,b)=>b.avg_salary-a.avg_salary)},code:`db.employees.aggregate([\n  { <span class="op">$group</span>: { _id: <span class="str">"$department"</span>, avg_salary: { <span class="op">$avg</span>: <span class="str">"$salary"</span> }, headcount: { <span class="op">$sum</span>: 1 } } },\n  { <span class="op">$sort</span>: { avg_salary: <span class="op">-1</span> } }\n])`,csum:"db.employees.aggregate([{$group:{avg_salary:$avg}}])",op:"aggregate()",conf:96,time:"10ms",idx:"COLLSCAN",q:"Average salary per department",qs:"Which team pays the most on average?",steps:[{h:"Read all salaries",d:`All ${EMP.length} employee salaries.`},{h:"Grouped by dept",d:"Employees sorted into teams."},{h:"Averaged salaries",d:"Sum √∑ headcount per team."},{h:"Ranked best to worst",d:"Highest avg salary at top."}],found:r=>`<span class="hl">${r[0].department}</span> pays most: <span class="hl">$${r[0].avg_salary.toLocaleString()}/yr</span>. Lowest: <span class="hl">${r[r.length-1].department}</span> at $${r[r.length-1].avg_salary.toLocaleString()}/yr.`,insights:r=>[{i:"üí∞",t:`${r[0].department} pays most on average.`},{i:"üìä",t:`Company avg: $${Math.round(EMP.reduce((s,e)=>s+e.salary,0)/EMP.length).toLocaleString()}/yr.`},{i:"üí∏",t:`Pay gap: $${(r[0].avg_salary-r[r.length-1].avg_salary).toLocaleString()}.`}],next:["Top 5 highest paid","Count by department","Find all employees in Sales","Hired after 2020"]},
};

function getCfg(raw){const k=raw.toLowerCase().trim();return CFGS[Object.keys(CFGS).find(c=>k.includes(c)||c.includes(k.slice(0,12)))||"hired after 2020"]}

let lastRes=[],execTimes=[22,15,30,17,40,12,25,19,34,18],mc={find:0,agg:0};
const delay=ms=>new Promise(r=>setTimeout(r,ms));

function rPipe(){["p1","p2","p3","p4","p5","p6"].forEach((id,i)=>{const el=document.getElementById(id);el.className="pi pend";el.textContent="‚óã";document.getElementById("l"+(i+1)).className="pl"})}
async function animPipe(){
  document.getElementById("pipe").classList.add("on");rPipe();
  for(let i=1;i<=6;i++){const el=document.getElementById("p"+i);el.className="pi run";el.textContent="‚ü≥";await delay(200);el.className="pi done";el.textContent="‚úì";document.getElementById("l"+i).className="pl done";await delay(80)}
}

function log(type,msg){
  const body=document.getElementById("lb");document.getElementById("lp").classList.add("on");
  const t=new Date().toTimeString().slice(0,8);const d=document.createElement("div");d.className="ll";
  d.innerHTML=`<span class="ltm">${t}</span><span class="l${type}">[${type==="i"?"INFO":type==="s"?"SUCCESS":"WARN"}]</span><span class="lm">${msg}</span>`;
  body.appendChild(d);body.scrollTop=body.scrollHeight;
}

function renderTable(data){
  if(!data||!data.length)return;
  const keys=Object.keys(data[0]);
  document.getElementById("th").innerHTML="<tr>"+keys.map(k=>`<th>${k.replace(/_/g," ").toUpperCase()}</th>`).join("")+"</tr>";
  document.getElementById("tb").innerHTML=data.slice(0,200).map(row=>"<tr>"+keys.map(k=>{const v=row[k];
    if(k==="dept"||k==="department")return`<td><span class="tdept">${v}</span></td>`;
    if(k==="status")return`<td><span class="${v==="Active"?"tact":"tina"}">${v==="Active"?"‚óè Active":"‚óã Inactive"}</span></td>`;
    if(k==="salary"||k==="avg_salary"||k==="value")return`<td style="color:var(--blue)">$${Number(v).toLocaleString()}</td>`;
    return`<td>${v}</td>`}).join("")+"</tr>").join("");
}

function renderExpl(cfg,r){
  if(!cfg.steps)return;
  const sh=cfg.steps.map(s=>`<div class="estep"><div class="enum">‚úì</div><div class="ebody"><div class="ehead">${s.h}</div><div class="edesc">${s.d}</div></div></div>`).join("");
  const ih=(cfg.insights?cfg.insights(r):[]).map(i=>`<div class="ins"><span style="flex-shrink:0;font-size:14px">${i.i}</span><span>${i.t}</span></div>`).join("");
  const nh=(cfg.next||[]).map(q=>`<button class="nbtn" onclick="sq('${q}');runQuery()">‚Üí ${q}</button>`).join("");
  document.getElementById("eg").innerHTML=`
    <div class="ehero"><div class="ehero-lbl">üôã What You Asked</div><div class="ehero-q">${cfg.q||'Custom Query'}</div><div class="ehero-sub">${cfg.qs||''}</div></div>
    <div class="esteps"><div class="esteps-ttl">‚öôÔ∏è How We Found It</div>${sh}</div>
    <div class="efound"><div class="efound-ttl">üìã What We Found</div><div class="efound-txt">${cfg.found?cfg.found(r):'<span class="hl">'+r.length+' records</span> returned.'}</div><div style="margin-top:14px">${ih}</div></div>
    ${nh?`<div class="enext"><div class="enext-ttl">üí¨ Ask Next</div><div class="ngrid">${nh}</div></div>`:''}
  `;
  document.getElementById("expl").classList.add("on");
}

function drawDonut(){
  const c=document.getElementById("dc"),ctx=c.getContext("2d");
  const vals=[mc.find,mc.agg,1,1],total=vals.reduce((a,b)=>a+b,0)||1;
  const cols=["#00d4ff","#6366f1","#f59e0b","#a78bfa"],labels=["find()","aggregate()","insert()","update()"];
  ctx.clearRect(0,0,c.width,c.height);
  let a=-Math.PI/2;const cx=110,cy=115,r=85,ri=52;
  vals.forEach((v,i)=>{const s=(v/total)*Math.PI*2||0.05;ctx.beginPath();ctx.moveTo(cx,cy);ctx.arc(cx,cy,r,a,a+s);ctx.closePath();ctx.fillStyle=cols[i];ctx.fill();a+=s});
  ctx.beginPath();ctx.arc(cx,cy,ri,0,Math.PI*2);ctx.fillStyle="#0e1420";ctx.fill();
  labels.forEach((l,i)=>{const lx=230,ly=55+i*32;ctx.fillStyle=cols[i];ctx.fillRect(lx,ly,12,12);ctx.fillStyle="#64748b";ctx.font="12px Outfit";ctx.fillText(l,lx+18,ly+11)});
}
function drawLine(){
  const c=document.getElementById("lc"),ctx=c.getContext("2d");
  const W=c.width,H=c.height,pad=40,mn=8,mx=48;
  ctx.clearRect(0,0,W,H);
  const pts=execTimes.map((v,i)=>({x:pad+(i/(execTimes.length-1))*(W-pad*2),y:H-pad-((v-mn)/(mx-mn))*(H-pad*2)}));
  [10,20,30,40].forEach(v=>{const y=H-pad-((v-mn)/(mx-mn))*(H-pad*2);ctx.strokeStyle="#1a2235";ctx.lineWidth=1;ctx.beginPath();ctx.moveTo(pad,y);ctx.lineTo(W-pad,y);ctx.stroke();ctx.fillStyle="#334155";ctx.font="10px JetBrains Mono";ctx.fillText(v+"ms",2,y+4)});
  execTimes.forEach((_,i)=>{const x=pad+(i/(execTimes.length-1))*(W-pad*2);ctx.fillStyle="#334155";ctx.font="10px JetBrains Mono";ctx.fillText("Q"+(i+1),x-7,H-6)});
  ctx.beginPath();ctx.moveTo(pts[0].x,H-pad);pts.forEach(p=>ctx.lineTo(p.x,p.y));ctx.lineTo(pts[pts.length-1].x,H-pad);ctx.closePath();ctx.fillStyle="rgba(0,212,255,0.07)";ctx.fill();
  ctx.beginPath();pts.forEach((p,i)=>i?ctx.lineTo(p.x,p.y):ctx.moveTo(p.x,p.y));ctx.strokeStyle="#00d4ff";ctx.lineWidth=2;ctx.stroke();
  pts.forEach(p=>{ctx.beginPath();ctx.arc(p.x,p.y,4,0,Math.PI*2);ctx.fillStyle="#00d4ff";ctx.fill();ctx.strokeStyle="#0e1420";ctx.lineWidth=2;ctx.stroke()});
}

function st2(tab,el){
  document.querySelectorAll(".tab").forEach(t=>t.classList.remove("act"));el.classList.add("act");
  document.getElementById("tt").style.display=tab==="t"?"block":"none";
  document.getElementById("tj").style.display=tab==="j"?"block":"none";
}

async function runQuery(){
  const raw=document.getElementById("qi").value.trim();if(!raw)return;
  ["cb","sc","expl","rs","cg"].forEach(id=>document.getElementById(id).classList.remove("on"));
  document.getElementById("lb").innerHTML="";
  const btn=document.getElementById("rb");btn.classList.add("ld");btn.innerHTML="‚è≥ Running‚Ä¶";

  // Try uploaded data first
  let uploadResult=null;
  if(parsedData&&parsedData.length){
    uploadResult=queryUploadedData(raw);
    log("i",`Source: uploaded file (${uploadedFiles[activeFileIndex]?.name})`);
  }else{
    log("i","Source: employees collection (default)");
  }
  log("i",`Query: "${raw}"`);

  await animPipe();await delay(180);

  let res,cfg2;
  if(uploadResult){
    res=uploadResult.res;lastRes=res;
    const t=uploadResult.time||'12ms';
    execTimes.push(parseInt(t));if(execTimes.length>10)execTimes.shift();
    if(uploadResult.op.startsWith("find"))mc.find++;else mc.agg++;
    document.getElementById("cop").textContent=uploadResult.op;
    document.getElementById("csum").textContent=uploadResult.code.slice(0,60)+'‚Ä¶';
    document.getElementById("cd").innerHTML=`<span class="fn">${uploadResult.code.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</span>`;
    document.getElementById("cb").classList.add("on");
    document.getElementById("sd").textContent=res.length;
    document.getElementById("sf").textContent=uploadResult.conf+'%';
    document.getElementById("st").textContent=t;
    document.getElementById("si").textContent=uploadResult.idx||'COLLSCAN';
    document.getElementById("sc").classList.add("on");
    const fakeExpl={q:uploadResult.label,qs:`Query run against: ${uploadedFiles[activeFileIndex]?.name}`,steps:[{h:"Loaded uploaded file",d:`Parsed ${parsedData.length} records from ${uploadedFiles[activeFileIndex]?.name}.`},{h:"Interpreted your query",d:`Matched "${raw}" against available fields.`},{h:"Filtered & returned",d:`${res.length} records match your query.`}],found:r=>`<span class="hl">${r.length} records</span> returned from <span class="hl">${uploadedFiles[activeFileIndex]?.name}</span>.`,insights:r=>[{i:"üìÅ",t:`Source: ${uploadedFiles[activeFileIndex]?.name} (${fmtSize(uploadedFiles[activeFileIndex]?.size||0)})`},{i:"üìä",t:`${res.length} of ${parsedData.length} records matched (${Math.round(res.length/parsedData.length*100)}%).`}]};
    renderExpl(fakeExpl,res);
    log("s",`Executed in ${t} ‚Äî ${res.length} records returned from file`);
  }else{
    const cfg=getCfg(raw);res=cfg.filter();lastRes=res;
    execTimes.push(parseInt(cfg.time));if(execTimes.length>10)execTimes.shift();
    if(cfg.op.startsWith("find"))mc.find++;else mc.agg++;
    document.getElementById("cop").textContent=cfg.op;
    document.getElementById("csum").textContent=cfg.csum;
    document.getElementById("cd").innerHTML=cfg.code;
    document.getElementById("cb").classList.add("on");
    document.getElementById("sd").textContent=res.length;
    document.getElementById("sf").textContent=cfg.conf+'%';
    document.getElementById("st").textContent=cfg.time;
    document.getElementById("si").textContent=cfg.idx;
    document.getElementById("sc").classList.add("on");
    renderExpl(cfg,res);
    log("s",`Executed in ${cfg.time} ‚Äî ${res.length} documents returned`);
  }

  document.getElementById("rc").textContent=res.length+" records";
  renderTable(res);
  document.getElementById("jp").textContent=JSON.stringify(res.slice(0,50),null,2);
  document.getElementById("rs").classList.add("on");
  document.getElementById("tt").style.display="block";document.getElementById("tj").style.display="none";
  document.querySelectorAll(".tab").forEach((t,i)=>t.classList.toggle("act",i===0));
  document.getElementById("cg").classList.add("on");
  setTimeout(()=>{drawDonut();drawLine()},80);
  btn.classList.remove("ld");btn.innerHTML="‚ö° Generate + Run";
  document.getElementById("ms").scrollTop=250;
}

function sq(q){document.getElementById("qi").value=q}
function clearQ(){document.getElementById("qi").value=""}
function copyCode(){navigator.clipboard.writeText(document.getElementById("cd").innerText).catch(()=>{})}
function exportJ(){if(!lastRes.length)return;const b=new Blob([JSON.stringify(lastRes,null,2)],{type:"application/json"});const a=document.createElement("a");a.href=URL.createObjectURL(b);a.download="results.json";a.click();showToast('üì• JSON exported')}
function exportCSV(){
  if(!lastRes.length)return;
  const keys=Object.keys(lastRes[0]);
  const csv=[keys.join(','),...lastRes.map(r=>keys.map(k=>JSON.stringify(r[k]??'')).join(','))].join('\n');
  const b=new Blob([csv],{type:'text/csv'});const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='results.csv';a.click();showToast('üì• CSV exported');
}

function showToast(msg){
  const t=document.createElement('div');t.className='toast';
  t.innerHTML='<span style="color:var(--cyan);font-size:16px">‚úì</span>'+msg;
  document.body.appendChild(t);setTimeout(()=>t.remove(),3300);
}

document.getElementById("qi").addEventListener("keydown",e=>{if(e.key==="Enter")runQuery()});
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MongoQuery ‚Äî AI-Powered Query Generator</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
:root {
  --bg: #080c10;
  --surface: #0e1419;
  --card: #131920;
  --card2: #161d26;
  --border: #1e2a36;
  --border2: #253040;
  --green: #00f580;
  --green-dim: #00c060;
  --green-dark: #004a28;
  --blue: #4db8ff;
  --amber: #ffb340;
  --red: #ff4f4f;
  --purple: #b48eff;
  --text: #dce8f0;
  --text2: #8fa3b5;
  --text3: #4d6070;
  --glow: 0 0 32px rgba(0,245,128,0.15);
  --glow-sm: 0 0 14px rgba(0,245,128,0.1);
}
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

body {
  background: var(--bg);
  color: var(--text);
  font-family: 'Syne', sans-serif;
  min-height: 100vh;
  overflow-x: hidden;
  font-size: 14px;
}

/* Grid BG */
body::before {
  content: '';
  position: fixed;
  inset: 0;
  background-image:
    linear-gradient(rgba(0,245,128,0.025) 1px, transparent 1px),
    linear-gradient(90deg, rgba(0,245,128,0.025) 1px, transparent 1px);
  background-size: 40px 40px;
  pointer-events: none;
  z-index: 0;
}
/* Ambient glow blobs */
body::after {
  content: '';
  position: fixed;
  top: -200px; right: -200px;
  width: 600px; height: 600px;
  background: radial-gradient(circle, rgba(0,245,128,0.06) 0%, transparent 65%);
  pointer-events: none; z-index: 0;
}
.blob2 {
  position: fixed;
  bottom: -150px; left: -150px;
  width: 500px; height: 500px;
  background: radial-gradient(circle, rgba(77,184,255,0.05) 0%, transparent 65%);
  pointer-events: none; z-index: 0;
}

.app { position: relative; z-index: 1; display: flex; flex-direction: column; height: 100vh; }

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 0 28px; height: 56px;
  border-bottom: 1px solid var(--border);
  background: rgba(8,12,16,0.9);
  backdrop-filter: blur(20px);
  position: sticky; top: 0; z-index: 200; flex-shrink: 0;
}
.logo { display: flex; align-items: center; gap: 10px; }
.logo-icon {
  width: 30px; height: 30px;
  background: linear-gradient(135deg, var(--green), var(--green-dim));
  border-radius: 8px 2px 8px 2px;
  display: flex; align-items: center; justify-content: center;
  font-size: 15px; box-shadow: var(--glow-sm);
  flex-shrink: 0;
}
.logo-text { font-size: 16px; font-weight: 800; letter-spacing: -0.5px; }
.logo-text .m { color: var(--green); }
.header-center {
  display: flex; align-items: center; gap: 8px;
  background: var(--card); border: 1px solid var(--border);
  border-radius: 8px; padding: 5px 14px;
  font-family: 'JetBrains Mono', monospace; font-size: 11px; color: var(--text3);
}
.header-center .coll { color: var(--green); font-weight: 600; }
.header-right { display: flex; align-items: center; gap: 12px; }
.hbadge {
  padding: 3px 9px; border-radius: 5px; font-size: 10px; font-weight: 700;
  font-family: 'JetBrains Mono', monospace; letter-spacing: 0.5px;
}
.hbadge-ai { background: rgba(77,184,255,0.1); border: 1px solid rgba(77,184,255,0.25); color: var(--blue); }
.hbadge-v { background: rgba(0,245,128,0.1); border: 1px solid rgba(0,245,128,0.25); color: var(--green); }
.conn-pill { display: flex; align-items: center; gap: 6px; font-family: 'JetBrains Mono', monospace; font-size: 10px; color: var(--text3); }
.conn-dot { width: 6px; height: 6px; background: var(--green); border-radius: 50%; box-shadow: 0 0 6px var(--green); animation: blink 2s infinite; }
@keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.4} }

/* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
.workspace { display: grid; grid-template-columns: 248px 1fr; flex: 1; overflow: hidden; }

/* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
.sidebar {
  border-right: 1px solid var(--border);
  background: rgba(14,20,25,0.6);
  display: flex; flex-direction: column;
  overflow-y: auto; padding: 18px 0 20px;
}
.sb-sec { padding: 0 14px; margin-bottom: 4px; }
.sb-label {
  font-size: 9px; font-weight: 700; letter-spacing: 2.5px; color: var(--text3);
  text-transform: uppercase; margin-bottom: 7px; padding: 0 2px;
}
.nav-item {
  display: flex; align-items: center; gap: 9px;
  padding: 8px 10px; border-radius: 7px; cursor: pointer;
  font-size: 12px; font-weight: 600; color: var(--text3);
  transition: all 0.15s; margin-bottom: 1px;
}
.nav-item:hover { background: var(--border); color: var(--text2); }
.nav-item.active { background: rgba(0,245,128,0.08); color: var(--green); }
.nav-item .ni { font-size: 13px; }
.nav-count { margin-left: auto; background: var(--border); color: var(--text3); font-family: 'JetBrains Mono', monospace; font-size: 10px; padding: 1px 6px; border-radius: 8px; }
.sb-div { border: none; border-top: 1px solid var(--border); margin: 12px 14px; }
.coll-item {
  display: flex; align-items: center; gap: 8px;
  padding: 7px 10px; border-radius: 7px; cursor: pointer;
  font-size: 11px; font-weight: 600; color: var(--text3);
  transition: all 0.15s; font-family: 'JetBrains Mono', monospace;
  margin-bottom: 1px;
}
.coll-item:hover { background: var(--border); color: var(--text2); }
.coll-item.active { background: rgba(0,245,128,0.07); color: var(--green); border-left: 2px solid var(--green); padding-left: 8px; }
.coll-cnt { margin-left: auto; font-size: 10px; color: var(--text3); }
.op-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; }
.op-btn {
  padding: 7px 5px; border-radius: 6px;
  background: var(--card2); border: 1px solid var(--border);
  color: var(--text3); font-size: 10px; font-weight: 700; cursor: pointer;
  transition: all 0.15s; font-family: 'JetBrains Mono', monospace;
  text-align: center; letter-spacing: 0.2px;
}
.op-btn:hover { border-color: var(--green); color: var(--green); }
.op-btn.active { background: rgba(0,245,128,0.08); border-color: var(--green); color: var(--green); }

/* Upload */
.upload-zone {
  position: relative; border: 2px dashed var(--border);
  border-radius: 9px; padding: 14px 10px; text-align: center;
  cursor: pointer; transition: all 0.2s;
}
.upload-zone:hover, .upload-zone.drag-over { border-color: var(--green); background: rgba(0,245,128,0.03); }
.upload-zone input { position: absolute; inset: 0; opacity: 0; cursor: pointer; width: 100%; height: 100%; }
.upload-icon { font-size: 20px; margin-bottom: 4px; display: block; }
.upload-main { font-size: 11px; font-weight: 700; color: var(--text2); margin-bottom: 2px; }
.upload-sub { font-size: 9px; color: var(--text3); font-family: 'JetBrains Mono', monospace; }
.fmt-row { display: flex; gap: 3px; justify-content: center; margin-top: 6px; flex-wrap: wrap; }
.fmt-tag { background: var(--border); color: var(--text3); border-radius: 3px; padding: 2px 5px; font-size: 9px; font-weight: 700; font-family: 'JetBrains Mono', monospace; }
.file-loaded { display: none; background: rgba(0,245,128,0.04); border: 1px solid rgba(0,245,128,0.18); border-radius: 8px; padding: 9px; margin-top: 7px; }
.fl-row { display: flex; align-items: center; gap: 6px; }
.fl-info { flex: 1; min-width: 0; }
.fl-name { font-size: 10px; font-weight: 700; color: var(--green); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-family: 'JetBrains Mono', monospace; }
.fl-meta { font-size: 9px; color: var(--text3); font-family: 'JetBrains Mono', monospace; margin-top: 1px; }
.fl-remove { background: none; border: 1px solid var(--border); color: var(--text3); border-radius: 4px; padding: 2px 5px; font-size: 9px; cursor: pointer; }
.fl-remove:hover { border-color: var(--red); color: var(--red); }

/* DB info */
.db-info { background: var(--card2); border: 1px solid var(--border); border-radius: 8px; padding: 10px 12px; }
.db-label { font-size: 9px; color: var(--text3); font-weight: 700; letter-spacing: 1.5px; margin-bottom: 4px; }
.db-name { font-size: 12px; font-weight: 700; color: var(--green); font-family: 'JetBrains Mono', monospace; }
.db-meta { font-size: 10px; color: var(--text3); margin-top: 2px; font-family: 'JetBrains Mono', monospace; }

/* ‚îÄ‚îÄ RIGHT PANEL ‚îÄ‚îÄ */
.right-panel { display: flex; flex-direction: column; overflow: hidden; }

/* Query Area */
.query-area {
  padding: 18px 24px 14px;
  border-bottom: 1px solid var(--border);
  background: rgba(14,20,25,0.5);
  flex-shrink: 0;
}
.qa-top { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
.qa-label { font-size: 9px; font-weight: 700; letter-spacing: 2px; color: var(--text3); text-transform: uppercase; }
.coll-pill {
  display: flex; align-items: center; gap: 5px;
  background: var(--card); border: 1px solid var(--border);
  border-radius: 6px; padding: 3px 10px;
  font-family: 'JetBrains Mono', monospace; font-size: 10px; color: var(--green);
}
.qbox-wrap { position: relative; }
.qbox {
  width: 100%; background: var(--card); border: 1px solid var(--border);
  border-radius: 10px; padding: 14px 170px 14px 16px;
  color: var(--text); font-family: 'Syne', sans-serif; font-size: 14px;
  font-weight: 500; outline: none; transition: all 0.2s; height: 50px; line-height: 22px;
}
.qbox:focus { border-color: var(--green); box-shadow: var(--glow); }
.qbox::placeholder { color: var(--text3); font-weight: 400; }
.qbox-actions { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); display: flex; gap: 5px; align-items: center; }
.btn-run {
  background: linear-gradient(135deg, var(--green), var(--green-dim));
  color: #080c10; border: none; border-radius: 7px; padding: 8px 14px;
  font-family: 'Syne', sans-serif; font-size: 12px; font-weight: 700;
  cursor: pointer; transition: all 0.18s; white-space: nowrap; letter-spacing: 0.2px;
}
.btn-run:hover { transform: scale(1.03); box-shadow: var(--glow); }
.btn-run:active { transform: scale(0.97); }
.btn-clr {
  background: var(--border); border: none; color: var(--text3);
  border-radius: 7px; padding: 8px 10px; font-size: 12px; cursor: pointer; transition: all 0.15s;
}
.btn-clr:hover { background: var(--card2); color: var(--text2); }
.chips { display: flex; gap: 6px; margin-top: 10px; flex-wrap: wrap; }
.chip {
  background: var(--card2); border: 1px solid var(--border);
  border-radius: 20px; padding: 3px 11px; font-size: 10px;
  color: var(--text3); cursor: pointer; transition: all 0.15s; font-weight: 600;
}
.chip:hover { border-color: var(--green); color: var(--green); background: rgba(0,245,128,0.04); }

/* Live Explain Banner */
.live-explain {
  display: none;
  margin-top: 12px;
  background: rgba(0,245,128,0.03);
  border: 1px solid rgba(0,245,128,0.18);
  border-radius: 10px;
  overflow: hidden;
  animation: slideDown 0.25s ease;
}
@keyframes slideDown { from { opacity:0; transform:translateY(-6px); } to { opacity:1; transform:translateY(0); } }
.le-top {
  display: flex; align-items: center; gap: 10px;
  padding: 10px 14px;
  border-bottom: 1px solid rgba(0,245,128,0.1);
  background: rgba(0,245,128,0.04);
}
.le-dot { width: 7px; height: 7px; background: var(--green); border-radius: 50%; box-shadow: 0 0 6px var(--green); animation: blink 1.5s infinite; flex-shrink:0; }
.le-heading { font-size: 10px; font-weight: 700; color: var(--green); letter-spacing: 1.5px; text-transform: uppercase; }
.le-body { padding: 12px 14px; display: flex; gap: 14px; align-items: flex-start; }
.le-icon { font-size: 22px; flex-shrink: 0; margin-top: 1px; }
.le-content { flex: 1; }
.le-sentence {
  font-size: 13px; font-weight: 600; color: var(--text);
  line-height: 1.65; margin-bottom: 8px;
}
.le-sentence em { font-style: normal; color: var(--green); font-weight: 700; }
.le-sentence mark { background: rgba(0,245,128,0.12); color: var(--green); border-radius: 3px; padding: 0 4px; font-style: normal; font-weight: 700; }
.le-tags { display: flex; gap: 6px; flex-wrap: wrap; }
.le-tag {
  display: flex; align-items: center; gap: 4px;
  background: var(--card2); border: 1px solid var(--border);
  border-radius: 5px; padding: 3px 8px;
  font-size: 10px; font-weight: 600; color: var(--text3);
  font-family: 'JetBrains Mono', monospace;
}
.le-tag .tt { font-size: 11px; }
.le-tag.action { border-color: rgba(0,245,128,0.3); color: var(--green); background: rgba(0,245,128,0.06); }
.le-tag.filter { border-color: rgba(77,184,255,0.3); color: var(--blue); background: rgba(77,184,255,0.06); }
.le-tag.sort { border-color: rgba(255,179,64,0.3); color: var(--amber); background: rgba(255,179,64,0.06); }
.le-tag.limit { border-color: rgba(180,142,255,0.3); color: var(--purple); background: rgba(180,142,255,0.06); }

/* Content */
.content { flex: 1; overflow-y: auto; padding: 20px 24px 28px; }

/* Empty State */
.empty-state { text-align: center; padding: 60px 20px; color: var(--text3); }
.es-icon { font-size: 48px; display: block; margin-bottom: 14px; }
.es-title { font-size: 20px; font-weight: 800; color: var(--text2); margin-bottom: 8px; }
.es-sub { font-size: 13px; line-height: 1.7; color: var(--text3); }

/* Loading */
.loading { display: none; align-items: center; gap: 12px; padding: 16px 0; font-family: 'JetBrains Mono', monospace; font-size: 11px; color: var(--text3); }
.spinner { width: 14px; height: 14px; border: 2px solid var(--border2); border-top-color: var(--green); border-radius: 50%; animation: spin 0.6s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }
@keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

/* Pipeline */
.pipeline {
  display: flex; gap: 0; margin-bottom: 16px;
  border-radius: 8px; overflow: hidden; border: 1px solid var(--border);
  animation: slideUp 0.3s ease;
}
.ps {
  flex: 1; padding: 10px 6px; text-align: center;
  font-size: 9px; font-weight: 700; letter-spacing: 0.3px; color: var(--text3);
  background: var(--card2); border-right: 1px solid var(--border);
  transition: all 0.25s; text-transform: uppercase;
}
.ps:last-child { border-right: none; }
.ps .ps-icon { display: block; font-size: 14px; margin-bottom: 3px; }
.ps.done { color: var(--green); background: rgba(0,245,128,0.05); }
.ps.active { color: var(--text); background: rgba(0,245,128,0.1); }

/* Query Display Block */
.query-block {
  background: var(--card); border: 1px solid var(--border);
  border-left: 3px solid var(--green);
  border-radius: 10px; margin-bottom: 16px; overflow: hidden;
  animation: slideUp 0.35s ease;
}
.qb-head {
  display: flex; align-items: center; justify-content: space-between;
  padding: 10px 14px; border-bottom: 1px solid var(--border);
  background: rgba(0,245,128,0.02);
}
.qb-head-left { display: flex; align-items: center; gap: 9px; }
.qb-method {
  background: rgba(0,245,128,0.12); color: var(--green);
  font-family: 'JetBrains Mono', monospace; font-size: 10px; font-weight: 700;
  padding: 2px 8px; border-radius: 4px; letter-spacing: 0.5px;
}
.qb-op { font-size: 11px; color: var(--text3); font-family: 'JetBrains Mono', monospace; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 380px; }
.qb-actions2 { display: flex; gap: 6px; }
.qb-copy {
  background: none; border: 1px solid var(--border); color: var(--text3);
  border-radius: 5px; padding: 3px 9px; font-size: 10px; cursor: pointer; transition: all 0.15s;
  font-family: 'JetBrains Mono', monospace;
}
.qb-copy:hover { border-color: var(--green); color: var(--green); }
.qb-body { padding: 12px 14px; }
.qb-code { font-family: 'JetBrains Mono', monospace; font-size: 12px; color: #9db8cc; line-height: 1.7; white-space: pre-wrap; word-break: break-word; }

/* Confidence + Plan bar */
.meta-row {
  display: flex; gap: 10px; margin-bottom: 16px; animation: slideUp 0.38s ease;
}
.meta-box {
  flex: 1; background: var(--card); border: 1px solid var(--border);
  border-radius: 9px; padding: 12px 14px;
}
.meta-label { font-size: 9px; font-weight: 700; letter-spacing: 2px; text-transform: uppercase; color: var(--text3); margin-bottom: 6px; }
.meta-val { font-size: 20px; font-weight: 800; line-height: 1; }
.meta-sub { font-size: 10px; color: var(--text3); font-family: 'JetBrains Mono', monospace; margin-top: 2px; }
.conf-bar-wrap { margin-top: 8px; }
.conf-bar-bg { background: var(--border); border-radius: 3px; height: 4px; overflow: hidden; }
.conf-bar-fill { height: 100%; border-radius: 3px; background: linear-gradient(90deg, var(--green-dim), var(--green)); transition: width 0.6s ease; }

/* Explanation Box */
.explain-box {
  background: rgba(77,184,255,0.04); border: 1px solid rgba(77,184,255,0.15);
  border-left: 3px solid var(--blue); border-radius: 9px;
  padding: 14px 16px; margin-bottom: 16px; animation: slideUp 0.38s ease;
}
.explain-head { display: flex; align-items: center; gap: 7px; margin-bottom: 8px; }
.explain-label { font-size: 9px; font-weight: 700; letter-spacing: 2px; text-transform: uppercase; color: var(--blue); }
.explain-text { font-size: 12px; line-height: 1.75; color: var(--text2); }
.explain-text strong { color: var(--green); }
.explain-text code { background: rgba(0,245,128,0.08); color: var(--green); padding: 1px 5px; border-radius: 3px; font-family: 'JetBrains Mono', monospace; font-size: 10px; }

/* Stats Row */
.stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 16px; }
.stat-card {
  background: var(--card); border: 1px solid var(--border);
  border-radius: 9px; padding: 14px 16px; transition: all 0.2s; animation: slideUp 0.4s ease;
}
.stat-card:hover { border-color: var(--border2); transform: translateY(-2px); }
.sc-label { font-size: 9px; font-weight: 700; letter-spacing: 1.5px; text-transform: uppercase; color: var(--text3); margin-bottom: 5px; }
.sc-val { font-size: 22px; font-weight: 800; line-height: 1; margin-bottom: 2px; }
.sc-sub { font-size: 10px; color: var(--text3); font-family: 'JetBrains Mono', monospace; }
.stat-card:nth-child(1) .sc-val { color: var(--green); }
.stat-card:nth-child(2) .sc-val { color: var(--blue); }
.stat-card:nth-child(3) .sc-val { color: var(--amber); }
.stat-card:nth-child(4) .sc-val { color: var(--purple); }

/* Charts */
.charts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; margin-bottom: 16px; }
.chart-card { background: var(--card); border: 1px solid var(--border); border-radius: 9px; padding: 16px; animation: slideUp 0.42s ease; }
.cc-head { margin-bottom: 12px; }
.cc-title { font-size: 12px; font-weight: 700; color: var(--text2); margin-bottom: 2px; }
.cc-sub { font-size: 10px; color: var(--text3); font-family: 'JetBrains Mono', monospace; }
.cc-wrap { position: relative; height: 180px; }

/* Results Block */
.result-block {
  background: var(--card); border: 1px solid var(--border);
  border-left: 3px solid var(--blue); border-radius: 9px;
  margin-bottom: 16px; overflow: hidden; animation: slideUp 0.44s ease;
}
.rb-head {
  display: flex; align-items: center; justify-content: space-between;
  padding: 10px 14px; border-bottom: 1px solid var(--border);
  background: rgba(77,184,255,0.02);
}
.rb-title { display: flex; align-items: center; gap: 7px; font-size: 13px; font-weight: 700; }
.rb-badge { background: rgba(77,184,255,0.12); color: var(--blue); font-family: 'JetBrains Mono', monospace; font-size: 9px; font-weight: 700; padding: 2px 7px; border-radius: 4px; }
.rb-export {
  background: none; border: 1px solid var(--border); color: var(--text3);
  border-radius: 5px; padding: 3px 9px; font-size: 10px; cursor: pointer;
  font-family: 'JetBrains Mono', monospace; transition: all 0.15s;
}
.rb-export:hover { border-color: var(--green); color: var(--green); }
.tabs { display: flex; border-bottom: 1px solid var(--border); }
.tab {
  padding: 9px 16px; font-size: 11px; font-weight: 700; color: var(--text3);
  cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.15s;
  font-family: 'JetBrains Mono', monospace;
}
.tab:hover { color: var(--text2); }
.tab.active { color: var(--green); border-bottom-color: var(--green); }

/* Table */
.table-wrap { overflow-x: auto; }
table { width: 100%; border-collapse: collapse; }
thead th {
  background: rgba(30,42,54,0.5); padding: 8px 12px; text-align: left;
  font-size: 9px; font-weight: 700; letter-spacing: 1.5px; text-transform: uppercase;
  color: var(--text3); border-bottom: 1px solid var(--border);
  font-family: 'JetBrains Mono', monospace; white-space: nowrap;
}
tbody tr { border-bottom: 1px solid rgba(30,42,54,0.5); transition: background 0.1s; }
tbody tr:hover { background: rgba(0,245,128,0.02); }
tbody tr:last-child { border-bottom: none; }
td { padding: 9px 12px; font-size: 11px; color: var(--text); font-family: 'JetBrains Mono', monospace; white-space: nowrap; }
.badge { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 9px; font-weight: 700; font-family: 'JetBrains Mono', monospace; }
.bg-green { background: rgba(0,245,128,0.1); color: var(--green); }
.bg-red { background: rgba(255,79,79,0.1); color: var(--red); }
.bg-amber { background: rgba(255,179,64,0.1); color: var(--amber); }
.bg-blue { background: rgba(77,184,255,0.1); color: var(--blue); }

/* Pagination */
.pagination {
  display: flex; align-items: center; justify-content: space-between;
  padding: 8px 14px; border-top: 1px solid var(--border);
  font-family: 'JetBrains Mono', monospace; font-size: 10px; color: var(--text3);
}
.page-btns { display: flex; gap: 4px; }
.page-btn {
  background: var(--border); border: none; color: var(--text3);
  border-radius: 4px; padding: 3px 8px; font-size: 10px; cursor: pointer;
  transition: all 0.12s; font-family: 'JetBrains Mono', monospace;
}
.page-btn:hover { background: var(--card2); color: var(--text2); }
.page-btn.active { background: rgba(0,245,128,0.12); color: var(--green); }

/* JSON View */
.json-view {
  font-family: 'JetBrains Mono', monospace; font-size: 11px;
  color: #8fa3b5; line-height: 1.8; max-height: 320px; overflow-y: auto;
  background: rgba(0,0,0,0.15); padding: 14px;
}
.jk { color: #b48eff; } .jstr { color: var(--blue); } .jnum { color: var(--amber); }
.jbool { color: var(--red); } .jnull { color: var(--text3); } .jbr { color: var(--green); }

/* Summary */
.summary-body { padding: 16px; }

/* Logs */
.logs-card {
  background: var(--card); border: 1px solid var(--border);
  border-radius: 9px; overflow: hidden; animation: slideUp 0.5s ease;
}
.lc-head {
  display: flex; align-items: center; justify-content: space-between;
  padding: 10px 14px; border-bottom: 1px solid var(--border);
}
.lc-title { font-size: 11px; font-weight: 700; }
.lc-live { display: flex; align-items: center; gap: 5px; font-size: 9px; color: var(--green); font-family: 'JetBrains Mono', monospace; letter-spacing: 1px; }
.log-body { padding: 8px 14px; max-height: 130px; overflow-y: auto; font-family: 'JetBrains Mono', monospace; font-size: 10px; line-height: 1.9; }
.log-line { display: flex; gap: 10px; animation: fadeIn 0.2s ease; }
.lt { color: var(--text3); } .li { color: var(--blue); } .ls { color: var(--green); }
.lw { color: var(--amber); } .le { color: var(--red); } .lm { color: var(--text2); }

/* Scrollbar */
::-webkit-scrollbar { width: 4px; height: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 2px; }
</style>
</head>
<body>
<div class="blob2"></div>
<div class="app">
  <header>
    <div class="logo">
      <div class="logo-icon">üçÉ</div>
      <div class="logo-text"><span class="m">Mongo</span>Query</div>
    </div>
    <div class="header-center">
      <span style="color:var(--text3)">db.</span><span class="coll" id="hdrColl">employees</span><span style="color:var(--text3)">.find(...)</span>
    </div>
    <div class="header-right">
      <div class="hbadge hbadge-ai">‚ú¶ AI Engine</div>
      <div class="hbadge hbadge-v">v8.0</div>
      <div class="conn-pill"><div class="conn-dot"></div>CONNECTED</div>
      <button onclick="logoutUser()" 
style="background:transparent;border:1px solid #30363d;color:#e6edf3;
padding:5px 10px;border-radius:6px;cursor:pointer;font-size:11px;">
Logout
</button>
    </div>
  </header>

  <div class="workspace">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="sb-sec">
        <div class="sb-label">Navigation</div>
        <div class="nav-item active" onclick="setNav(this)"><span class="ni">‚ö°</span>Query Generator<span class="nav-count">5</span></div>
        <div class="nav-item" onclick="setNav(this)"><span class="ni">üìä</span>Aggregations</div>
        <div class="nav-item" onclick="setNav(this)"><span class="ni">üóÇÔ∏è</span>Collections</div>
        <div class="nav-item" onclick="setNav(this)"><span class="ni">üìã</span>Query History</div>
        <div class="nav-item" onclick="setNav(this)"><span class="ni">‚öôÔ∏è</span>Settings</div>
      </div>
      <hr class="sb-div">
      <div class="sb-sec">
        <div class="sb-label">Collections</div>
        <div class="coll-item active" onclick="selectColl(this,'employees')"><span>üìÅ</span>employees<span class="coll-cnt">1,240</span></div>
        <div class="coll-item" onclick="selectColl(this,'departments')"><span>üìÅ</span>departments<span class="coll-cnt">12</span></div>
        <div class="coll-item" onclick="selectColl(this,'projects')"><span>üìÅ</span>projects<span class="coll-cnt">348</span></div>
        <div class="coll-item" onclick="selectColl(this,'salaries')"><span>üìÅ</span>salaries<span class="coll-cnt">4,820</span></div>
      </div>
      <hr class="sb-div">
      <div class="sb-sec">
        <div class="sb-label">Operation Type</div>
        <div class="op-grid">
          <div class="op-btn active" onclick="selectOp(this)">find()</div>
          <div class="op-btn" onclick="selectOp(this)">aggregate()</div>
          <div class="op-btn" onclick="selectOp(this)">insertOne()</div>
          <div class="op-btn" onclick="selectOp(this)">updateMany()</div>
          <div class="op-btn" onclick="selectOp(this)">deleteOne()</div>
          <div class="op-btn" onclick="selectOp(this)">countDocs()</div>
        </div>
      </div>
      <hr class="sb-div">
      <div class="sb-sec">
        <div class="sb-label">Upload Data File</div>
        <div class="upload-zone" id="uploadZone" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event)">
          <input type="file" id="fileInput" accept=".csv,.xlsx,.xls,.json,.tsv" onchange="handleFileSelect(event)">
          <span class="upload-icon">üìÇ</span>
          <div class="upload-main">Drop file or click</div>
          <div class="upload-sub">Runs on your real data</div>
          <div class="fmt-row"><span class="fmt-tag">CSV</span><span class="fmt-tag">JSON</span><span class="fmt-tag">XLSX</span><span class="fmt-tag">TSV</span></div>
        </div>
        <div class="file-loaded" id="fileLoaded">
          <div class="fl-row">
            <span style="font-size:16px">üìÑ</span>
            <div class="fl-info">
              <div class="fl-name" id="flName">‚Äî</div>
              <div class="fl-meta" id="flMeta">‚Äî</div>
            </div>
            <button class="fl-remove" onclick="removeFile()">‚úï</button>
          </div>
        </div>
      </div>
      <hr class="sb-div">
      <div class="sb-sec">
        <div class="sb-label">Database</div>
        <div class="db-info">
          <div class="db-label">ACTIVE DATABASE</div>
          <div class="db-name" id="dbName">myDatabase</div>
          <div class="db-meta" id="dbMeta">4 collections ¬∑ 6,420 docs</div>
        </div>
      </div>
    </aside>

    <!-- RIGHT -->
    <div class="right-panel">
      <div class="query-area">
        <div class="qa-top">
          <span class="qa-label">Natural Language ‚Üí MongoDB + Real Results</span>
          <div class="coll-pill">üçÉ db.<span id="activeColl">employees</span></div>
        </div>
        <div class="qbox-wrap">
          <input type="text" class="qbox" id="queryInput" placeholder="e.g. Find all employees in Sales with salary over 80000"/>
          <div class="qbox-actions">
            <button class="btn-clr" onclick="clearQuery()">Clear</button>
            <button class="btn-run" onclick="runQuery()">‚ö° Generate + Run</button>
          </div>
        </div>
        <div class="chips" id="exampleChips">
          <span class="chip" onclick="useChip(this)">Find all employees in Sales</span>
          <span class="chip" onclick="useChip(this)">Top 5 highest paid</span>
          <span class="chip" onclick="useChip(this)">Count by department</span>
          <span class="chip" onclick="useChip(this)">Hired after 2020</span>
          <span class="chip" onclick="useChip(this)">Average salary per dept</span>
        </div>

        <!-- Live plain-English explanation below input -->
        <div class="live-explain" id="liveExplain">
          <div class="le-top">
            <div class="le-dot"></div>
            <span class="le-heading">What this query will do</span>
          </div>
          <div class="le-body">
            <div class="le-icon" id="leIcon">üîç</div>
            <div class="le-content">
              <div class="le-sentence" id="leSentence">‚Äî</div>
              <div class="le-tags" id="leTags"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="content" id="content">
        <div class="empty-state" id="emptyState">
          <span class="es-icon">üçÉ</span>
          <div class="es-title">MongoDB Query Generator</div>
          <div class="es-sub">Type a question in plain English above.<br>The AI engine will generate the query and <strong>return real result data</strong>.</div>
        </div>
        <div class="loading" id="loadingState">
          <div class="spinner"></div>
          <span id="loadingMsg">Processing...</span>
        </div>

        <div id="results" style="display:none;">

          <!-- Pipeline -->
          <div class="pipeline">
            <div class="ps" id="ps1"><span class="ps-icon">‚óã</span>Tokenize</div>
            <div class="ps" id="ps2"><span class="ps-icon">‚óã</span>Intent</div>
            <div class="ps" id="ps3"><span class="ps-icon">‚óã</span>Schema Map</div>
            <div class="ps" id="ps4"><span class="ps-icon">‚óã</span>Query Gen</div>
            <div class="ps" id="ps5"><span class="ps-icon">‚óã</span>Optimize</div>
            <div class="ps" id="ps6"><span class="ps-icon">‚óã</span>Execute</div>
          </div>

          <!-- Generated Query -->
          <div class="query-block">
            <div class="qb-head">
              <div class="qb-head-left">
                <span class="qb-method" id="qbMethod">find()</span>
                <span class="qb-op" id="qbOp">db.employees.find(...)</span>
              </div>
              <div class="qb-actions2">
                <button class="qb-copy" onclick="copyQuery()">üìã Copy</button>
              </div>
            </div>
            <div class="qb-body">
              <pre class="qb-code" id="queryOut"></pre>
            </div>
          </div>

          <!-- Explanation (directly below query) -->
          <div class="explain-box" id="explainBox">
            <div class="explain-head">
              <span style="color:var(--blue);font-size:15px">üí°</span>
              <span class="explain-label">Query Explanation</span>
            </div>
            <div class="explain-text" id="explainText">‚Äî</div>
          </div>

          <!-- Confidence + Meta -->
          <div class="meta-row">
            <div class="meta-box">
              <div class="meta-label">Confidence</div>
              <div class="meta-val" id="metaConf" style="color:var(--green)">‚Äî</div>
              <div class="meta-sub">query confidence</div>
              <div class="conf-bar-wrap">
                <div class="conf-bar-bg"><div class="conf-bar-fill" id="confBar" style="width:0%"></div></div>
              </div>
            </div>
            <div class="meta-box">
              <div class="meta-label">Query Plan</div>
              <div class="meta-val" id="metaPlan" style="color:var(--blue);font-size:14px;padding-top:4px">‚Äî</div>
              <div class="meta-sub" id="metaPlanSub">‚Äî</div>
            </div>
            <div class="meta-box">
              <div class="meta-label">Collection</div>
              <div class="meta-val" id="metaColl" style="color:var(--purple);font-size:14px;padding-top:4px">‚Äî</div>
              <div class="meta-sub" id="metaCollSub">‚Äî</div>
            </div>
          </div>

          <!-- Stats -->
          <div class="stats-row">
            <div class="stat-card"><div class="sc-label">Documents</div><div class="sc-val" id="statDocs">‚Äî</div><div class="sc-sub">matched</div></div>
            <div class="stat-card"><div class="sc-label">Fields</div><div class="sc-val" id="statFields">‚Äî</div><div class="sc-sub">per document</div></div>
            <div class="stat-card"><div class="sc-label">Exec Time</div><div class="sc-val" id="statTime">‚Äî</div><div class="sc-sub">milliseconds</div></div>
            <div class="stat-card"><div class="sc-label">Index</div><div class="sc-val" id="statIdx">‚Äî</div><div class="sc-sub">scan type</div></div>
          </div>

          <!-- Charts -->
          <div class="charts-grid">
            <div class="chart-card">
              <div class="cc-head">
                <div class="cc-title">Query Method Distribution</div>
                <div class="cc-sub">Usage this session</div>
              </div>
              <div class="cc-wrap"><canvas id="methodChart"></canvas></div>
            </div>
            <div class="chart-card">
              <div class="cc-head">
                <div class="cc-title">Execution Time History</div>
                <div class="cc-sub">Last 10 queries (ms)</div>
              </div>
              <div class="cc-wrap"><canvas id="timeChart"></canvas></div>
            </div>
          </div>

          <!-- Result Block -->
          <div class="result-block">
            <div class="rb-head">
              <div class="rb-title">
                <span>‚ú¶</span>
                <span>Query Results</span>
                <span class="rb-badge" id="resultBadge">AI Executed</span>
              </div>
              <button class="rb-export" onclick="exportResults()">‚¨á Export JSON</button>
            </div>
            <div class="tabs">
              <div class="tab active" onclick="switchTab('table',this)">üìã Table</div>
              <div class="tab" onclick="switchTab('json',this)">{ } JSON</div>
              <div class="tab" onclick="switchTab('summary',this)">üí° Summary</div>
            </div>
            <div id="tabTable">
              <div class="table-wrap"><table><thead id="tHead"></thead><tbody id="tBody"></tbody></table></div>
              <div class="pagination">
                <span id="pageInfo">0 documents</span>
                <div class="page-btns" id="pageBtns"></div>
              </div>
            </div>
            <div id="tabJson" style="display:none"><div class="json-view" id="jsonView"></div></div>
            <div id="tabSummary" style="display:none"><div class="summary-body" id="summaryView"></div></div>
          </div>

          <!-- Log -->
          <div class="logs-card">
            <div class="lc-head">
              <span class="lc-title">Execution Log</span>
              <span class="lc-live"><span class="conn-dot" style="width:5px;height:5px;box-shadow:none"></span>LIVE</span>
            </div>
            <div class="log-body" id="logBody"></div>
          </div>

        </div><!-- /results -->
      </div><!-- /content -->
    </div><!-- /right-panel -->
  </div><!-- /workspace -->
</div><!-- /app -->

<script>
// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ
let methodChart=null, timeChart=null;
const timeHistory=[22,14,31,18,40,12,27,19,35,16];
const methodCounts={find:6,aggregate:3,insert:1,update:1};
let uploadedFile=null, activeColl='employees';
let currentResultDocs=[];
const PAGE_SIZE=10;

// ‚îÄ‚îÄ DEFAULT DATASET ‚îÄ‚îÄ
const DEFAULT_DATA=[
  {employee_id:"E001",name:"Alice Johnson",department:"Sales",salary:82000,hire_date:"2019-03-12",status:"active",age:34},
  {employee_id:"E002",name:"Ben Torres",department:"Engineering",salary:115000,hire_date:"2018-07-22",status:"active",age:29},
  {employee_id:"E003",name:"Chloe Kim",department:"Marketing",salary:78000,hire_date:"2020-01-15",status:"active",age:31},
  {employee_id:"E004",name:"Bob Martinez",department:"Sales",salary:74500,hire_date:"2021-07-08",status:"active",age:27},
  {employee_id:"E005",name:"Diana Roy",department:"Engineering",salary:132000,hire_date:"2016-11-03",status:"active",age:38},
  {employee_id:"E006",name:"Ethan Park",department:"Finance",salary:95000,hire_date:"2019-09-18",status:"active",age:33},
  {employee_id:"E007",name:"Fiona Chen",department:"Operations",salary:67000,hire_date:"2022-03-27",status:"active",age:26},
  {employee_id:"E008",name:"George Hall",department:"Management",salary:145000,hire_date:"2014-06-11",status:"active",age:45},
  {employee_id:"E009",name:"Hannah Lee",department:"Engineering",salary:121000,hire_date:"2017-02-28",status:"on-leave",age:35},
  {employee_id:"E010",name:"Ivan Patel",department:"Sales",salary:68000,hire_date:"2023-05-09",status:"active",age:24},
  {employee_id:"E011",name:"Carol White",department:"Sales",salary:91200,hire_date:"2018-01-23",status:"active",age:36},
  {employee_id:"E012",name:"Julia Adams",department:"Marketing",salary:82500,hire_date:"2020-08-14",status:"active",age:30},
  {employee_id:"E013",name:"Kevin Brown",department:"Engineering",salary:138500,hire_date:"2015-04-17",status:"active",age:40},
  {employee_id:"E014",name:"Laura Nguyen",department:"Finance",salary:88000,hire_date:"2021-12-01",status:"active",age:28},
  {employee_id:"E015",name:"David Lee",department:"Sales",salary:68000,hire_date:"2022-11-01",status:"active",age:25},
  {employee_id:"E016",name:"Maria Lopez",department:"Operations",salary:72000,hire_date:"2019-06-30",status:"active",age:32},
  {employee_id:"E017",name:"Nathan Clark",department:"Engineering",salary:109000,hire_date:"2018-10-05",status:"active",age:37},
  {employee_id:"E018",name:"Olivia Wright",department:"Management",salary:128000,hire_date:"2016-03-22",status:"active",age:42},
  {employee_id:"E019",name:"Paul Scott",department:"Finance",salary:97500,hire_date:"2020-04-10",status:"inactive",age:44},
  {employee_id:"E020",name:"Quinn Evans",department:"Marketing",salary:76000,hire_date:"2022-07-19",status:"active",age:29},
  {employee_id:"E021",name:"Rachel Green",department:"Operations",salary:63000,hire_date:"2023-01-11",status:"active",age:23},
  {employee_id:"E022",name:"Emma Davis",department:"Sales",salary:79800,hire_date:"2020-05-17",status:"on-leave",age:31},
  {employee_id:"E023",name:"Sam Turner",department:"Engineering",salary:125000,hire_date:"2017-08-09",status:"active",age:39},
  {employee_id:"E024",name:"Tara Mitchell",department:"Finance",salary:91000,hire_date:"2019-11-14",status:"active",age:34},
  {employee_id:"E025",name:"Uma Sharma",department:"Marketing",salary:85000,hire_date:"2021-02-25",status:"active",age:28},
  {employee_id:"E031",name:"Frank Kim",department:"Sales",salary:88400,hire_date:"2017-09-30",status:"active",age:41},
  {employee_id:"E038",name:"Grace Patel",department:"Sales",salary:72100,hire_date:"2023-02-14",status:"active",age:24},
  {employee_id:"E042",name:"Hiro Tanaka",department:"Sales",salary:83600,hire_date:"2019-11-22",status:"active",age:33},
  {employee_id:"E056",name:"James Wilson",department:"Engineering",salary:127300,hire_date:"2016-07-15",status:"active",age:43},
  {employee_id:"E067",name:"Olivia Brown",department:"Operations",salary:69000,hire_date:"2021-09-28",status:"active",age:27},
  {employee_id:"E069",name:"Lisa Park",department:"Finance",salary:121000,hire_date:"2016-05-03",status:"active",age:41},
  {employee_id:"E074",name:"Liam Chen",department:"Finance",salary:84000,hire_date:"2022-04-19",status:"active",age:26},
  {employee_id:"E077",name:"Michael Scott",department:"Management",salary:145000,hire_date:"2013-09-01",status:"active",age:50},
  {employee_id:"E082",name:"Mia Turner",department:"Marketing",salary:80000,hire_date:"2022-10-05",status:"active",age:25},
  {employee_id:"E091",name:"Noah Adams",department:"Engineering",salary:98000,hire_date:"2023-08-14",status:"active",age:23},
];

// ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ
const sleep = ms => new Promise(r=>setTimeout(r,ms));
function useChip(el){ document.getElementById('queryInput').value=el.textContent; updateLiveExplain(); }
function setNav(el){ document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active')); el.classList.add('active'); }
function selectColl(el,name){
  document.querySelectorAll('.coll-item').forEach(c=>c.classList.remove('active'));
  el.classList.add('active'); activeColl=name;
  document.getElementById('activeColl').textContent=name;
  document.getElementById('hdrColl').textContent=name;
}
function selectOp(el){ document.querySelectorAll('.op-btn').forEach(b=>b.classList.remove('active')); el.classList.add('active'); }
function clearQuery(){
  document.getElementById('queryInput').value='';
  document.getElementById('liveExplain').style.display='none';
  document.getElementById('emptyState').style.display='block';
  document.getElementById('results').style.display='none';
  document.getElementById('loadingState').style.display='none';
}
function copyQuery(){
  navigator.clipboard.writeText(document.getElementById('queryOut').innerText).catch(()=>{});
  const b=document.querySelector('.qb-copy'); b.textContent='‚úì Copied'; setTimeout(()=>b.textContent='üìã Copy',1500);
}
function switchTab(tab,el){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active')); el.classList.add('active');
  document.getElementById('tabTable').style.display=tab==='table'?'block':'none';
  document.getElementById('tabJson').style.display=tab==='json'?'block':'none';
  document.getElementById('tabSummary').style.display=tab==='summary'?'block':'none';
}
function exportResults(){
  const blob=new Blob([JSON.stringify(currentResultDocs,null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='query_results.json'; a.click();
}
function addLog(type,msg){
  const lb=document.getElementById('logBody');
  const d=document.createElement('div'); d.className='log-line';
  const t=new Date().toTimeString().slice(0,8);
  d.innerHTML=`<span class="lt">${t}</span><span class="l${type}">[${type.toUpperCase()}]</span><span class="lm">${msg}</span>`;
  lb.appendChild(d); lb.scrollTop=lb.scrollHeight;
}

// ‚îÄ‚îÄ FILE UPLOAD ‚îÄ‚îÄ
function handleDragOver(e){ e.preventDefault(); document.getElementById('uploadZone').classList.add('drag-over'); }
function handleDragLeave(){ document.getElementById('uploadZone').classList.remove('drag-over'); }
function handleDrop(e){ e.preventDefault(); document.getElementById('uploadZone').classList.remove('drag-over'); const f=e.dataTransfer.files[0]; if(f)processFile(f); }
function handleFileSelect(e){ const f=e.target.files[0]; if(f)processFile(f); }
function processFile(file){
  const ext=file.name.split('.').pop().toLowerCase();
  if(!['csv','tsv','json','xlsx','xls'].includes(ext)){alert('Unsupported format.');return;}
  const reader=new FileReader();
  reader.onload=(e)=>{
    let parsed;
    try{
      if(ext==='json') parsed=parseJSON(e.target.result);
      else if(ext==='csv'||ext==='tsv') parsed=parseCSV(e.target.result,ext==='tsv'?'\t':',');
      else parsed={headers:['[XLSX]'],rows:[],rowCount:'?',docs:[]};
    }catch(err){parsed={headers:['error'],rows:[[err.message]],rowCount:0,docs:[]};}
    const sz=file.size>1048576?(file.size/1048576).toFixed(1)+' MB':(file.size/1024).toFixed(1)+' KB';
    uploadedFile={name:file.name,size:sz,ext:ext.toUpperCase(),rows:parsed.rowCount,cols:parsed.headers.length,headers:parsed.headers,docs:parsed.docs};
    showFileLoaded();
  };
  if(ext==='xlsx'||ext==='xls') reader.readAsArrayBuffer(file); else reader.readAsText(file);
}
function parseCSV(text,delim=','){
  const lines=text.trim().split('\n').filter(l=>l.trim());
  if(!lines.length)return{headers:[],rows:[],rowCount:0,docs:[]};
  const headers=lines[0].split(delim).map(h=>h.trim().replace(/^"|"$/g,''));
  const rows=lines.slice(1).map(l=>l.split(delim).map(c=>c.trim().replace(/^"|"$/g,'')));
  const docs=rows.map(r=>{const o={};headers.forEach((h,i)=>{const v=r[i]||'';o[h]=v!==''&&!isNaN(v)?Number(v):v;});return o;});
  return{headers,rows,rowCount:rows.length,docs};
}
function parseJSON(text){
  const data=JSON.parse(text);
  const arr=Array.isArray(data)?data:(data.data||data.records||Object.values(data)[0]||[]);
  if(!arr.length)return{headers:[],rows:[],rowCount:0,docs:[]};
  const headers=Object.keys(arr[0]);
  const rows=arr.map(obj=>headers.map(h=>String(obj[h]??'')));
  return{headers,rows,rowCount:rows.length,docs:arr};
}
function showFileLoaded(){
  const fd=uploadedFile;
  document.getElementById('flName').textContent=fd.name;
  document.getElementById('flMeta').textContent=`${fd.ext} ¬∑ ${fd.rows} docs ¬∑ ${fd.cols} fields ¬∑ ${fd.size}`;
  document.getElementById('fileLoaded').style.display='block';
  const collName=fd.name.replace(/\.[^.]+$/,'').replace(/[^a-zA-Z0-9_]/g,'_');
  activeColl=collName;
  document.getElementById('activeColl').textContent=collName;
  document.getElementById('hdrColl').textContent=collName;
  document.getElementById('dbName').textContent='uploadedDB';
  document.getElementById('dbMeta').textContent=`1 collection ¬∑ ${fd.rows} docs`;
}
function removeFile(){
  uploadedFile=null;
  document.getElementById('fileLoaded').style.display='none';
  document.getElementById('fileInput').value='';
  activeColl='employees';
  document.getElementById('activeColl').textContent='employees';
  document.getElementById('hdrColl').textContent='employees';
  document.getElementById('dbName').textContent='myDatabase';
  document.getElementById('dbMeta').textContent='4 collections ¬∑ 6,420 docs';
}

// ‚îÄ‚îÄ TABLE ‚îÄ‚îÄ
function renderTable(docs,page=0){
  const start=page*PAGE_SIZE, end=Math.min(start+PAGE_SIZE,docs.length);
  const pageDocs=docs.slice(start,end);
  if(!pageDocs.length){
    document.getElementById('tHead').innerHTML='';
    document.getElementById('tBody').innerHTML='<tr><td style="color:var(--text3);text-align:center;padding:24px;font-family:JetBrains Mono,monospace;font-size:11px;" colspan="99">No documents matched</td></tr>';
    document.getElementById('pageInfo').textContent='0 documents';
    document.getElementById('pageBtns').innerHTML='';
    return;
  }
  const keys=Object.keys(pageDocs[0]);
  document.getElementById('tHead').innerHTML='<tr>'+keys.map(k=>`<th>${k}</th>`).join('')+'</tr>';
  const tbody=document.getElementById('tBody'); tbody.innerHTML='';
  pageDocs.forEach(doc=>{
    const tr=document.createElement('tr');
    tr.innerHTML=keys.map(k=>{
      const v=doc[k];
      if(v===null||v===undefined)return`<td><span style="color:var(--text3)">null</span></td>`;
      if(typeof v==='object')return`<td><span style="color:var(--text3);font-size:10px">{...}</span></td>`;
      const s=String(v);
      if(s==='active')return`<td><span class="badge bg-green">active</span></td>`;
      if(s==='inactive')return`<td><span class="badge bg-red">inactive</span></td>`;
      if(s==='on-leave')return`<td><span class="badge bg-amber">on-leave</span></td>`;
      if(s==='true'||v===true)return`<td><span class="badge bg-blue">true</span></td>`;
      if(s==='false'||v===false)return`<td><span class="badge bg-red">false</span></td>`;
      return`<td>${s}</td>`;
    }).join('');
    tbody.appendChild(tr);
  });
  document.getElementById('pageInfo').textContent=`Showing ${start+1}‚Äì${end} of ${docs.length} docs`;
  const total=Math.ceil(docs.length/PAGE_SIZE);
  document.getElementById('pageBtns').innerHTML=Array.from({length:total},(_,i)=>`<button class="page-btn${i===page?' active':''}" onclick="renderTable(currentResultDocs,${i})">${i+1}</button>`).join('');
}

// ‚îÄ‚îÄ JSON VIEW ‚îÄ‚îÄ
function renderJSON(docs){
  const str=JSON.stringify(docs.slice(0,30),null,2);
  document.getElementById('jsonView').innerHTML=str
    .replace(/("[\w$_][\w\d$_]*")\s*:/g,'<span class="jk">$1</span>:')
    .replace(/:\s*("(?:[^"\\]|\\.)*")/g,(m,s)=>`: <span class="jstr">${s}</span>`)
    .replace(/:\s*(-?\d+\.?\d*)/g,(m,n)=>`: <span class="jnum">${n}</span>`)
    .replace(/:\s*(true|false)/g,(m,b)=>`: <span class="jbool">${b}</span>`)
    .replace(/:\s*(null)/g,`: <span class="jnull">null</span>`)
    .replace(/([{}\[\]])/g,'<span class="jbr">$1</span>');
}

// ‚îÄ‚îÄ LOCAL ENGINE ‚îÄ‚îÄ
function localExecute(query,data,coll){
  const q=query.toLowerCase(); let results=[...data];
  const depts=['sales','engineering','finance','marketing','operations','management'];
  for(const d of depts){if(q.includes(d)){results=results.filter(r=>(r.department||'').toLowerCase()===d);break;}}
  if(q.includes('active')&&!q.includes('inactive')) results=results.filter(r=>r.status==='active');
  if(q.includes('inactive')) results=results.filter(r=>r.status==='inactive');
  if(q.includes('on-leave')||q.includes('leave')) results=results.filter(r=>r.status==='on-leave');
  const yr=q.match(/after (\d{4})/); if(yr) results=results.filter(r=>(r.hire_date||'')>yr[1]);
  const salOver=q.match(/salary\s*(?:over|above|greater|>)\s*(\d+)/); if(salOver) results=results.filter(r=>(r.salary||0)>parseInt(salOver[1]));
  const salUnder=q.match(/salary\s*(?:under|below|less|<)\s*(\d+)/); if(salUnder) results=results.filter(r=>(r.salary||0)<parseInt(salUnder[1]));
  if(q.includes('highest paid')||q.includes('top salary')) results.sort((a,b)=>(b.salary||0)-(a.salary||0));
  if(q.includes('lowest paid')) results.sort((a,b)=>(a.salary||0)-(b.salary||0));
  const topM=q.match(/top\s+(\d+)/); if(topM) results=results.slice(0,parseInt(topM[1]));
  let method='find()';
  if(q.includes('count by')||q.includes('group by dept')){
    const g={};data.forEach(d=>{const k=d.department||'Unknown';g[k]=(g[k]||0)+1;});
    results=Object.entries(g).map(([_id,count])=>({_id,count})).sort((a,b)=>b.count-a.count);
    method='aggregate()';
  }
  if(q.includes('average salary')||q.includes('avg salary')){
    const g={},ct={};
    data.forEach(d=>{const k=d.department||'Unknown';g[k]=(g[k]||0)+(d.salary||0);ct[k]=(ct[k]||0)+1;});
    results=Object.entries(g).map(([_id,t])=>({_id,avg_salary:Math.round(t/ct[_id]),count:ct[_id]})).sort((a,b)=>b.avg_salary-a.avg_salary);
    method='aggregate()';
  }
  const dept=depts.find(d=>q.includes(d));
  const mqFilter=dept?`department:"${dept.charAt(0).toUpperCase()+dept.slice(1)}"`:salOver?`salary:{$gt:${salOver[1]}}`:'{}';
  const mongoQuery=method.startsWith('agg')
    ?`db.${coll}.aggregate([\n  { $group: { _id: "$department", count: { $sum: 1 } } },\n  { $sort: { count: -1 } }\n])`
    :`db.${coll}.find({ ${mqFilter} })${q.includes('highest')?'.sort({ salary: -1 })':''}`;
  return{
    mongo_query: mongoQuery, method, index: results.length<data.length?'IXSCAN':'COLLSCAN',
    confidence: 88,
    query_plan: `${method.startsWith('agg')?'Group + Sort':'Filter + Fetch'} ‚Üí ${results.length} docs`,
    results,
    explanation: `This query filters the <code>${coll}</code> collection${dept?` for <strong>${dept.charAt(0).toUpperCase()+dept.slice(1)}</strong> department employees`:''}${salOver?` with salary <strong>over $${parseInt(salOver[1]).toLocaleString()}</strong>`:''}${yr?` hired <strong>after ${yr[1]}</strong>`:''}.${results.length>0&&results[0].salary?` Results are sorted by salary descending. Salary range in results: <strong>$${Math.min(...results.filter(r=>r.salary).map(r=>r.salary)).toLocaleString()} ‚Äì $${Math.max(...results.filter(r=>r.salary).map(r=>r.salary)).toLocaleString()}</strong>.`:''}`,
    summary: `Found <strong>${results.length}</strong> document${results.length!==1?'s':''} from <code>${coll}</code> (${data.length} total).${results.length>0&&results[0].salary?` Salary range: $${Math.min(...results.filter(r=>r.salary).map(r=>r.salary)).toLocaleString()} ‚Äì $${Math.max(...results.filter(r=>r.salary).map(r=>r.salary)).toLocaleString()}.`:''}`
  };
}

// ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ
async function runQuery(){
  const raw=document.getElementById('queryInput').value.trim();
  if(!raw)return;
  document.getElementById('emptyState').style.display='none';
  document.getElementById('results').style.display='none';
  document.getElementById('loadingState').style.display='flex';
  for(let i=1;i<=6;i++){const p=document.getElementById('ps'+i);p.className='ps';p.querySelector('.ps-icon').textContent='‚óã';}
  const steps=["Tokenizing input...","Detecting intent...","Mapping schema...","Generating MongoDB query...","Optimizing execution plan...","Executing query..."];
  for(let i=0;i<steps.length;i++){
    document.getElementById('loadingMsg').textContent=steps[i];
    const p=document.getElementById('ps'+(i+1)); p.className='ps active'; p.querySelector('.ps-icon').textContent='‚ü≥';
    await sleep(180);
    p.className='ps done'; p.querySelector('.ps-icon').textContent='‚úì';
  }
  document.getElementById('loadingState').style.display='none';
  document.getElementById('results').style.display='block';
  document.getElementById('logBody').innerHTML='';
  addLog('i',`Query: "${raw.slice(0,60)}"`);
    addLog('i',`Collection: ${activeColl} ¬∑ ${uploadedFile?uploadedFile.name:'built-in dataset (35 docs)'}`);
  addLog('i','Generating query + executing...');

  const dataset=uploadedFile?uploadedFile.docs:DEFAULT_DATA;
  const t0=Date.now();
  let aiResult=null;

  try{
    const resp=await fetch("https://api.anthropic.com/v1/messages",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({
        model:"claude-sonnet-4-20250514",
        max_tokens:2500,
        system:`You are a MongoDB query execution engine. Given a natural language request and JSON dataset:
1. Write the correct MongoDB query
2. Execute it mentally against the data
3. Return real matching/computed result documents
4. Provide a confidence score (0-100)
5. Provide a plain English explanation with HTML tags (strong, code)
6. Provide a brief summary

Respond ONLY with valid JSON (no markdown):
{
  "mongo_query": "full db.collection.find({}) or aggregate([...]) string",
  "method": "find() or aggregate()",
  "index": "IXSCAN or COLLSCAN",
  "confidence": 95,
  "query_plan": "short description of execution plan",
  "results": [...actual result documents...],
  "explanation": "HTML explanation with <strong> and <code> tags",
  "summary": "plain text summary"
}`,
        messages:[{role:"user",content:`Natural language: "${raw}"\nCollection: ${activeColl}\nDataset (${dataset.length} docs):\n${JSON.stringify(dataset.slice(0,120))}`}]
      })
    });
    const d=await resp.json();
    const txt=d.content?.map(c=>c.text||'').join('')||'';
    aiResult=JSON.parse(txt.replace(/```json|```/g,'').trim());
    document.getElementById('resultBadge').textContent='AI Executed';
    addLog('s',`Engine returned ${aiResult.results?.length||0} documents`);
  }catch(err){
    addLog('w',`AI unavailable (${err.message.slice(0,40)}) ‚Äî local engine`);
    aiResult=localExecute(raw,dataset,activeColl);
    document.getElementById('resultBadge').textContent='Local Engine';
    addLog('s',`Local engine: ${aiResult.results.length} docs`);
  }

  const execMs=Date.now()-t0;
  currentResultDocs=aiResult.results||[];
  const numFields=currentResultDocs.length>0?Object.keys(currentResultDocs[0]).length:0;
  const conf=aiResult.confidence||88;

  // Stats
  document.getElementById('statDocs').textContent=currentResultDocs.length;
  document.getElementById('statFields').textContent=numFields;
  document.getElementById('statTime').textContent=execMs+'ms';
  document.getElementById('statIdx').textContent=aiResult.index||'COLLSCAN';

  // Meta row
  document.getElementById('metaConf').textContent=conf+'%';
  document.getElementById('confBar').style.width=conf+'%';
  document.getElementById('confBar').style.background=conf>=90?'linear-gradient(90deg,#00c060,#00f580)':conf>=70?'linear-gradient(90deg,#ffb340,#ffcc70)':'linear-gradient(90deg,#ff4f4f,#ff8080)';
  document.getElementById('metaConf').style.color=conf>=90?'var(--green)':conf>=70?'var(--amber)':'var(--red)';
  document.getElementById('metaPlan').textContent=aiResult.query_plan||'Filter + Fetch';
  document.getElementById('metaPlanSub').textContent=(aiResult.method||'find()')+' ¬∑ '+dataset.length+' docs scanned';
  document.getElementById('metaColl').textContent=activeColl;
  document.getElementById('metaCollSub').textContent=dataset.length+' total docs';

  // Query display
  document.getElementById('qbMethod').textContent=aiResult.method||'find()';
  document.getElementById('qbOp').textContent=(aiResult.mongo_query||`db.${activeColl}.find(...)`).slice(0,70);
  document.getElementById('queryOut').textContent=aiResult.mongo_query||'// Generated by Claude AI';

  // Explanation
  document.getElementById('explainText').innerHTML=aiResult.explanation||`Query executed against <code>${activeColl}</code> collection.`;

  // Render views
  renderTable(currentResultDocs,0);
  renderJSON(currentResultDocs);

  // Summary tab
  const salaries=currentResultDocs.filter(d=>d.salary).map(d=>d.salary);
  const avgSal=salaries.length?Math.round(salaries.reduce((a,b)=>a+b,0)/salaries.length):null;
  const summaryText=aiResult.summary||`Found ${currentResultDocs.length} documents.`;
  document.getElementById('summaryView').innerHTML=`
    <div style="display:flex;gap:12px;align-items:flex-start;margin-bottom:16px;">
      <span style="font-size:26px;flex-shrink:0">‚ú¶</span>
      <div>
        <div style="font-size:9px;font-weight:700;color:var(--green);font-family:'JetBrains Mono',monospace;letter-spacing:2px;margin-bottom:6px">QUERY RESULT SUMMARY</div>
        <div style="font-size:13px;color:var(--text2);line-height:1.8">${summaryText.replace(/\*\*(.*?)\*\*/g,'<strong style="color:var(--green)">$1</strong>').replace(/\`(.*?)\`/g,'<code style="background:rgba(0,245,128,0.08);color:var(--green);padding:1px 5px;border-radius:3px;font-family:JetBrains Mono,monospace;font-size:10px">$1</code>')}</div>
      </div>
    </div>
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px">
      <div style="background:rgba(0,245,128,0.05);border:1px solid rgba(0,245,128,0.12);border-radius:8px;padding:12px">
        <div style="font-size:9px;color:var(--text3);font-weight:700;letter-spacing:1.5px;margin-bottom:3px">DOCS MATCHED</div>
        <div style="font-size:24px;font-weight:800;color:var(--green)">${currentResultDocs.length}</div>
        <div style="font-size:10px;color:var(--text3);font-family:'JetBrains Mono',monospace">of ${dataset.length} total</div>
      </div>
      <div style="background:rgba(77,184,255,0.05);border:1px solid rgba(77,184,255,0.12);border-radius:8px;padding:12px">
        <div style="font-size:9px;color:var(--text3);font-weight:700;letter-spacing:1.5px;margin-bottom:3px">FIELDS</div>
        <div style="font-size:24px;font-weight:800;color:var(--blue)">${numFields}</div>
        <div style="font-size:10px;color:var(--text3);font-family:'JetBrains Mono',monospace">per document</div>
      </div>
      <div style="background:rgba(255,179,64,0.05);border:1px solid rgba(255,179,64,0.12);border-radius:8px;padding:12px">
        <div style="font-size:9px;color:var(--text3);font-weight:700;letter-spacing:1.5px;margin-bottom:3px">${avgSal?'AVG SALARY':'EXEC TIME'}</div>
        <div style="font-size:24px;font-weight:800;color:var(--amber)">${avgSal?'$'+avgSal.toLocaleString():execMs+'ms'}</div>
        <div style="font-size:10px;color:var(--text3);font-family:'JetBrains Mono',monospace">${avgSal?'across results':'query runtime'}</div>
      </div>
    </div>`;

  // Charts
  if((aiResult.method||'').startsWith('agg')) methodCounts.aggregate++; else methodCounts.find++;
  timeHistory.push(execMs); timeHistory.shift();
  buildCharts();

  addLog('s',`Done ‚Äî ${currentResultDocs.length} docs ¬∑ ${numFields} fields ¬∑ ${execMs}ms ¬∑ confidence ${conf}%`);
  document.getElementById('content').scrollTop=0;
}

function buildCharts(){
  Chart.defaults.color='#4d6070';
  Chart.defaults.font.family="'JetBrains Mono', monospace";
  Chart.defaults.font.size=10;
  if(methodChart) methodChart.destroy();
  if(timeChart) timeChart.destroy();
  const gc='rgba(30,42,54,0.8)';
  methodChart=new Chart(document.getElementById('methodChart'),{
    type:'doughnut',
    data:{
      labels:['find()','aggregate()','insert()','update()'],
      datasets:[{
        data:[methodCounts.find,methodCounts.aggregate,methodCounts.insert,methodCounts.update],
        backgroundColor:['rgba(0,245,128,0.65)','rgba(77,184,255,0.65)','rgba(255,179,64,0.65)','rgba(180,142,255,0.65)'],
        borderColor:['#00f580','#4db8ff','#ffb340','#b48eff'],
        borderWidth:1
      }]
    },
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'right',labels:{boxWidth:10,padding:12,color:'#8fa3b5'}}},cutout:'65%'}
  });
  timeChart=new Chart(document.getElementById('timeChart'),{
    type:'line',
    data:{
      labels:timeHistory.map((_,i)=>'Q'+(i+1)),
      datasets:[{
        data:timeHistory,
        borderColor:'#00f580',
        backgroundColor:'rgba(0,245,128,0.06)',
        fill:true, tension:0.4,
        pointBackgroundColor:'#00f580',
        pointRadius:3, borderWidth:2
      }]
    },
    options:{
      responsive:true, maintainAspectRatio:false,
      plugins:{legend:{display:false}},
      scales:{
        y:{grid:{color:gc},ticks:{callback:v=>v+'ms',color:'#4d6070'}},
        x:{grid:{display:false},ticks:{color:'#4d6070'}}
      }
    }
  });
}

document.getElementById('queryInput').addEventListener('keydown',e=>{ if(e.key==='Enter') runQuery(); });
document.getElementById('queryInput').addEventListener('input', updateLiveExplain);

// ‚îÄ‚îÄ LIVE PLAIN-ENGLISH EXPLAIN ‚îÄ‚îÄ
function updateLiveExplain() {
  const raw = document.getElementById('queryInput').value.trim();
  const box = document.getElementById('liveExplain');
  if (!raw) { box.style.display = 'none'; return; }
  box.style.display = 'block';

  const q = raw.toLowerCase();
  const coll = activeColl || 'employees';

  // Detect intent parts
  const depts = ['sales','engineering','finance','marketing','operations','management'];
  const dept = depts.find(d => q.includes(d));
  const salOver = q.match(/(?:salary|earn|paid).*?(?:over|above|greater than|more than|>)\s*\$?([\d,]+)/);
  const salUnder = q.match(/(?:salary|earn|paid).*?(?:under|below|less than|<)\s*\$?([\d,]+)/);
  const topN = q.match(/top\s+(\d+)/);
  const afterYear = q.match(/after\s+(20\d{2}|19\d{2})/);
  const beforeYear = q.match(/before\s+(20\d{2}|19\d{2})/);
  const isCount = q.includes('count') || q.includes('how many');
  const isAvg = q.includes('average') || q.includes('avg') || q.includes('mean');
  const isGroup = q.includes('group') || q.includes('per dept') || q.includes('by department') || q.includes('by dept') || (isAvg && q.includes('dept'));
  const isSort = q.includes('highest') || q.includes('lowest') || q.includes('top') || q.includes('sort') || q.includes('order') || q.includes('rank');
  const isActive = q.includes('active') && !q.includes('inactive');
  const isInactive = q.includes('inactive');
  const isOnLeave = q.includes('on-leave') || q.includes('on leave') || q.includes('leave');
  const isAll = !dept && !salOver && !salUnder && !afterYear && !beforeYear && !isActive && !isInactive && !isOnLeave && !topN;
  const nameMatch = q.match(/named?\s+([a-z]+)/);

  // Build sentence parts
  let icon = 'üîç';
  let parts = [];
  let tags = [];

  // Action
  if (isCount && isGroup) {
    icon = 'üìä';
    parts.push(`Count how many people are in <mark>each department</mark>`);
    tags.push({ cls:'action', icon:'üìä', label:'Count + Group' });
  } else if (isAvg && isGroup) {
    icon = 'üìä';
    parts.push(`Calculate the <mark>average salary</mark> for people in <mark>each department</mark>`);
    tags.push({ cls:'action', icon:'üìä', label:'Average + Group' });
  } else if (isCount) {
    icon = 'üî¢';
    parts.push(`Count the total number of people`);
    tags.push({ cls:'action', icon:'üî¢', label:'Count' });
  } else if (isGroup) {
    icon = 'üìä';
    parts.push(`Group people by <mark>department</mark> and show a summary`);
    tags.push({ cls:'action', icon:'üìä', label:'Group By' });
  } else if (topN) {
    icon = 'üèÜ';
    parts.push(`Find the <mark>top ${topN[1]}</mark> people`);
    tags.push({ cls:'action', icon:'üîç', label:`Top ${topN[1]} only` });
    tags.push({ cls:'limit', icon:'‚¨Ü', label:`Limit: ${topN[1]}` });
  } else if (isAll) {
    icon = 'üìã';
    parts.push(`Show <mark>everyone</mark> in the <em>${coll}</em> table`);
    tags.push({ cls:'action', icon:'üìã', label:'Show All' });
  } else {
    icon = 'üîç';
    parts.push(`Find people`);
    tags.push({ cls:'action', icon:'üîç', label:'Find' });
  }

  // Filters
  const filters = [];
  if (dept) {
    filters.push(`who work in <mark>${dept.charAt(0).toUpperCase()+dept.slice(1)}</mark>`);
    tags.push({ cls:'filter', icon:'üè¢', label: dept.charAt(0).toUpperCase()+dept.slice(1) });
  }
  if (salOver) {
    const amt = parseInt(salOver[1].replace(/,/g,''));
    filters.push(`who earn more than <mark>$${amt.toLocaleString()}</mark> per year`);
    tags.push({ cls:'filter', icon:'üí∞', label:`Salary > $${amt.toLocaleString()}` });
  }
  if (salUnder) {
    const amt = parseInt(salUnder[1].replace(/,/g,''));
    filters.push(`who earn less than <mark>$${amt.toLocaleString()}</mark> per year`);
    tags.push({ cls:'filter', icon:'üí∞', label:`Salary < $${amt.toLocaleString()}` });
  }
  if (afterYear) {
    filters.push(`who joined <mark>after ${afterYear[1]}</mark>`);
    tags.push({ cls:'filter', icon:'üìÖ', label:`After ${afterYear[1]}` });
  }
  if (beforeYear) {
    filters.push(`who joined <mark>before ${beforeYear[1]}</mark>`);
    tags.push({ cls:'filter', icon:'üìÖ', label:`Before ${beforeYear[1]}` });
  }
  if (isActive) {
    filters.push(`who are currently <mark>active</mark>`);
    tags.push({ cls:'filter', icon:'‚úÖ', label:'Active only' });
  }
  if (isInactive) {
    filters.push(`who are <mark>no longer active</mark>`);
    tags.push({ cls:'filter', icon:'‚õî', label:'Inactive only' });
  }
  if (isOnLeave) {
    filters.push(`who are <mark>on leave</mark>`);
    tags.push({ cls:'filter', icon:'üèñ', label:'On leave' });
  }
  if (nameMatch) {
    filters.push(`named <mark>${nameMatch[1].charAt(0).toUpperCase()+nameMatch[1].slice(1)}</mark>`);
    tags.push({ cls:'filter', icon:'üë§', label:nameMatch[1] });
  }

  if (filters.length) {
    parts[0] += ' ' + filters.join(' and ');
  }

  // Sorting
  if (q.includes('highest') || (q.includes('top') && q.includes('paid')) || q.includes('most paid')) {
    parts.push(`, sorted from <mark>highest salary to lowest</mark>`);
    tags.push({ cls:'sort', icon:'‚Üï', label:'Sort: Salary ‚Üì' });
  } else if (q.includes('lowest') || q.includes('least paid')) {
    parts.push(`, sorted from <mark>lowest salary to highest</mark>`);
    tags.push({ cls:'sort', icon:'‚Üï', label:'Sort: Salary ‚Üë' });
  } else if (q.includes('newest') || q.includes('recently hired') || q.includes('latest')) {
    parts.push(`, sorted by <mark>most recently hired first</mark>`);
    tags.push({ cls:'sort', icon:'‚Üï', label:'Sort: Date ‚Üì' });
  } else if (q.includes('oldest') || q.includes('longest')) {
    parts.push(`, sorted by <mark>earliest hire date first</mark>`);
    tags.push({ cls:'sort', icon:'‚Üï', label:'Sort: Date ‚Üë' });
  }

  parts.push('.');

  document.getElementById('leIcon').textContent = icon;
  document.getElementById('leSentence').innerHTML = parts.join('');
  document.getElementById('leTags').innerHTML = tags.map(t =>
    `<span class="le-tag ${t.cls}"><span class="tt">${t.icon}</span>${t.label}</span>`
  ).join('');
}

// ‚îÄ‚îÄ PRE-POPULATE table + JSON with default dataset on load ‚îÄ‚îÄ
(function initDefaultView(){
  currentResultDocs = DEFAULT_DATA;
  renderTable(DEFAULT_DATA, 0);
  renderJSON(DEFAULT_DATA);
  // Show results panel immediately so table/JSON are visible
  document.getElementById('emptyState').style.display='none';
  document.getElementById('results').style.display='block';
  // Pipeline ‚Äî all done
  for(let i=1;i<=6;i++){const p=document.getElementById('ps'+i);p.className='ps done';p.querySelector('.ps-icon').textContent='‚úì';}
  // Default query display
  document.getElementById('qbMethod').textContent='find()';
  document.getElementById('qbOp').textContent=`db.employees.find({}) ‚Äî 35 documents`;
  document.getElementById('queryOut').textContent=`db.employees.find({})`;
  // Explanation
  document.getElementById('explainText').innerHTML=`Returns <strong>all 35 documents</strong> from the <code>employees</code> collection with no filter applied. Type a query above to filter, sort, or aggregate the data.`;
  // Meta row
  document.getElementById('metaConf').textContent='100%';
  document.getElementById('confBar').style.width='100%';
  document.getElementById('metaPlan').textContent='Full Scan';
  document.getElementById('metaPlanSub').textContent='find() ¬∑ 35 docs scanned';
  document.getElementById('metaColl').textContent='employees';
  document.getElementById('metaCollSub').textContent='35 total docs';
  // Stats
  document.getElementById('statDocs').textContent=DEFAULT_DATA.length;
  document.getElementById('statFields').textContent=Object.keys(DEFAULT_DATA[0]).length;
  document.getElementById('statTime').textContent='0ms';
  document.getElementById('statIdx').textContent='COLLSCAN';
  // Result badge
  document.getElementById('resultBadge').textContent='Default Dataset';
  // Charts
  buildCharts();
  // Summary
  const salaries=DEFAULT_DATA.map(d=>d.salary);
  const avgSal=Math.round(salaries.reduce((a,b)=>a+b,0)/salaries.length);
  document.getElementById('summaryView').innerHTML=`
    <div style="display:flex;gap:12px;align-items:flex-start;margin-bottom:16px;">
      <span style="font-size:26px;flex-shrink:0">‚ú¶</span>
      <div>
        <div style="font-size:9px;font-weight:700;color:var(--green);font-family:'JetBrains Mono',monospace;letter-spacing:2px;margin-bottom:6px">QUERY RESULT SUMMARY</div>
        <div style="font-size:13px;color:var(--text2);line-height:1.8">Showing all <strong style="color:var(--green)">${DEFAULT_DATA.length}</strong> documents from the default <code style="background:rgba(0,245,128,0.08);color:var(--green);padding:1px 5px;border-radius:3px;font-family:JetBrains Mono,monospace;font-size:10px">employees</code> collection. Type a query above to filter results.</div>
      </div>
    </div>
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px">
      <div style="background:rgba(0,245,128,0.05);border:1px solid rgba(0,245,128,0.12);border-radius:8px;padding:12px">
        <div style="font-size:9px;color:var(--text3);font-weight:700;letter-spacing:1.5px;margin-bottom:3px">DOCS MATCHED</div>
        <div style="font-size:24px;font-weight:800;color:var(--green)">${DEFAULT_DATA.length}</div>
        <div style="font-size:10px;color:var(--text3);font-family:'JetBrains Mono',monospace">of ${DEFAULT_DATA.length} total</div>
      </div>
      <div style="background:rgba(77,184,255,0.05);border:1px solid rgba(77,184,255,0.12);border-radius:8px;padding:12px">
        <div style="font-size:9px;color:var(--text3);font-weight:700;letter-spacing:1.5px;margin-bottom:3px">FIELDS</div>
        <div style="font-size:24px;font-weight:800;color:var(--blue)">${Object.keys(DEFAULT_DATA[0]).length}</div>
        <div style="font-size:10px;color:var(--text3);font-family:'JetBrains Mono',monospace">per document</div>
      </div>
      <div style="background:rgba(255,179,64,0.05);border:1px solid rgba(255,179,64,0.12);border-radius:8px;padding:12px">
        <div style="font-size:9px;color:var(--text3);font-weight:700;letter-spacing:1.5px;margin-bottom:3px">AVG SALARY</div>
        <div style="font-size:24px;font-weight:800;color:var(--amber)">$${avgSal.toLocaleString()}</div>
        <div style="font-size:10px;color:var(--text3);font-family:'JetBrains Mono',monospace">across all employees</div>
      </div>
    </div>`;
})();
  // Protect dashboard
if (localStorage.getItem("isLoggedIn") !== "true") {
    window.location.href = "login-signup.html";
}
// Optional: show username in console
const username = localStorage.getItem("userUsername");
console.log("Logged in as:", username);
// Logout function (connect to logout button)
function logoutUser() {
    localStorage.removeItem("isLoggedIn");
    window.location.href = "login-signup.html";
}
</script>
</body>
</html>

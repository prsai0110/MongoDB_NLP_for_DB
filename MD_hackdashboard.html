<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MongoQuery ‚Äî AI Query Generator</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
:root {
  --bg:#080c10; --surface:#0e1419; --card:#131920; --card2:#161d26;
  --border:#1e2a36; --border2:#253040;
  --green:#00f580; --green-dim:#00c060; --green-dk:#004a28;
  --blue:#4db8ff; --amber:#ffb340; --red:#ff4f4f; --purple:#b48eff;
  --text:#dce8f0; --text2:#8fa3b5; --text3:#4d6070;
  --glow:0 0 32px rgba(0,245,128,0.15); --glow-sm:0 0 14px rgba(0,245,128,0.1);
}
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box;}
html,body{height:100%;overflow:hidden;}
body{background:var(--bg);color:var(--text);font-family:'Syne',sans-serif;font-size:13px;}
body::before{content:'';position:fixed;inset:0;pointer-events:none;z-index:0;
  background-image:linear-gradient(rgba(0,245,128,0.022) 1px,transparent 1px),
  linear-gradient(90deg,rgba(0,245,128,0.022) 1px,transparent 1px);
  background-size:40px 40px;}
body::after{content:'';position:fixed;top:-200px;right:-200px;width:600px;height:600px;
  background:radial-gradient(circle,rgba(0,245,128,0.055) 0%,transparent 65%);pointer-events:none;z-index:0;}
.blob2{position:fixed;bottom:-150px;left:-150px;width:500px;height:500px;
  background:radial-gradient(circle,rgba(77,184,255,0.045) 0%,transparent 65%);pointer-events:none;z-index:0;}

/* ‚îÄ‚îÄ SHELL ‚îÄ‚îÄ */
.app{position:relative;z-index:1;display:flex;flex-direction:column;height:100vh;}

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
header{display:flex;align-items:center;justify-content:space-between;
  padding:0 24px;height:52px;flex-shrink:0;
  border-bottom:1px solid var(--border);background:rgba(8,12,16,0.92);backdrop-filter:blur(20px);}
.logo{display:flex;align-items:center;gap:9px;}
.logo-icon{width:28px;height:28px;background:linear-gradient(135deg,var(--green),var(--green-dim));
  border-radius:7px 2px 7px 2px;display:flex;align-items:center;justify-content:center;
  font-size:14px;box-shadow:var(--glow-sm);}
.logo-text{font-size:15px;font-weight:800;letter-spacing:-0.5px;}
.logo-text .m{color:var(--green);}
.header-center{display:flex;align-items:center;gap:7px;background:var(--card);
  border:1px solid var(--border);border-radius:7px;padding:4px 13px;
  font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--text3);}
.header-center .coll{color:var(--green);font-weight:600;}
.header-right{display:flex;align-items:center;gap:10px;}
.hbadge{padding:3px 8px;border-radius:4px;font-size:9px;font-weight:700;
  font-family:'JetBrains Mono',monospace;letter-spacing:0.5px;}
.hbadge-ai{background:rgba(77,184,255,0.1);border:1px solid rgba(77,184,255,0.25);color:var(--blue);}
.hbadge-v{background:rgba(0,245,128,0.1);border:1px solid rgba(0,245,128,0.25);color:var(--green);}
.conn-pill{display:flex;align-items:center;gap:5px;font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--text3);}
.conn-dot{width:6px;height:6px;background:var(--green);border-radius:50%;
  box-shadow:0 0 6px var(--green);animation:blink 2s infinite;}
@keyframes blink{0%,100%{opacity:1}50%{opacity:0.4}}

/* ‚îÄ‚îÄ QUERY INPUT STRIP ‚îÄ‚îÄ */
.query-strip{flex-shrink:0;padding:11px 20px 10px;border-bottom:1px solid var(--border);
  background:rgba(14,20,25,0.6);}
.qs-top{display:flex;align-items:center;gap:9px;margin-bottom:8px;}
.qs-label{font-size:8px;font-weight:700;letter-spacing:2.5px;color:var(--text3);text-transform:uppercase;}
.coll-pill{display:flex;align-items:center;gap:4px;background:var(--card);border:1px solid var(--border);
  border-radius:5px;padding:2px 9px;font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--green);}
.qbox-wrap{position:relative;margin-bottom:8px;}
.qbox{width:100%;background:var(--card);border:1px solid var(--border);border-radius:8px;
  padding:10px 165px 10px 14px;color:var(--text);font-family:'Syne',sans-serif;
  font-size:13px;font-weight:500;outline:none;transition:all 0.2s;height:42px;}
.qbox:focus{border-color:var(--green);box-shadow:var(--glow);}
.qbox::placeholder{color:var(--text3);font-weight:400;}
.qbox-btns{position:absolute;right:6px;top:50%;transform:translateY(-50%);display:flex;gap:4px;}
.btn-run{background:linear-gradient(135deg,var(--green),var(--green-dim));color:#080c10;border:none;
  border-radius:6px;padding:7px 13px;font-family:'Syne',sans-serif;font-size:11px;font-weight:700;
  cursor:pointer;transition:all 0.18s;white-space:nowrap;}
.btn-run:hover{transform:scale(1.03);box-shadow:var(--glow);}
.btn-clr{background:var(--border);border:none;color:var(--text3);border-radius:6px;
  padding:7px 10px;font-size:11px;cursor:pointer;transition:all 0.15s;}
.btn-clr:hover{background:var(--card2);color:var(--text2);}
.chips{display:flex;gap:5px;flex-wrap:wrap;}
.chip{background:var(--card2);border:1px solid var(--border);border-radius:14px;padding:3px 10px;
  font-size:9px;color:var(--text3);cursor:pointer;transition:all 0.15s;font-weight:600;}
.chip:hover{border-color:var(--green);color:var(--green);}

/* ‚îÄ‚îÄ 3-COLUMN WORKSPACE ‚îÄ‚îÄ */
/* sidebar | explain-panel | results-panel */
.workspace{display:grid;grid-template-columns:220px 300px 1fr;flex:1;min-height:0;overflow:hidden;}

/* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
.sidebar{border-right:1px solid var(--border);background:rgba(14,20,25,0.65);
  display:flex;flex-direction:column;overflow-y:auto;padding:14px 0 16px;}
.sb-sec{padding:0 12px;margin-bottom:4px;}
.sb-label{font-size:8px;font-weight:700;letter-spacing:2.5px;color:var(--text3);
  text-transform:uppercase;margin-bottom:6px;padding:0 2px;}
.nav-item{display:flex;align-items:center;gap:8px;padding:7px 9px;border-radius:6px;
  cursor:pointer;font-size:11px;font-weight:600;color:var(--text3);transition:all 0.15s;margin-bottom:1px;}
.nav-item:hover{background:var(--border);color:var(--text2);}
.nav-item.active{background:rgba(0,245,128,0.08);color:var(--green);}
.nav-item .ni{font-size:12px;}
.nav-count{margin-left:auto;background:var(--border);color:var(--text3);
  font-family:'JetBrains Mono',monospace;font-size:9px;padding:1px 5px;border-radius:7px;}
.sb-div{border:none;border-top:1px solid var(--border);margin:10px 12px;}
.coll-item{display:flex;align-items:center;gap:7px;padding:6px 9px;border-radius:6px;
  cursor:pointer;font-size:10px;font-weight:600;color:var(--text3);
  font-family:'JetBrains Mono',monospace;transition:all 0.15s;margin-bottom:1px;}
.coll-item:hover{background:var(--border);color:var(--text2);}
.coll-item.active{background:rgba(0,245,128,0.07);color:var(--green);
  border-left:2px solid var(--green);padding-left:7px;}
.coll-cnt{margin-left:auto;font-size:9px;color:var(--text3);}
.op-grid{display:grid;grid-template-columns:1fr 1fr;gap:4px;}
.op-btn{padding:6px 4px;border-radius:5px;background:var(--card2);border:1px solid var(--border);
  color:var(--text3);font-size:9px;font-weight:700;cursor:pointer;transition:all 0.15s;
  font-family:'JetBrains Mono',monospace;text-align:center;}
.op-btn:hover{border-color:var(--green);color:var(--green);}
.op-btn.active{background:rgba(0,245,128,0.08);border-color:var(--green);color:var(--green);}
.upload-zone{position:relative;border:2px dashed var(--border);border-radius:8px;
  padding:12px 8px;text-align:center;cursor:pointer;transition:all 0.2s;}
.upload-zone:hover,.upload-zone.drag-over{border-color:var(--green);background:rgba(0,245,128,0.03);}
.upload-zone input{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%;}
.upload-icon{font-size:18px;margin-bottom:3px;display:block;}
.upload-main{font-size:10px;font-weight:700;color:var(--text2);margin-bottom:2px;}
.upload-sub{font-size:8px;color:var(--text3);font-family:'JetBrains Mono',monospace;}
.fmt-row{display:flex;gap:3px;justify-content:center;margin-top:5px;flex-wrap:wrap;}
.fmt-tag{background:var(--border);color:var(--text3);border-radius:3px;padding:1px 4px;
  font-size:8px;font-weight:700;font-family:'JetBrains Mono',monospace;}
.file-loaded{display:none;background:rgba(0,245,128,0.04);border:1px solid rgba(0,245,128,0.18);
  border-radius:7px;padding:8px;margin-top:6px;}
.fl-row{display:flex;align-items:center;gap:5px;}
.fl-info{flex:1;min-width:0;}
.fl-name{font-size:9px;font-weight:700;color:var(--green);
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-family:'JetBrains Mono',monospace;}
.fl-meta{font-size:8px;color:var(--text3);font-family:'JetBrains Mono',monospace;margin-top:1px;}
.fl-remove{background:none;border:1px solid var(--border);color:var(--text3);
  border-radius:3px;padding:1px 5px;font-size:9px;cursor:pointer;}
.fl-remove:hover{border-color:var(--red);color:var(--red);}
.db-info{background:var(--card2);border:1px solid var(--border);border-radius:7px;padding:9px 11px;}
.db-label{font-size:8px;color:var(--text3);font-weight:700;letter-spacing:1.5px;margin-bottom:3px;}
.db-name{font-size:11px;font-weight:700;color:var(--green);font-family:'JetBrains Mono',monospace;}
.db-meta{font-size:9px;color:var(--text3);margin-top:2px;font-family:'JetBrains Mono',monospace;}

/* ‚îÄ‚îÄ EXPLAIN PANEL (middle column) ‚îÄ‚îÄ */
/* This column is fully independent ‚Äî never pushes results out */
.explain-panel{border-right:1px solid var(--border);background:rgba(10,16,22,0.85);
  display:flex;flex-direction:column;overflow:hidden;min-height:0;}
.ep-head{flex-shrink:0;padding:11px 14px 9px;border-bottom:1px solid var(--border);
  background:rgba(0,245,128,0.03);}
.ep-head-row{display:flex;align-items:center;justify-content:space-between;}
.ep-pulse-row{display:flex;align-items:center;gap:7px;}
.ep-pulse{width:7px;height:7px;background:var(--green);border-radius:50%;
  box-shadow:0 0 7px var(--green);animation:blink 1.8s infinite;flex-shrink:0;}
.ep-title{font-size:9px;font-weight:700;color:var(--green);letter-spacing:2px;text-transform:uppercase;}
.ep-badge{font-size:9px;font-weight:700;color:var(--text3);background:var(--card2);
  border:1px solid var(--border);border-radius:12px;padding:2px 8px;
  font-family:'JetBrains Mono',monospace;}
.ep-badge span{color:var(--green);}
/* idle placeholder */
.ep-idle{display:flex;flex-direction:column;align-items:center;justify-content:center;
  flex:1;padding:28px 18px;text-align:center;}
.ep-idle-icon{font-size:32px;margin-bottom:11px;opacity:0.45;}
.ep-idle-title{font-size:13px;font-weight:700;color:var(--text3);margin-bottom:6px;}
.ep-idle-sub{font-size:11px;color:var(--text3);line-height:1.65;opacity:0.65;}
/* scrollable explain content */
.ep-scroll{flex:1;overflow-y:auto;padding:12px 14px 20px;}

/* big summary sentence */
.le-bigsentence{background:rgba(0,245,128,0.04);border:1px solid rgba(0,245,128,0.15);
  border-radius:8px;padding:11px 12px;margin-bottom:14px;
  font-size:13px;font-weight:700;color:var(--text);line-height:1.65;}
.le-bigsentence mark{background:rgba(0,245,128,0.15);color:var(--green);border-radius:3px;padding:0 4px;font-weight:800;}
.le-bigsentence .hlb{background:rgba(77,184,255,0.12);color:var(--blue);border-radius:3px;padding:0 4px;font-weight:800;}
.le-bigsentence .hla{background:rgba(255,179,64,0.12);color:var(--amber);border-radius:3px;padding:0 4px;font-weight:800;}
.le-bigsentence .hlp{background:rgba(180,142,255,0.12);color:var(--purple);border-radius:3px;padding:0 4px;font-weight:800;}
.le-bigsentence .hlr{background:rgba(255,79,79,0.1);color:var(--red);border-radius:3px;padding:0 4px;font-weight:800;}

/* step list */
.le-step{display:flex;animation:stepIn 0.3s ease both;}
@keyframes stepIn{from{opacity:0;transform:translateX(-5px);}to{opacity:1;transform:translateX(0);}}
.le-step:nth-child(1){animation-delay:0.02s}
.le-step:nth-child(2){animation-delay:0.07s}
.le-step:nth-child(3){animation-delay:0.12s}
.le-step:nth-child(4){animation-delay:0.17s}
.le-step:nth-child(5){animation-delay:0.22s}
.le-step:nth-child(6){animation-delay:0.27s}
.le-step-left{display:flex;flex-direction:column;align-items:center;width:30px;flex-shrink:0;}
.le-step-num{width:22px;height:22px;border-radius:50%;display:flex;align-items:center;justify-content:center;
  font-size:9px;font-weight:800;flex-shrink:0;font-family:'JetBrains Mono',monospace;margin-top:1px;}
.ng{background:rgba(0,245,128,0.14);color:var(--green);border:1.5px solid rgba(0,245,128,0.35);}
.nb{background:rgba(77,184,255,0.12);color:var(--blue);border:1.5px solid rgba(77,184,255,0.3);}
.na{background:rgba(255,179,64,0.12);color:var(--amber);border:1.5px solid rgba(255,179,64,0.3);}
.np{background:rgba(180,142,255,0.11);color:var(--purple);border:1.5px solid rgba(180,142,255,0.3);}
.nr{background:rgba(255,79,79,0.1);color:var(--red);border:1.5px solid rgba(255,79,79,0.25);}
.le-step-line{width:1.5px;flex:1;background:var(--border);margin:4px auto 0;min-height:10px;}
.le-step:last-child .le-step-line{display:none;}
.le-step-right{flex:1;padding:0 0 15px 9px;}
.le-step-row{display:flex;align-items:center;gap:6px;margin-bottom:4px;}
.le-step-icon{font-size:14px;flex-shrink:0;}
.le-step-label{font-size:12px;font-weight:700;color:var(--text);}
.le-step-desc{font-size:11px;color:var(--text2);line-height:1.65;}
.le-step-desc mark{background:rgba(0,245,128,0.1);color:var(--green);border-radius:3px;padding:0 3px;font-weight:700;}
.le-step-desc .hb{color:var(--blue);font-weight:700;}
.le-step-desc .ha{color:var(--amber);font-weight:700;}
.le-step-desc .hp{color:var(--purple);font-weight:700;}
.le-step-desc .hr{color:var(--red);font-weight:700;}
.le-tag{display:inline-flex;align-items:center;gap:3px;margin-top:5px;margin-right:4px;
  background:var(--card2);border:1px solid var(--border2);border-radius:4px;padding:2px 7px;
  font-size:9px;font-weight:600;font-family:'JetBrains Mono',monospace;color:var(--text3);}
.le-tag.tg{border-color:rgba(0,245,128,0.25);color:var(--green);background:rgba(0,245,128,0.06);}
.le-tag.tb{border-color:rgba(77,184,255,0.25);color:var(--blue);background:rgba(77,184,255,0.06);}
.le-tag.ta{border-color:rgba(255,179,64,0.25);color:var(--amber);background:rgba(255,179,64,0.06);}
.le-tag.tp{border-color:rgba(180,142,255,0.25);color:var(--purple);background:rgba(180,142,255,0.06);}

/* ‚îÄ‚îÄ RESULTS PANEL (right column) ‚îÄ‚îÄ */
/* Fully independent scroll ‚Äî never affected by explain panel */
.results-panel{display:flex;flex-direction:column;overflow:hidden;min-height:0;}

/* pipeline strip */
.pipeline{display:flex;flex-shrink:0;border-bottom:1px solid var(--border);}
.ps{flex:1;padding:8px 4px;text-align:center;font-size:8px;font-weight:700;
  letter-spacing:0.3px;color:var(--text3);background:var(--card2);
  border-right:1px solid var(--border);transition:all 0.22s;text-transform:uppercase;}
.ps:last-child{border-right:none;}
.psi{display:block;font-size:12px;margin-bottom:2px;}
.ps.done{color:var(--green);background:rgba(0,245,128,0.05);}
.ps.active{color:var(--text);background:rgba(0,245,128,0.1);}

/* loading bar */
.loading-strip{display:none;align-items:center;gap:9px;padding:8px 18px;
  border-bottom:1px solid var(--border);flex-shrink:0;
  font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--text3);}
.spinner{width:12px;height:12px;border:2px solid var(--border2);border-top-color:var(--green);
  border-radius:50%;animation:spin 0.6s linear infinite;}
@keyframes spin{to{transform:rotate(360deg);}}

/* scrollable results */
.results-scroll{flex:1;overflow-y:auto;padding:14px 18px 28px;}
@keyframes slideUp{from{opacity:0;transform:translateY(8px);}to{opacity:1;transform:translateY(0);}}
@keyframes fadeIn{from{opacity:0;}to{opacity:1;}}

/* query block */
.query-block{background:var(--card);border:1px solid var(--border);
  border-left:3px solid var(--green);border-radius:8px;margin-bottom:12px;
  overflow:hidden;animation:slideUp 0.3s ease;}
.qb-head{display:flex;align-items:center;justify-content:space-between;
  padding:8px 12px;border-bottom:1px solid var(--border);background:rgba(0,245,128,0.02);}
.qb-head-left{display:flex;align-items:center;gap:8px;min-width:0;}
.qb-method{background:rgba(0,245,128,0.12);color:var(--green);font-family:'JetBrains Mono',monospace;
  font-size:9px;font-weight:700;padding:2px 7px;border-radius:4px;flex-shrink:0;}
.qb-op{font-size:10px;color:var(--text3);font-family:'JetBrains Mono',monospace;
  overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.qb-copy{background:none;border:1px solid var(--border);color:var(--text3);border-radius:4px;
  padding:2px 8px;font-size:9px;cursor:pointer;transition:all 0.15s;
  font-family:'JetBrains Mono',monospace;flex-shrink:0;white-space:nowrap;}
.qb-copy:hover{border-color:var(--green);color:var(--green);}
.qb-body{padding:10px 12px;}
.qb-code{font-family:'JetBrains Mono',monospace;font-size:11px;color:#9db8cc;
  line-height:1.7;white-space:pre-wrap;word-break:break-word;}

/* AI explanation */
.ai-explain{background:rgba(77,184,255,0.04);border:1px solid rgba(77,184,255,0.14);
  border-left:3px solid var(--blue);border-radius:8px;padding:11px 13px;
  margin-bottom:12px;animation:slideUp 0.32s ease;}
.ae-head{display:flex;align-items:center;gap:6px;margin-bottom:6px;}
.ae-label{font-size:8px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--blue);}
.ae-text{font-size:11px;line-height:1.7;color:var(--text2);}
.ae-text strong{color:var(--text);}
.ae-text code{background:rgba(0,245,128,0.08);color:var(--green);padding:1px 4px;
  border-radius:3px;font-family:'JetBrains Mono',monospace;font-size:9px;}

/* meta row */
.meta-row{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:12px;animation:slideUp 0.34s ease;}
.meta-box{background:var(--card);border:1px solid var(--border);border-radius:8px;padding:10px 12px;}
.meta-lbl{font-size:8px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--text3);margin-bottom:4px;}
.meta-val{font-size:18px;font-weight:800;line-height:1;}
.meta-sub{font-size:9px;color:var(--text3);font-family:'JetBrains Mono',monospace;margin-top:2px;}
.conf-bg{background:var(--border);border-radius:3px;height:3px;overflow:hidden;margin-top:6px;}
.conf-fill{height:100%;border-radius:3px;background:linear-gradient(90deg,var(--green-dim),var(--green));transition:width 0.6s ease;}

/* stats */
.stats-row{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:12px;}
.stat-card{background:var(--card);border:1px solid var(--border);border-radius:8px;padding:11px 13px;
  transition:all 0.18s;animation:slideUp 0.36s ease;}
.stat-card:hover{border-color:var(--border2);transform:translateY(-2px);}
.sc-lbl{font-size:8px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--text3);margin-bottom:4px;}
.sc-val{font-size:20px;font-weight:800;line-height:1;margin-bottom:2px;}
.sc-sub{font-size:9px;color:var(--text3);font-family:'JetBrains Mono',monospace;}
.stat-card:nth-child(1) .sc-val{color:var(--green);}
.stat-card:nth-child(2) .sc-val{color:var(--blue);}
.stat-card:nth-child(3) .sc-val{color:var(--amber);}
.stat-card:nth-child(4) .sc-val{color:var(--purple);}

/* charts */
.charts-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px;}
.chart-card{background:var(--card);border:1px solid var(--border);border-radius:8px;
  padding:13px;animation:slideUp 0.38s ease;}
.cc-title{font-size:11px;font-weight:700;color:var(--text2);margin-bottom:2px;}
.cc-sub{font-size:9px;color:var(--text3);font-family:'JetBrains Mono',monospace;margin-bottom:10px;}
.cc-wrap{position:relative;height:160px;}

/* result data */
.result-block{background:var(--card);border:1px solid var(--border);
  border-left:3px solid var(--blue);border-radius:8px;margin-bottom:12px;
  overflow:hidden;animation:slideUp 0.4s ease;}
.rb-head{display:flex;align-items:center;justify-content:space-between;
  padding:8px 12px;border-bottom:1px solid var(--border);background:rgba(77,184,255,0.02);}
.rb-title{display:flex;align-items:center;gap:6px;font-size:12px;font-weight:700;}
.rb-badge{background:rgba(77,184,255,0.12);color:var(--blue);
  font-family:'JetBrains Mono',monospace;font-size:8px;font-weight:700;padding:2px 6px;border-radius:3px;}
.rb-export{background:none;border:1px solid var(--border);color:var(--text3);
  border-radius:4px;padding:2px 8px;font-size:9px;cursor:pointer;
  font-family:'JetBrains Mono',monospace;transition:all 0.15s;}
.rb-export:hover{border-color:var(--green);color:var(--green);}
.tabs{display:flex;border-bottom:1px solid var(--border);}
.tab{padding:7px 13px;font-size:10px;font-weight:700;color:var(--text3);cursor:pointer;
  border-bottom:2px solid transparent;transition:all 0.15s;font-family:'JetBrains Mono',monospace;}
.tab:hover{color:var(--text2);}
.tab.active{color:var(--green);border-bottom-color:var(--green);}

/* table */
.table-wrap{overflow-x:auto;}
table{width:100%;border-collapse:collapse;}
thead th{background:rgba(30,42,54,0.5);padding:7px 10px;text-align:left;
  font-size:8px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;
  color:var(--text3);border-bottom:1px solid var(--border);
  font-family:'JetBrains Mono',monospace;white-space:nowrap;}
tbody tr{border-bottom:1px solid rgba(30,42,54,0.5);transition:background 0.1s;}
tbody tr:hover{background:rgba(0,245,128,0.02);}
tbody tr:last-child{border-bottom:none;}
td{padding:6px 10px;font-size:10px;color:var(--text);font-family:'JetBrains Mono',monospace;white-space:nowrap;}
.badge{display:inline-block;padding:1px 6px;border-radius:3px;font-size:8px;
  font-weight:700;font-family:'JetBrains Mono',monospace;}
.bg-green{background:rgba(0,245,128,0.1);color:var(--green);}
.bg-red{background:rgba(255,79,79,0.1);color:var(--red);}
.bg-amber{background:rgba(255,179,64,0.1);color:var(--amber);}
.bg-blue{background:rgba(77,184,255,0.1);color:var(--blue);}
.pagination{display:flex;align-items:center;justify-content:space-between;
  padding:6px 12px;border-top:1px solid var(--border);
  font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--text3);}
.page-btns{display:flex;gap:3px;}
.page-btn{background:var(--border);border:none;color:var(--text3);border-radius:3px;
  padding:2px 7px;font-size:9px;cursor:pointer;font-family:'JetBrains Mono',monospace;transition:all 0.12s;}
.page-btn:hover{background:var(--card2);color:var(--text2);}
.page-btn.active{background:rgba(0,245,128,0.12);color:var(--green);}
.json-view{font-family:'JetBrains Mono',monospace;font-size:10px;color:#8fa3b5;
  line-height:1.8;max-height:280px;overflow-y:auto;background:rgba(0,0,0,0.15);padding:12px;}
.jk{color:#b48eff;}.jstr{color:var(--blue);}.jnum{color:var(--amber);}
.jbool{color:var(--red);}.jnull{color:var(--text3);}.jbr{color:var(--green);}
.summary-body{padding:13px;}

/* log */
.logs-card{background:var(--card);border:1px solid var(--border);border-radius:8px;animation:slideUp 0.44s ease;}
.lc-head{display:flex;align-items:center;justify-content:space-between;padding:7px 12px;border-bottom:1px solid var(--border);}
.lc-title{font-size:10px;font-weight:700;}
.lc-live{display:flex;align-items:center;gap:4px;font-size:8px;color:var(--green);font-family:'JetBrains Mono',monospace;}
.log-body{padding:6px 12px;max-height:100px;overflow-y:auto;font-family:'JetBrains Mono',monospace;font-size:9px;line-height:1.9;}
.log-line{display:flex;gap:8px;}
.lt{color:var(--text3);}.li{color:var(--blue);}.ls{color:var(--green);}
.lw{color:var(--amber);}.le2{color:var(--red);}.lm{color:var(--text2);}

::-webkit-scrollbar{width:3px;height:3px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px;}
</style>
</head>
<body>
<div class="blob2"></div>
<div class="app">

  <!-- HEADER -->
  <header>
    <div class="logo">
      <div class="logo-icon">üçÉ</div>
      <div class="logo-text"><span class="m">Mongo</span>Query</div>
    </div>
    <div class="header-center">
      <span style="color:var(--text3)">db.</span><span class="coll" id="hdrColl">employees</span><span style="color:var(--text3)">.find(...)</span>
    </div>
    <div class="header-right">
      <div class="hbadge hbadge-ai">‚ú¶ AI Engine</div>
      <div class="hbadge hbadge-v">v8.0</div>
      <div class="conn-pill"><div class="conn-dot"></div>CONNECTED</div>
    </div>
  </header>

  <!-- QUERY INPUT STRIP (compact, fixed height) -->
  <div class="query-strip">
    <div class="qs-top">
      <span class="qs-label">Natural Language ‚Üí MongoDB</span>
      <div class="coll-pill">üçÉ db.<span id="activeColl">employees</span></div>
    </div>
    <div class="qbox-wrap">
      <input type="text" class="qbox" id="queryInput" placeholder="e.g. Find all employees in Sales with salary over 80000"/>
      <div class="qbox-btns">
        <button class="btn-clr" onclick="clearQuery()">Clear</button>
        <button class="btn-run" onclick="runQuery()">‚ö° Generate + Run</button>
      </div>
    </div>
    <div class="chips">
      <span class="chip" onclick="useChip(this)">Find all employees in Sales</span>
      <span class="chip" onclick="useChip(this)">Top 5 highest paid</span>
      <span class="chip" onclick="useChip(this)">Count by department</span>
      <span class="chip" onclick="useChip(this)">Hired after 2020</span>
      <span class="chip" onclick="useChip(this)">Average salary per dept</span>
    </div>
  </div>

  <!-- 3-COLUMN WORKSPACE -->
  <div class="workspace">

    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="sb-sec">
        <div class="sb-label">Navigation</div>
        <div class="nav-item active" onclick="setNav(this)"><span class="ni">‚ö°</span>Query Generator<span class="nav-count">5</span></div>
        <div class="nav-item" onclick="setNav(this)"><span class="ni">üìä</span>Aggregations</div>
        <div class="nav-item" onclick="setNav(this)"><span class="ni">üóÇÔ∏è</span>Collections</div>
        <div class="nav-item" onclick="setNav(this)"><span class="ni">üìã</span>Query History</div>
        <div class="nav-item" onclick="setNav(this)"><span class="ni">‚öôÔ∏è</span>Settings</div>
      </div>
      <hr class="sb-div">
      <div class="sb-sec">
        <div class="sb-label">Collections</div>
        <div class="coll-item active" onclick="selectColl(this,'employees')"><span>üìÅ</span>employees<span class="coll-cnt">1,240</span></div>
        <div class="coll-item" onclick="selectColl(this,'departments')"><span>üìÅ</span>departments<span class="coll-cnt">12</span></div>
        <div class="coll-item" onclick="selectColl(this,'projects')"><span>üìÅ</span>projects<span class="coll-cnt">348</span></div>
        <div class="coll-item" onclick="selectColl(this,'salaries')"><span>üìÅ</span>salaries<span class="coll-cnt">4,820</span></div>
      </div>
      <hr class="sb-div">
      <div class="sb-sec">
        <div class="sb-label">Operation Type</div>
        <div class="op-grid">
          <div class="op-btn active" onclick="selectOp(this)">find()</div>
          <div class="op-btn" onclick="selectOp(this)">aggregate()</div>
          <div class="op-btn" onclick="selectOp(this)">insertOne()</div>
          <div class="op-btn" onclick="selectOp(this)">updateMany()</div>
          <div class="op-btn" onclick="selectOp(this)">deleteOne()</div>
          <div class="op-btn" onclick="selectOp(this)">countDocs()</div>
        </div>
      </div>
      <hr class="sb-div">
      <div class="sb-sec">
        <div class="sb-label">Upload Data File</div>
        <div class="upload-zone" id="uploadZone" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event)">
          <input type="file" id="fileInput" accept=".csv,.xlsx,.xls,.json,.tsv" onchange="handleFileSelect(event)">
          <span class="upload-icon">üìÇ</span>
          <div class="upload-main">Drop file or click</div>
          <div class="upload-sub">Runs on your real data</div>
          <div class="fmt-row"><span class="fmt-tag">CSV</span><span class="fmt-tag">JSON</span><span class="fmt-tag">XLSX</span><span class="fmt-tag">TSV</span></div>
        </div>
        <div class="file-loaded" id="fileLoaded">
          <div class="fl-row">
            <span style="font-size:14px">üìÑ</span>
            <div class="fl-info">
              <div class="fl-name" id="flName">‚Äî</div>
              <div class="fl-meta" id="flMeta">‚Äî</div>
            </div>
            <button class="fl-remove" onclick="removeFile()">‚úï</button>
          </div>
        </div>
      </div>
      <hr class="sb-div">
      <div class="sb-sec">
        <div class="sb-label">Database</div>
        <div class="db-info">
          <div class="db-label">ACTIVE DATABASE</div>
          <div class="db-name" id="dbName">myDatabase</div>
          <div class="db-meta" id="dbMeta">4 collections ¬∑ 6,420 docs</div>
        </div>
      </div>
    </aside>

    <!-- EXPLAIN PANEL (middle ‚Äî own scroll, never pushes results) -->
    <div class="explain-panel">
      <div class="ep-head">
        <div class="ep-head-row">
          <div class="ep-pulse-row">
            <div class="ep-pulse"></div>
            <span class="ep-title">Step-by-step explanation</span>
          </div>
          <div class="ep-badge"><span id="leStepCount">0</span> steps</div>
        </div>
      </div>
      <div class="ep-idle" id="epIdle">
        <div class="ep-idle-icon">üí°</div>
        <div class="ep-idle-title">Start typing above</div>
        <div class="ep-idle-sub">As you type your query, this panel shows a plain-English breakdown of every step ‚Äî no technical knowledge needed.</div>
      </div>
      <div class="ep-scroll" id="epScroll" style="display:none;">
        <div class="le-bigsentence" id="leBigSentence">‚Äî</div>
        <div id="leSteps"></div>
      </div>
    </div>

    <!-- RESULTS PANEL (right ‚Äî own independent scroll) -->
    <div class="results-panel">
      <!-- loading -->
      <div class="loading-strip" id="loadingStrip">
        <div class="spinner"></div>
        <span id="loadingMsg">Processing...</span>
      </div>
      <!-- pipeline -->
      <div class="pipeline">
        <div class="ps" id="ps1"><span class="psi">‚úì</span>Tokenize</div>
        <div class="ps" id="ps2"><span class="psi">‚úì</span>Intent</div>
        <div class="ps" id="ps3"><span class="psi">‚úì</span>Schema</div>
        <div class="ps" id="ps4"><span class="psi">‚úì</span>Query Gen</div>
        <div class="ps" id="ps5"><span class="psi">‚úì</span>Optimize</div>
        <div class="ps" id="ps6"><span class="psi">‚úì</span>Execute</div>
      </div>
      <!-- scrollable results content -->
      <div class="results-scroll" id="resultsScroll">

        <!-- Generated query -->
        <div class="query-block" style="margin-top:2px;">
          <div class="qb-head">
            <div class="qb-head-left">
              <span class="qb-method" id="qbMethod">find()</span>
              <span class="qb-op" id="qbOp">db.employees.find({})</span>
            </div>
            <button class="qb-copy" onclick="copyQuery()">üìã Copy</button>
          </div>
          <div class="qb-body"><pre class="qb-code" id="queryOut">db.employees.find({})</pre></div>
        </div>

        <!-- AI explanation -->
        <div class="ai-explain">
          <div class="ae-head">
            <span style="font-size:13px">üí°</span>
            <span class="ae-label">Query Explanation</span>
          </div>
          <div class="ae-text" id="explainText">Returns <strong>all 35 documents</strong> from the <code>employees</code> collection with no filter applied. Type a query above to filter, sort, or aggregate the data.</div>
        </div>

        <!-- Confidence / meta -->
        <div class="meta-row">
          <div class="meta-box">
            <div class="meta-lbl">Confidence</div>
            <div class="meta-val" id="metaConf" style="color:var(--green)">100%</div>
            <div class="meta-sub">query match</div>
            <div class="conf-bg"><div class="conf-fill" id="confBar" style="width:100%"></div></div>
          </div>
          <div class="meta-box">
            <div class="meta-lbl">Query Plan</div>
            <div class="meta-val" id="metaPlan" style="color:var(--blue);font-size:13px;padding-top:3px">Full Scan</div>
            <div class="meta-sub" id="metaPlanSub">find() ¬∑ 35 docs</div>
          </div>
          <div class="meta-box">
            <div class="meta-lbl">Collection</div>
            <div class="meta-val" id="metaColl" style="color:var(--purple);font-size:13px;padding-top:3px">employees</div>
            <div class="meta-sub" id="metaCollSub">35 total docs</div>
          </div>
        </div>

        <!-- Stats -->
        <div class="stats-row">
          <div class="stat-card"><div class="sc-lbl">Documents</div><div class="sc-val" id="statDocs">35</div><div class="sc-sub">matched</div></div>
          <div class="stat-card"><div class="sc-lbl">Fields</div><div class="sc-val" id="statFields">7</div><div class="sc-sub">per document</div></div>
          <div class="stat-card"><div class="sc-lbl">Exec Time</div><div class="sc-val" id="statTime">0ms</div><div class="sc-sub">milliseconds</div></div>
          <div class="stat-card"><div class="sc-lbl">Index</div><div class="sc-val" id="statIdx">COLL</div><div class="sc-sub">scan type</div></div>
        </div>

        <!-- Charts -->
        <div class="charts-grid">
          <div class="chart-card">
            <div class="cc-title">Query Method Distribution</div>
            <div class="cc-sub">Usage this session</div>
            <div class="cc-wrap"><canvas id="methodChart"></canvas></div>
          </div>
          <div class="chart-card">
            <div class="cc-title">Execution Time History</div>
            <div class="cc-sub">Last 10 queries (ms)</div>
            <div class="cc-wrap"><canvas id="timeChart"></canvas></div>
          </div>
        </div>

        <!-- Result data -->
        <div class="result-block">
          <div class="rb-head">
            <div class="rb-title">
              <span>‚ú¶</span><span>Query Results</span>
              <span class="rb-badge" id="resultBadge">Default Dataset</span>
            </div>
            <button class="rb-export" onclick="exportResults()">‚¨á Export JSON</button>
          </div>
          <div class="tabs">
            <div class="tab active" onclick="switchTab('table',this)">üìã Table</div>
            <div class="tab" onclick="switchTab('json',this)">{ } JSON</div>
            <div class="tab" onclick="switchTab('summary',this)">üí° Summary</div>
          </div>
          <div id="tabTable">
            <div class="table-wrap"><table><thead id="tHead"></thead><tbody id="tBody"></tbody></table></div>
            <div class="pagination">
              <span id="pageInfo">0 documents</span>
              <div class="page-btns" id="pageBtns"></div>
            </div>
          </div>
          <div id="tabJson" style="display:none"><div class="json-view" id="jsonView"></div></div>
          <div id="tabSummary" style="display:none"><div class="summary-body" id="summaryView"></div></div>
        </div>

        <!-- Log -->
        <div class="logs-card">
          <div class="lc-head">
            <span class="lc-title">Execution Log</span>
            <span class="lc-live"><span class="conn-dot" style="width:5px;height:5px;box-shadow:none"></span>LIVE</span>
          </div>
          <div class="log-body" id="logBody"></div>
        </div>

      </div><!-- /results-scroll -->
    </div><!-- /results-panel -->

  </div><!-- /workspace -->
</div><!-- /app -->

<script>
// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ
let methodChart=null, timeChart=null;
const timeHistory=[22,14,31,18,40,12,27,19,35,16];
const methodCounts={find:6,aggregate:3,insert:1,update:1};
let uploadedFile=null, activeColl='employees';
let currentResultDocs=[];
const PAGE_SIZE=10;

const DEFAULT_DATA=[
  {employee_id:"E001",name:"Alice Johnson",department:"Sales",salary:82000,hire_date:"2019-03-12",status:"active",age:34},
  {employee_id:"E002",name:"Ben Torres",department:"Engineering",salary:115000,hire_date:"2018-07-22",status:"active",age:29},
  {employee_id:"E003",name:"Chloe Kim",department:"Marketing",salary:78000,hire_date:"2020-01-15",status:"active",age:31},
  {employee_id:"E004",name:"Bob Martinez",department:"Sales",salary:74500,hire_date:"2021-07-08",status:"active",age:27},
  {employee_id:"E005",name:"Diana Roy",department:"Engineering",salary:132000,hire_date:"2016-11-03",status:"active",age:38},
  {employee_id:"E006",name:"Ethan Park",department:"Finance",salary:95000,hire_date:"2019-09-18",status:"active",age:33},
  {employee_id:"E007",name:"Fiona Chen",department:"Operations",salary:67000,hire_date:"2022-03-27",status:"active",age:26},
  {employee_id:"E008",name:"George Hall",department:"Management",salary:145000,hire_date:"2014-06-11",status:"active",age:45},
  {employee_id:"E009",name:"Hannah Lee",department:"Engineering",salary:121000,hire_date:"2017-02-28",status:"on-leave",age:35},
  {employee_id:"E010",name:"Ivan Patel",department:"Sales",salary:68000,hire_date:"2023-05-09",status:"active",age:24},
  {employee_id:"E011",name:"Carol White",department:"Sales",salary:91200,hire_date:"2018-01-23",status:"active",age:36},
  {employee_id:"E012",name:"Julia Adams",department:"Marketing",salary:82500,hire_date:"2020-08-14",status:"active",age:30},
  {employee_id:"E013",name:"Kevin Brown",department:"Engineering",salary:138500,hire_date:"2015-04-17",status:"active",age:40},
  {employee_id:"E014",name:"Laura Nguyen",department:"Finance",salary:88000,hire_date:"2021-12-01",status:"active",age:28},
  {employee_id:"E015",name:"David Lee",department:"Sales",salary:68000,hire_date:"2022-11-01",status:"active",age:25},
  {employee_id:"E016",name:"Maria Lopez",department:"Operations",salary:72000,hire_date:"2019-06-30",status:"active",age:32},
  {employee_id:"E017",name:"Nathan Clark",department:"Engineering",salary:109000,hire_date:"2018-10-05",status:"active",age:37},
  {employee_id:"E018",name:"Olivia Wright",department:"Management",salary:128000,hire_date:"2016-03-22",status:"active",age:42},
  {employee_id:"E019",name:"Paul Scott",department:"Finance",salary:97500,hire_date:"2020-04-10",status:"inactive",age:44},
  {employee_id:"E020",name:"Quinn Evans",department:"Marketing",salary:76000,hire_date:"2022-07-19",status:"active",age:29},
  {employee_id:"E021",name:"Rachel Green",department:"Operations",salary:63000,hire_date:"2023-01-11",status:"active",age:23},
  {employee_id:"E022",name:"Emma Davis",department:"Sales",salary:79800,hire_date:"2020-05-17",status:"on-leave",age:31},
  {employee_id:"E023",name:"Sam Turner",department:"Engineering",salary:125000,hire_date:"2017-08-09",status:"active",age:39},
  {employee_id:"E024",name:"Tara Mitchell",department:"Finance",salary:91000,hire_date:"2019-11-14",status:"active",age:34},
  {employee_id:"E025",name:"Uma Sharma",department:"Marketing",salary:85000,hire_date:"2021-02-25",status:"active",age:28},
  {employee_id:"E031",name:"Frank Kim",department:"Sales",salary:88400,hire_date:"2017-09-30",status:"active",age:41},
  {employee_id:"E038",name:"Grace Patel",department:"Sales",salary:72100,hire_date:"2023-02-14",status:"active",age:24},
  {employee_id:"E042",name:"Hiro Tanaka",department:"Sales",salary:83600,hire_date:"2019-11-22",status:"active",age:33},
  {employee_id:"E056",name:"James Wilson",department:"Engineering",salary:127300,hire_date:"2016-07-15",status:"active",age:43},
  {employee_id:"E067",name:"Olivia Brown",department:"Operations",salary:69000,hire_date:"2021-09-28",status:"active",age:27},
  {employee_id:"E069",name:"Lisa Park",department:"Finance",salary:121000,hire_date:"2016-05-03",status:"active",age:41},
  {employee_id:"E074",name:"Liam Chen",department:"Finance",salary:84000,hire_date:"2022-04-19",status:"active",age:26},
  {employee_id:"E077",name:"Michael Scott",department:"Management",salary:145000,hire_date:"2013-09-01",status:"active",age:50},
  {employee_id:"E082",name:"Mia Turner",department:"Marketing",salary:80000,hire_date:"2022-10-05",status:"active",age:25},
  {employee_id:"E091",name:"Noah Adams",department:"Engineering",salary:98000,hire_date:"2023-08-14",status:"active",age:23},
];

const sleep=ms=>new Promise(r=>setTimeout(r,ms));

// ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ
function useChip(el){document.getElementById('queryInput').value=el.textContent;updateLiveExplain();}
function setNav(el){document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));el.classList.add('active');}
function selectColl(el,name){
  document.querySelectorAll('.coll-item').forEach(c=>c.classList.remove('active'));
  el.classList.add('active'); activeColl=name;
  document.getElementById('activeColl').textContent=name;
  document.getElementById('hdrColl').textContent=name;
}
function selectOp(el){document.querySelectorAll('.op-btn').forEach(b=>b.classList.remove('active'));el.classList.add('active');}
function clearQuery(){
  document.getElementById('queryInput').value='';
  document.getElementById('epIdle').style.display='flex';
  document.getElementById('epScroll').style.display='none';
  document.getElementById('leStepCount').textContent='0';
}
function copyQuery(){
  navigator.clipboard.writeText(document.getElementById('queryOut').innerText).catch(()=>{});
  const b=document.querySelector('.qb-copy');b.textContent='‚úì Copied';setTimeout(()=>b.textContent='üìã Copy',1500);
}
function switchTab(tab,el){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));el.classList.add('active');
  document.getElementById('tabTable').style.display=tab==='table'?'block':'none';
  document.getElementById('tabJson').style.display=tab==='json'?'block':'none';
  document.getElementById('tabSummary').style.display=tab==='summary'?'block':'none';
}
function exportResults(){
  const blob=new Blob([JSON.stringify(currentResultDocs,null,2)],{type:'application/json'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='query_results.json';a.click();
}
function addLog(type,msg){
  const lb=document.getElementById('logBody');
  const d=document.createElement('div');d.className='log-line';
  const t=new Date().toTimeString().slice(0,8);
  const cls=type==='s'?'ls':type==='w'?'lw':type==='e'?'le2':'li';
  d.innerHTML=`<span class="lt">${t}</span><span class="${cls}">[${type.toUpperCase()}]</span><span class="lm"> ${msg}</span>`;
  lb.appendChild(d);lb.scrollTop=lb.scrollHeight;
}

// ‚îÄ‚îÄ FILE UPLOAD ‚îÄ‚îÄ
function handleDragOver(e){e.preventDefault();document.getElementById('uploadZone').classList.add('drag-over');}
function handleDragLeave(){document.getElementById('uploadZone').classList.remove('drag-over');}
function handleDrop(e){e.preventDefault();document.getElementById('uploadZone').classList.remove('drag-over');const f=e.dataTransfer.files[0];if(f)processFile(f);}
function handleFileSelect(e){const f=e.target.files[0];if(f)processFile(f);}
function processFile(file){
  const ext=file.name.split('.').pop().toLowerCase();
  if(!['csv','tsv','json','xlsx','xls'].includes(ext)){alert('Unsupported format.');return;}
  const reader=new FileReader();
  reader.onload=(e)=>{
    let parsed;
    try{
      if(ext==='json')parsed=parseJSON(e.target.result);
      else if(ext==='csv'||ext==='tsv')parsed=parseCSV(e.target.result,ext==='tsv'?'\t':',');
      else parsed={headers:['[XLSX]'],rows:[],rowCount:'?',docs:[]};
    }catch(err){parsed={headers:['error'],rows:[[err.message]],rowCount:0,docs:[]};}
    const sz=file.size>1048576?(file.size/1048576).toFixed(1)+' MB':(file.size/1024).toFixed(1)+' KB';
    uploadedFile={name:file.name,size:sz,ext:ext.toUpperCase(),rows:parsed.rowCount,cols:parsed.headers.length,docs:parsed.docs};
    document.getElementById('flName').textContent=file.name;
    document.getElementById('flMeta').textContent=`${ext.toUpperCase()} ¬∑ ${parsed.rowCount} docs ¬∑ ${parsed.headers.length} fields ¬∑ ${sz}`;
    document.getElementById('fileLoaded').style.display='block';
    const cn=file.name.replace(/\.[^.]+$/,'').replace(/[^a-zA-Z0-9_]/g,'_');
    activeColl=cn;
    document.getElementById('activeColl').textContent=cn;
    document.getElementById('hdrColl').textContent=cn;
    document.getElementById('dbName').textContent='uploadedDB';
    document.getElementById('dbMeta').textContent=`1 collection ¬∑ ${parsed.rowCount} docs`;
  };
  if(ext==='xlsx'||ext==='xls')reader.readAsArrayBuffer(file);else reader.readAsText(file);
}
function parseCSV(text,delim=','){
  const lines=text.trim().split('\n').filter(l=>l.trim());
  if(!lines.length)return{headers:[],rows:[],rowCount:0,docs:[]};
  const headers=lines[0].split(delim).map(h=>h.trim().replace(/^"|"$/g,''));
  const rows=lines.slice(1).map(l=>l.split(delim).map(c=>c.trim().replace(/^"|"$/g,'')));
  const docs=rows.map(r=>{const o={};headers.forEach((h,i)=>{const v=r[i]||'';o[h]=v!==''&&!isNaN(v)?Number(v):v;});return o;});
  return{headers,rows,rowCount:rows.length,docs};
}
function parseJSON(text){
  const data=JSON.parse(text);
  const arr=Array.isArray(data)?data:(data.data||data.records||Object.values(data)[0]||[]);
  if(!arr.length)return{headers:[],rows:[],rowCount:0,docs:[]};
  const headers=Object.keys(arr[0]);
  return{headers,rows:arr.map(obj=>headers.map(h=>String(obj[h]??''))),rowCount:arr.length,docs:arr};
}
function removeFile(){
  uploadedFile=null;document.getElementById('fileLoaded').style.display='none';
  document.getElementById('fileInput').value='';activeColl='employees';
  document.getElementById('activeColl').textContent='employees';
  document.getElementById('hdrColl').textContent='employees';
  document.getElementById('dbName').textContent='myDatabase';
  document.getElementById('dbMeta').textContent='4 collections ¬∑ 6,420 docs';
}

// ‚îÄ‚îÄ TABLE ‚îÄ‚îÄ
function renderTable(docs,page=0){
  const start=page*PAGE_SIZE,end=Math.min(start+PAGE_SIZE,docs.length);
  const pageDocs=docs.slice(start,end);
  if(!pageDocs.length){
    document.getElementById('tHead').innerHTML='';
    document.getElementById('tBody').innerHTML='<tr><td style="color:var(--text3);text-align:center;padding:20px;font-family:JetBrains Mono,monospace;font-size:10px;" colspan="99">No documents matched</td></tr>';
    document.getElementById('pageInfo').textContent='0 documents';
    document.getElementById('pageBtns').innerHTML='';return;
  }
  const keys=Object.keys(pageDocs[0]);
  document.getElementById('tHead').innerHTML='<tr>'+keys.map(k=>`<th>${k}</th>`).join('')+'</tr>';
  const tbody=document.getElementById('tBody');tbody.innerHTML='';
  pageDocs.forEach(doc=>{
    const tr=document.createElement('tr');
    tr.innerHTML=keys.map(k=>{
      const v=doc[k];
      if(v===null||v===undefined)return`<td><span style="color:var(--text3)">null</span></td>`;
      if(typeof v==='object')return`<td><span style="color:var(--text3);font-size:9px">{...}</span></td>`;
      const s=String(v);
      if(s==='active')return`<td><span class="badge bg-green">active</span></td>`;
      if(s==='inactive')return`<td><span class="badge bg-red">inactive</span></td>`;
      if(s==='on-leave')return`<td><span class="badge bg-amber">on-leave</span></td>`;
      if(s==='true'||v===true)return`<td><span class="badge bg-blue">true</span></td>`;
      if(s==='false'||v===false)return`<td><span class="badge bg-red">false</span></td>`;
      return`<td>${s}</td>`;
    }).join('');
    tbody.appendChild(tr);
  });
  document.getElementById('pageInfo').textContent=`Showing ${start+1}‚Äì${end} of ${docs.length} docs`;
  const total=Math.ceil(docs.length/PAGE_SIZE);
  document.getElementById('pageBtns').innerHTML=Array.from({length:total},(_,i)=>
    `<button class="page-btn${i===page?' active':''}" onclick="renderTable(currentResultDocs,${i})">${i+1}</button>`).join('');
}

// ‚îÄ‚îÄ JSON ‚îÄ‚îÄ
function renderJSON(docs){
  const str=JSON.stringify(docs.slice(0,30),null,2);
  document.getElementById('jsonView').innerHTML=str
    .replace(/("[\w$_][\w\d$_]*")\s*:/g,'<span class="jk">$1</span>:')
    .replace(/:\s*("(?:[^"\\]|\\.)*")/g,(m,s)=>`: <span class="jstr">${s}</span>`)
    .replace(/:\s*(-?\d+\.?\d*)/g,(m,n)=>`: <span class="jnum">${n}</span>`)
    .replace(/:\s*(true|false)/g,(m,b)=>`: <span class="jbool">${b}</span>`)
    .replace(/:\s*(null)/g,`: <span class="jnull">null</span>`)
    .replace(/([{}\[\]])/g,'<span class="jbr">$1</span>');
}

// ‚îÄ‚îÄ LOCAL ENGINE ‚îÄ‚îÄ
function localExecute(query,data,coll){
  const q=query.toLowerCase();let results=[...data];
  const depts=['sales','engineering','finance','marketing','operations','management'];
  for(const d of depts){if(q.includes(d)){results=results.filter(r=>(r.department||'').toLowerCase()===d);break;}}
  if(q.includes('active')&&!q.includes('inactive'))results=results.filter(r=>r.status==='active');
  if(q.includes('inactive'))results=results.filter(r=>r.status==='inactive');
  if(q.includes('on-leave')||q.includes('leave'))results=results.filter(r=>r.status==='on-leave');
  const yr=q.match(/after (\d{4})/);if(yr)results=results.filter(r=>(r.hire_date||'')>yr[1]);
  const salOver=q.match(/salary\s*(?:over|above|greater|>)\s*(\d+)/);if(salOver)results=results.filter(r=>(r.salary||0)>parseInt(salOver[1]));
  const salUnder=q.match(/salary\s*(?:under|below|less|<)\s*(\d+)/);if(salUnder)results=results.filter(r=>(r.salary||0)<parseInt(salUnder[1]));
  if(q.includes('highest')||q.includes('top paid'))results.sort((a,b)=>(b.salary||0)-(a.salary||0));
  if(q.includes('lowest paid'))results.sort((a,b)=>(a.salary||0)-(b.salary||0));
  const topM=q.match(/top\s+(\d+)/);if(topM)results=results.slice(0,parseInt(topM[1]));
  let method='find()';
  if(q.includes('count by')||q.includes('group by')){
    const g={};data.forEach(d=>{const k=d.department||'Unknown';g[k]=(g[k]||0)+1;});
    results=Object.entries(g).map(([_id,count])=>({_id,count})).sort((a,b)=>b.count-a.count);method='aggregate()';
  }
  if(q.includes('average salary')||q.includes('avg salary')){
    const g={},ct={};
    data.forEach(d=>{const k=d.department||'Unknown';g[k]=(g[k]||0)+(d.salary||0);ct[k]=(ct[k]||0)+1;});
    results=Object.entries(g).map(([_id,t])=>({_id,avg_salary:Math.round(t/ct[_id]),count:ct[_id]})).sort((a,b)=>b.avg_salary-a.avg_salary);method='aggregate()';
  }
  const dept=depts.find(d=>q.includes(d));
  const mqf=dept?`department:"${dept.charAt(0).toUpperCase()+dept.slice(1)}"`:salOver?`salary:{$gt:${salOver[1]}}`:'{}';
  const mq=method.startsWith('agg')
    ?`db.${coll}.aggregate([\n  { $group: { _id: "$department", count: { $sum: 1 } } },\n  { $sort: { count: -1 } }\n])`
    :`db.${coll}.find({ ${mqf} })${q.includes('highest')?'.sort({ salary: -1 })':''}`;
  return{mongo_query:mq,method,index:results.length<data.length?'IXSCAN':'COLLSCAN',confidence:88,
    query_plan:`${method.startsWith('agg')?'Group + Sort':'Filter + Fetch'} ‚Üí ${results.length} docs`,results,
    explanation:`This query filters the <code>${coll}</code> collection${dept?` for <strong>${dept.charAt(0).toUpperCase()+dept.slice(1)}</strong> employees`:''}${salOver?` with salary <strong>over $${parseInt(salOver[1]).toLocaleString()}</strong>`:''}${yr?` hired <strong>after ${yr[1]}</strong>`:''}.${results.length&&results[0]?.salary?` Salary range: <strong>$${Math.min(...results.filter(r=>r.salary).map(r=>r.salary)).toLocaleString()} ‚Äì $${Math.max(...results.filter(r=>r.salary).map(r=>r.salary)).toLocaleString()}</strong>.`:''}`,
    summary:`Found <strong>${results.length}</strong> document${results.length!==1?'s':''} from <code>${coll}</code> (${data.length} total).`};
}

// ‚îÄ‚îÄ RUN QUERY ‚îÄ‚îÄ
async function runQuery(){
  const raw=document.getElementById('queryInput').value.trim();
  if(!raw)return;
  document.getElementById('loadingStrip').style.display='flex';
  for(let i=1;i<=6;i++){const p=document.getElementById('ps'+i);p.className='ps';p.querySelector('.psi').textContent='‚óã';}
  const steps=["Tokenizing...","Detecting intent...","Mapping schema...","Generating query...","Optimizing...","Executing..."];
  for(let i=0;i<steps.length;i++){
    document.getElementById('loadingMsg').textContent=steps[i];
    const p=document.getElementById('ps'+(i+1));p.className='ps active';p.querySelector('.psi').textContent='‚ü≥';
    await sleep(160);p.className='ps done';p.querySelector('.psi').textContent='‚úì';
  }
  document.getElementById('loadingStrip').style.display='none';
  document.getElementById('logBody').innerHTML='';
  addLog('i',`Query: "${raw.slice(0,55)}"`);
  addLog('i',`Collection: ${activeColl}`);
  addLog('i','Executing...');
  const dataset=uploadedFile?uploadedFile.docs:DEFAULT_DATA;
  const t0=Date.now();let aiResult=null;
  try{
    const resp=await fetch("https://api.anthropic.com/v1/messages",{
      method:"POST",headers:{"Content-Type":"application/json"},
      body:JSON.stringify({
        model:"claude-sonnet-4-20250514",max_tokens:2500,
        system:`You are a MongoDB query execution engine. Respond ONLY with valid JSON (no markdown):
{"mongo_query":"...","method":"find() or aggregate()","index":"IXSCAN or COLLSCAN","confidence":95,"query_plan":"short desc","results":[...actual docs...],"explanation":"HTML with <strong> <code>","summary":"plain text"}`,
        messages:[{role:"user",content:`Query: "${raw}"\nCollection: ${activeColl}\nData (${dataset.length} docs):\n${JSON.stringify(dataset.slice(0,120))}`}]
      })
    });
    const d=await resp.json();
    const txt=d.content?.map(c=>c.text||'').join('')||'';
    aiResult=JSON.parse(txt.replace(/```json|```/g,'').trim());
    document.getElementById('resultBadge').textContent='AI Executed';
    addLog('s',`Engine returned ${aiResult.results?.length||0} documents`);
  }catch(err){
    addLog('w',`Local engine (${err.message.slice(0,35)})`);
    aiResult=localExecute(raw,dataset,activeColl);
    document.getElementById('resultBadge').textContent='Local Engine';
    addLog('s',`${aiResult.results.length} documents`);
  }
  const execMs=Date.now()-t0;
  currentResultDocs=aiResult.results||[];
  const numFields=currentResultDocs.length>0?Object.keys(currentResultDocs[0]).length:0;
  const conf=aiResult.confidence||88;
  document.getElementById('statDocs').textContent=currentResultDocs.length;
  document.getElementById('statFields').textContent=numFields;
  document.getElementById('statTime').textContent=execMs+'ms';
  document.getElementById('statIdx').textContent=aiResult.index||'COLL';
  document.getElementById('metaConf').textContent=conf+'%';
  document.getElementById('confBar').style.width=conf+'%';
  document.getElementById('confBar').style.background=conf>=90?'linear-gradient(90deg,#00c060,#00f580)':conf>=70?'linear-gradient(90deg,#ffb340,#ffcc70)':'linear-gradient(90deg,#ff4f4f,#ff8080)';
  document.getElementById('metaConf').style.color=conf>=90?'var(--green)':conf>=70?'var(--amber)':'var(--red)';
  document.getElementById('metaPlan').textContent=aiResult.query_plan||'Filter + Fetch';
  document.getElementById('metaPlanSub').textContent=(aiResult.method||'find()')+' ¬∑ '+dataset.length+' docs';
  document.getElementById('metaColl').textContent=activeColl;
  document.getElementById('metaCollSub').textContent=dataset.length+' total docs';
  document.getElementById('qbMethod').textContent=aiResult.method||'find()';
  document.getElementById('qbOp').textContent=(aiResult.mongo_query||'').slice(0,55);
  document.getElementById('queryOut').textContent=aiResult.mongo_query||'';
  document.getElementById('explainText').innerHTML=aiResult.explanation||`Query executed on <code>${activeColl}</code>.`;
  renderTable(currentResultDocs,0);renderJSON(currentResultDocs);
  const salaries=currentResultDocs.filter(d=>d.salary).map(d=>d.salary);
  const avgSal=salaries.length?Math.round(salaries.reduce((a,b)=>a+b,0)/salaries.length):null;
  const summaryText=aiResult.summary||`Found ${currentResultDocs.length} documents.`;
  document.getElementById('summaryView').innerHTML=`
    <div style="display:flex;gap:10px;align-items:flex-start;margin-bottom:12px">
      <span style="font-size:20px;flex-shrink:0">‚ú¶</span>
      <div>
        <div style="font-size:8px;font-weight:700;color:var(--green);font-family:'JetBrains Mono',monospace;letter-spacing:2px;margin-bottom:5px">RESULT SUMMARY</div>
        <div style="font-size:11px;color:var(--text2);line-height:1.8">${summaryText.replace(/\*\*(.*?)\*\*/g,'<strong style="color:var(--green)">$1</strong>').replace(/\`(.*?)\`/g,'<code style="background:rgba(0,245,128,0.08);color:var(--green);padding:1px 4px;border-radius:3px;font-family:JetBrains Mono,monospace;font-size:9px">$1</code>')}</div>
      </div>
    </div>
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px">
      <div style="background:rgba(0,245,128,0.05);border:1px solid rgba(0,245,128,0.12);border-radius:7px;padding:10px">
        <div style="font-size:8px;color:var(--text3);font-weight:700;letter-spacing:1.5px;margin-bottom:3px">DOCS</div>
        <div style="font-size:22px;font-weight:800;color:var(--green)">${currentResultDocs.length}</div>
        <div style="font-size:9px;color:var(--text3);font-family:'JetBrains Mono',monospace">of ${dataset.length} total</div>
      </div>
      <div style="background:rgba(77,184,255,0.05);border:1px solid rgba(77,184,255,0.12);border-radius:7px;padding:10px">
        <div style="font-size:8px;color:var(--text3);font-weight:700;letter-spacing:1.5px;margin-bottom:3px">FIELDS</div>
        <div style="font-size:22px;font-weight:800;color:var(--blue)">${numFields}</div>
        <div style="font-size:9px;color:var(--text3);font-family:'JetBrains Mono',monospace">per document</div>
      </div>
      <div style="background:rgba(255,179,64,0.05);border:1px solid rgba(255,179,64,0.12);border-radius:7px;padding:10px">
        <div style="font-size:8px;color:var(--text3);font-weight:700;letter-spacing:1.5px;margin-bottom:3px">${avgSal?'AVG SALARY':'EXEC TIME'}</div>
        <div style="font-size:22px;font-weight:800;color:var(--amber)">${avgSal?'$'+avgSal.toLocaleString():execMs+'ms'}</div>
        <div style="font-size:9px;color:var(--text3);font-family:'JetBrains Mono',monospace">${avgSal?'across results':'runtime'}</div>
      </div>
    </div>`;
  if((aiResult.method||'').startsWith('agg'))methodCounts.aggregate++;else methodCounts.find++;
  timeHistory.push(execMs);timeHistory.shift();
  buildCharts();
  addLog('s',`Done ‚Äî ${currentResultDocs.length} docs ¬∑ ${execMs}ms ¬∑ conf ${conf}%`);
  document.getElementById('resultsScroll').scrollTop=0;
}

// ‚îÄ‚îÄ CHARTS ‚îÄ‚îÄ
function buildCharts(){
  Chart.defaults.color='#4d6070';
  Chart.defaults.font.family="'JetBrains Mono',monospace";
  Chart.defaults.font.size=9;
  if(methodChart)methodChart.destroy();
  if(timeChart)timeChart.destroy();
  const gc='rgba(30,42,54,0.8)';
  methodChart=new Chart(document.getElementById('methodChart'),{
    type:'doughnut',
    data:{labels:['find()','aggregate()','insert()','update()'],
      datasets:[{data:[methodCounts.find,methodCounts.aggregate,methodCounts.insert,methodCounts.update],
        backgroundColor:['rgba(0,245,128,0.65)','rgba(77,184,255,0.65)','rgba(255,179,64,0.65)','rgba(180,142,255,0.65)'],
        borderColor:['#00f580','#4db8ff','#ffb340','#b48eff'],borderWidth:1}]},
    options:{responsive:true,maintainAspectRatio:false,
      plugins:{legend:{position:'right',labels:{boxWidth:9,padding:10,color:'#8fa3b5'}}},cutout:'65%'}
  });
  timeChart=new Chart(document.getElementById('timeChart'),{
    type:'line',
    data:{labels:timeHistory.map((_,i)=>'Q'+(i+1)),
      datasets:[{data:timeHistory,borderColor:'#00f580',backgroundColor:'rgba(0,245,128,0.06)',
        fill:true,tension:0.4,pointBackgroundColor:'#00f580',pointRadius:3,borderWidth:2}]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},
      scales:{y:{grid:{color:gc},ticks:{callback:v=>v+'ms',color:'#4d6070'}},
              x:{grid:{display:false},ticks:{color:'#4d6070'}}}}
  });
}

// ‚îÄ‚îÄ LIVE STEP-BY-STEP EXPLAIN ‚îÄ‚îÄ
document.getElementById('queryInput').addEventListener('keydown',e=>{if(e.key==='Enter')runQuery();});
document.getElementById('queryInput').addEventListener('input',updateLiveExplain);

function updateLiveExplain(){
  const raw=document.getElementById('queryInput').value.trim();
  if(!raw){
    document.getElementById('epIdle').style.display='flex';
    document.getElementById('epScroll').style.display='none';
    document.getElementById('leStepCount').textContent='0';
    return;
  }
  document.getElementById('epIdle').style.display='none';
  document.getElementById('epScroll').style.display='block';

  const q=raw.toLowerCase();
  const coll=activeColl||'employees';
  const collLabel=coll.charAt(0).toUpperCase()+coll.slice(1);

  const depts=['sales','engineering','finance','marketing','operations','management'];
  const dept=depts.find(d=>q.includes(d));
  const dL=dept?dept.charAt(0).toUpperCase()+dept.slice(1):null;
  const salOver =q.match(/(?:salary|earn|paid|making).*?(?:over|above|greater than|more than|>)\s*\$?([\d,]+)/);
  const salUnder=q.match(/(?:salary|earn|paid|making).*?(?:under|below|less than|<)\s*\$?([\d,]+)/);
  const salBetween=q.match(/(?:between|from)\s*\$?([\d,]+)\s*(?:and|to|-)\s*\$?([\d,]+)/);
  const topN=q.match(/top\s+(\d+)/i);
  const afterYear =q.match(/after\s+(20\d{2}|19\d{2})/);
  const beforeYear=q.match(/before\s+(20\d{2}|19\d{2})/);
  const inYear    =q.match(/in\s+(20\d{2}|19\d{2})/);
  const isCount =q.includes('count')||q.includes('how many');
  const isAvg   =q.includes('average')||q.includes('avg')||q.includes('mean');
  const isGroup =q.includes('group')||q.includes('per dept')||q.includes('by department')||q.includes('by dept')||((isAvg||isCount)&&(q.includes('dept')||q.includes('department')));
  const isActive  =q.includes('active')&&!q.includes('inactive');
  const isInactive=q.includes('inactive');
  const isOnLeave =q.includes('on-leave')||q.includes('on leave')||q.includes('leave');
  const sortHigh  =q.includes('highest')||q.includes('most paid')||(q.includes('top')&&(q.includes('paid')||q.includes('salary')));
  const sortLow   =q.includes('lowest')||q.includes('least paid');
  const sortNew   =q.includes('newest')||q.includes('recently hired')||q.includes('latest');
  const sortOld   =q.includes('oldest')||q.includes('longest serving');
  const nameMatch =q.match(/(?:named?|called)\s+([a-z]+)/);
  const hasFilter =!!(dept||salOver||salUnder||salBetween||afterYear||beforeYear||inYear||isActive||isInactive||isOnLeave||nameMatch);
  const hasSort   =!!(sortHigh||sortLow||sortNew||sortOld);
  const hasLimit  =!!topN;
  const isAgg     =isGroup||isAvg||(isCount&&isGroup);
  const isAllDocs =!hasFilter&&!isAgg&&!isCount;

  // big sentence
  let big=[];
  if(isAgg&&isAvg&&isGroup)       big.push(`Calculate the <mark>average salary</mark> grouped by <span class="hlb">each department</span>`);
  else if(isAgg&&isCount&&isGroup) big.push(`Count <mark>how many people</mark> are in <span class="hlb">each department</span>`);
  else if(isCount)                big.push(`Count the <mark>total number of people</mark>`);
  else if(topN)                   big.push(`Show only the <mark>top ${topN[1]} people</mark>`);
  else if(isAllDocs)              big.push(`Show <mark>everyone</mark> in the <span class="hlb">${collLabel}</span> list`);
  else                            big.push(`Find <mark>specific people</mark> from <span class="hlb">${collLabel}</span>`);
  const fp=[];
  if(dL)          fp.push(`who work in <mark>${dL}</mark>`);
  if(salBetween)  fp.push(`earning between <span class="hla">$${parseInt(salBetween[1].replace(/,/g,'')).toLocaleString()}</span> and <span class="hla">$${parseInt(salBetween[2].replace(/,/g,'')).toLocaleString()}</span>`);
  else if(salOver) fp.push(`earning more than <span class="hla">$${parseInt(salOver[1].replace(/,/g,'')).toLocaleString()}</span>`);
  else if(salUnder)fp.push(`earning less than <span class="hla">$${parseInt(salUnder[1].replace(/,/g,'')).toLocaleString()}</span>`);
  if(afterYear)   fp.push(`joined after <span class="hla">${afterYear[1]}</span>`);
  if(beforeYear)  fp.push(`joined before <span class="hla">${beforeYear[1]}</span>`);
  if(inYear)      fp.push(`joined in <span class="hla">${inYear[1]}</span>`);
  if(isActive)    fp.push(`who are currently <mark>active</mark>`);
  if(isInactive)  fp.push(`who are <span class="hlr">no longer active</span>`);
  if(isOnLeave)   fp.push(`who are <span class="hla">on leave</span>`);
  if(nameMatch)   fp.push(`named <mark>${nameMatch[1].charAt(0).toUpperCase()+nameMatch[1].slice(1)}</mark>`);
  if(fp.length) big.push(' '+fp.join(', '));
  if(sortHigh) big.push(', <span class="hla">highest salary first</span>');
  if(sortLow)  big.push(', <span class="hla">lowest salary first</span>');
  if(sortNew)  big.push(', <span class="hla">most recent hire first</span>');
  if(sortOld)  big.push(', <span class="hla">longest serving first</span>');
  if(topN)     big.push(`, then <span class="hlp">keep only top ${topN[1]}</span>`);
  big.push('.');
  document.getElementById('leBigSentence').innerHTML=big.join('');

  // steps
  const steps=[];
  // 1 ‚Äî open table
  steps.push({n:'1',c:'ng',icon:'üóÑÔ∏è',
    label:'Open the data table',
    desc:`The system opens the <mark>${collLabel}</mark> table ‚Äî like opening a spreadsheet. All records sit here in rows, and the system reads through every one to find what you need.`,
    tags:[`<span class="le-tag tg">üìÅ ${collLabel}</span>`,`<span class="le-tag">35 records</span>`]
  });
  // 2 ‚Äî filter or no filter
  if(hasFilter){
    const fd=[];
    if(dL)          fd.push(`‚ë† Keep rows where <strong>Department</strong> = <mark>${dL}</mark>`);
    if(salBetween)  fd.push(`‚ë° Keep rows where <strong>Salary</strong> is between <span class="ha">$${parseInt(salBetween[1].replace(/,/g,'')).toLocaleString()}</span> and <span class="ha">$${parseInt(salBetween[2].replace(/,/g,'')).toLocaleString()}</span>`);
    else if(salOver) fd.push(`‚ë° Keep rows where <strong>Salary</strong> &gt; <span class="ha">$${parseInt(salOver[1].replace(/,/g,'')).toLocaleString()}</span>`);
    else if(salUnder)fd.push(`‚ë° Keep rows where <strong>Salary</strong> &lt; <span class="ha">$${parseInt(salUnder[1].replace(/,/g,'')).toLocaleString()}</span>`);
    if(afterYear)   fd.push(`‚ë¢ Keep rows where <strong>Hire Date</strong> is after <span class="ha">${afterYear[1]}</span>`);
    if(beforeYear)  fd.push(`‚ë¢ Keep rows where <strong>Hire Date</strong> is before <span class="ha">${beforeYear[1]}</span>`);
    if(inYear)      fd.push(`‚ë¢ Keep rows where <strong>Hire Date</strong> is in <span class="ha">${inYear[1]}</span>`);
    if(isActive)    fd.push(`‚ë£ Keep rows where <strong>Status</strong> = <mark>Active</mark> (currently working)`);
    if(isInactive)  fd.push(`‚ë£ Keep rows where <strong>Status</strong> = <span class="hr">Inactive</span>`);
    if(isOnLeave)   fd.push(`‚ë£ Keep rows where <strong>Status</strong> = <span class="ha">On Leave</span>`);
    if(nameMatch)   fd.push(`‚ë§ Keep rows where <strong>Name</strong> matches <mark>${nameMatch[1].charAt(0).toUpperCase()+nameMatch[1].slice(1)}</mark>`);
    steps.push({n:'2',c:'nb',icon:'üîΩ',
      label:`Apply ${fd.length} filter${fd.length>1?'s':''} ‚Äî narrow the list`,
      desc:`Like Excel's filter button ‚Äî the system scans every row and removes ones that don't match your conditions. Only rows passing all conditions move forward.<br><br>`+fd.map(d=>`<span style="display:block;margin-bottom:4px">${d}</span>`).join(''),
      tags:[`<span class="le-tag tb">üîç ${fd.length} condition${fd.length>1?'s':''}</span>`,`<span class="le-tag">Non-matches removed</span>`]
    });
  }else if(!isAgg){
    steps.push({n:'2',c:'ng',icon:'‚úÖ',
      label:'No filter ‚Äî include all records',
      desc:`No conditions set, so every single record passes through. Nothing is filtered out at this step.`,
      tags:[`<span class="le-tag tg">üìã All records included</span>`]
    });
  }
  // 3 ‚Äî aggregation
  if(isAgg){
    let desc='';
    if(isAvg&&isGroup)        desc=`The system groups all rows by <mark>Department</mark>. For each group, it adds up all salaries and divides by headcount ‚Äî like averaging in a calculator. Returns one result row per department.`;
    else if(isCount&&isGroup) desc=`The system groups all rows by <mark>Department</mark> and counts how many people are in each group. Result looks like: "Sales: 8 people, Engineering: 6 people".`;
    else                      desc=`The system groups and calculates a summary result from the matching data.`;
    steps.push({n:hasFilter?'3':'2',c:'np',icon:'üìä',
      label:'Group & calculate',
      desc,
      tags:[
        isAvg&&isGroup?`<span class="le-tag tp">‚àë Avg = Sum √∑ Count</span>`:'',
        isCount&&isGroup?`<span class="le-tag tp">üì¶ Group by Department</span>`:'',
        `<span class="le-tag">One row per group</span>`
      ].filter(Boolean)
    });
  }
  // sort
  const snBase=hasFilter?(isAgg?4:3):(isAgg?3:2);
  if(hasSort){
    let sd='',stags=[];
    if(sortHigh){sd=`Re-arrange results so the person with the <mark>highest salary</mark> appears first ‚Äî like sorting a spreadsheet column Z ‚Üí A.`;stags=[`<span class="le-tag ta">‚Üì Salary: High ‚Üí Low</span>`];}
    if(sortLow) {sd=`Re-arrange results so the person with the <mark>lowest salary</mark> appears first ‚Äî like sorting A ‚Üí Z.`;stags=[`<span class="le-tag ta">‚Üë Salary: Low ‚Üí High</span>`];}
    if(sortNew) {sd=`Sort by <mark>hire date</mark>, most recently joined person first.`;stags=[`<span class="le-tag ta">‚Üì Date: Newest first</span>`];}
    if(sortOld) {sd=`Sort by <mark>hire date</mark>, earliest joined person first.`;stags=[`<span class="le-tag ta">‚Üë Date: Oldest first</span>`];}
    steps.push({n:String(snBase),c:'na',icon:'‚ÜïÔ∏è',label:'Sort results into order',desc:sd,tags:stags});
  }
  // limit
  const snLimit=snBase+(hasSort?1:0);
  if(hasLimit){
    steps.push({n:String(snLimit),c:'np',icon:'‚úÇÔ∏è',
      label:`Keep only the top ${topN[1]}`,
      desc:`After sorting, the system keeps only the first <mark>${topN[1]} rows</mark> and discards the rest ‚Äî like saying "show me just the top ${topN[1]}".`,
      tags:[`<span class="le-tag tp">üî¢ Limit: ${topN[1]} rows</span>`,`<span class="le-tag">Rest discarded</span>`]
    });
  }
  // final ‚Äî return
  steps.push({n:String(steps.length+1),c:'ng',icon:'üì¨',
    label:'Return results to you',
    desc:`All matching, calculated, and sorted rows are collected and sent back. They appear in the <mark>Table</mark> and <mark>JSON</mark> tabs on the right ‚Äî ready to read, export, or share.`,
    tags:[`<span class="le-tag tg">‚úì Results ready</span>`,`<span class="le-tag">Table ¬∑ JSON ¬∑ Summary</span>`]
  });

  document.getElementById('leStepCount').textContent=steps.length;
  document.getElementById('leSteps').innerHTML=steps.map(s=>`
    <div class="le-step">
      <div class="le-step-left">
        <div class="le-step-num ${s.c}">${s.n}</div>
        <div class="le-step-line"></div>
      </div>
      <div class="le-step-right">
        <div class="le-step-row">
          <span class="le-step-icon">${s.icon}</span>
          <span class="le-step-label">${s.label}</span>
        </div>
        <div class="le-step-desc">${s.desc}</div>
        <div style="margin-top:5px;display:flex;flex-wrap:wrap;gap:4px">${s.tags.join('')}</div>
      </div>
    </div>`).join('');
}

// ‚îÄ‚îÄ INIT: pre-populate with default data ‚îÄ‚îÄ
(function init(){
  currentResultDocs=DEFAULT_DATA;
  renderTable(DEFAULT_DATA,0);
  renderJSON(DEFAULT_DATA);
  for(let i=1;i<=6;i++){const p=document.getElementById('ps'+i);p.className='ps done';p.querySelector('.psi').textContent='‚úì';}
  buildCharts();
  const salaries=DEFAULT_DATA.map(d=>d.salary);
  const avgSal=Math.round(salaries.reduce((a,b)=>a+b,0)/salaries.length);
  document.getElementById('summaryView').innerHTML=`
    <div style="display:flex;gap:10px;align-items:flex-start;margin-bottom:12px">
      <span style="font-size:20px;flex-shrink:0">‚ú¶</span>
      <div>
        <div style="font-size:8px;font-weight:700;color:var(--green);font-family:'JetBrains Mono',monospace;letter-spacing:2px;margin-bottom:5px">DEFAULT DATASET LOADED</div>
        <div style="font-size:11px;color:var(--text2);line-height:1.8">Showing all <strong style="color:var(--green)">${DEFAULT_DATA.length}</strong> employees. Type a query above to filter and explore.</div>
      </div>
    </div>
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px">
      <div style="background:rgba(0,245,128,0.05);border:1px solid rgba(0,245,128,0.12);border-radius:7px;padding:10px">
        <div style="font-size:8px;color:var(--text3);font-weight:700;letter-spacing:1.5px;margin-bottom:3px">TOTAL DOCS</div>
        <div style="font-size:22px;font-weight:800;color:var(--green)">${DEFAULT_DATA.length}</div>
        <div style="font-size:9px;color:var(--text3);font-family:'JetBrains Mono',monospace">employees</div>
      </div>
      <div style="background:rgba(77,184,255,0.05);border:1px solid rgba(77,184,255,0.12);border-radius:7px;padding:10px">
        <div style="font-size:8px;color:var(--text3);font-weight:700;letter-spacing:1.5px;margin-bottom:3px">FIELDS</div>
        <div style="font-size:22px;font-weight:800;color:var(--blue)">${Object.keys(DEFAULT_DATA[0]).length}</div>
        <div style="font-size:9px;color:var(--text3);font-family:'JetBrains Mono',monospace">per document</div>
      </div>
      <div style="background:rgba(255,179,64,0.05);border:1px solid rgba(255,179,64,0.12);border-radius:7px;padding:10px">
        <div style="font-size:8px;color:var(--text3);font-weight:700;letter-spacing:1.5px;margin-bottom:3px">AVG SALARY</div>
        <div style="font-size:22px;font-weight:800;color:var(--amber)">$${avgSal.toLocaleString()}</div>
        <div style="font-size:9px;color:var(--text3);font-family:'JetBrains Mono',monospace">across all</div>
      </div>
    </div>`;
})();
</script>
</body>
</html>
